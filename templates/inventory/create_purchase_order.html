{% extends "base.html" %}
{% load static%}
{% load crispy_forms_tags %}
{% block title%} Create Purchase Order {% endblock%}
{% block content %}
<style>
  .po-input{
    border: none !important;
  }
    td, input {
        font-size: 12px;
        vertical-align: middle;
        text-align: center;
    }

    td:first-child,
    td:nth-child(2){
        text-align: left; 
    }

    input {
        height: 30px;
        font-size: 12px;
        vertical-align: middle;
        text-align: center;
    }
</style>
<div class="inventory">
    <div class='add-purchase-order'>
        <div class='purchase-order-nav shadow p-2 text-light d-flex justify-content-between align-items-center rounded' style="background:#373f4c !important;">
            <div>
                <h5 class='fw-bold px-2 mt-2'>Create Purchase order</h5>
            </div>
        </div>
        <div class="row mt-2 main" id="main-section">
            <div class="col-9">
                <div class="d-flex flex-column">
                    <p id="cart-title">Purchase order Items</p>
                    <table class="table border rounder p-2" id="cart-table">
                        <thead>
                        <th>Action</th>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th class="text-center">Total</th>
                        </thead>
                        <tbody id="cart-items"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"></td>
                                <td class="fw-bold">Subtotal</td>
                                <td class="text-center fw-bold" id="subtotal"></td>
                            </tr>
                            <tr>
                                <td colspan="3"></td>
                                <td class="fw-bold">Discount</td>
                                <td>
                                    <input id="id_discount" class="form-control text-center fw-bold" oninput="calculateTotals()">
                                </td>
                            </tr>
                            <tr>
                                <td colspan="3"></td>
                                <td class="fw-bold">Tax Rate</td>
                                <td id="tax_rate" class="fw-bold text-center">15%</td>
                            </tr>
                            <tr>
                                <td colspan="3"></td>
                                <td class="fw-bold">Tax Total</td>
                                <td id="tax" class="fw-bold text-center"></td>
                            </tr>
                            <tr>
                                <td colspan="3"></td>
                                <td class="fw-bold">Expenses</td>
                                <td>
                                    <input id="id_other" class="form-control text-center fw-bold" oninput="calculateTotals()" readonly>
                                </td>
                            </tr>
                            <!-- Add dynamic rows for other expenses here -->
                            <tr id="other-expense-row">
                                <td colspan="4"></td>
                                <td>
                                    <button class="btn btn-outline-dark btn-sm w-100" id="add-expense-btn" onclick="addExpense()">Add Expense</button>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="3"></td>
                                <td class="fw-bold">Total</td>
                                <td class="fw-bold text-center" id="id_total"></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div class="d-flex justify-content-end">
                      <button class="btn btn-outline-dark btn-sm flex mx-2" onclick="reload();">Cancel</button>
                      <button class="btn btn-dark btn-sm flex" id="next_button">Next</button>
                    </div>                        
                </div>
            </div>
            <div class="col-3">
                <div class=''>
                  <p id="cart-title">Add Product</p>
                    <form class='d-flex flex-column mt-2 w-100 mt-2 w-100 px-2' method='post'>
                        {% csrf_token %}
                        <div class="mb-1">
                            <label for="id_product" class="form-label requiredField">
                                Product
                            </label> 
                            <div class="d-flex form-group">
                                <select class="select form-select" id='id_product'>
                                    <option value="">-----</option>
                                    {% for product in inventory %}
                                        <option value={{product.product.name}}>{{product.product.name}} [{{ product.quantity }}]</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn bx bx-plus border" id="id_add_supplier"></button>
                            </div>
                        </div>
                        <div class="mb-1">
                            <label for="id_product" class="form-label requiredField">
                                Supplier
                            </label>
                            <div class="d-flex form-group">
                                <select class="select form-select" id='id_supplier'>
                                    <option value="">-----</option>
                                    {% for supplier in suppliers %}
                                        <option value={{supplier.id}}>{{supplier.name}}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn border bx bx-plus" id="id_add_product"></button>
                            </div>
                        </div>
                        <div id="div_id_price" class="mb-1">
                            <label for="unit_price" class="form-label requiredField">
                                Unit price
                            </label> 
                            <input  
                                type="number" 
                                name="price" step="0.01" 
                                class="numberinput form-control" 
                                required 
                                id="id_p_price"
                            >
                            <p id="price_error" class="fs-6 text-danger"></p>
                        </div> 
                        <div id="div_id_quantity" class="mb-1"> 
                            <label for="id_p_quantity" class="form-label requiredField">
                                Quantity
                            </label> 
                            <input 
                                type="number" 
                                name="quantity"
                                value="" 
                                min="0" 
                                class="numberinput form-control" 
                                required id="id_p_quantity"
                            > 
                            <p id="quantity_error" class="fs-6 text-danger"></p>
                            <p id="cart_error" class="text-danger"></p>
                        </div> 
                        <div class='d-flex justify-content-end mb-2'>
                            <button type='button' class='btn btn-dark btn-sm w-100' id="id_add_to_cart" onclick="addItem();">
                              <i class='bx bx-save' ></i>
                                save
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <h5 class="fw-bold">Add Supplier</h5>
                    <form method="post">
                        {% csrf_token %}
                        <div id="div_id_name" class="mb-3"> <label for="id_name" class="form-label requiredField">
                        Name<span class="asteriskField">*</span> </label> <input type="text" name="name" maxlength="255" class="textinput form-control" required="" id="id_sup_name"> </div> <div id="div_id_contact" class="mb-3"> <label for="id_contact" class="form-label requiredField">
                        Contact Name<span class="asteriskField">*</span> </label> <input type="text" name="contact" maxlength="255" class="textinput form-control" required="" id="id_contact_name"> </div> <div id="div_id_email" class="mb-3"> <label for="id_email" class="form-label requiredField">
                        Email<span class="asteriskField">*</span> </label> <input type="email" name="email" maxlength="254" class="emailinput form-control" required="" id="id_email"> </div> <div id="div_id_phone" class="mb-3"> <label for="id_phone" class="form-label requiredField">
                        Phone<span class="asteriskField">*</span> </label> <input type="text" name="phone" maxlength="20" class="textinput form-control" required="" id="id_phone"> </div> <div id="div_id_address" class="mb-3"> <label for="id_address" class="form-label requiredField">
                        Address<span class="asteriskField">*</span> </label> <textarea name="address" cols="40" rows="10" class="textarea form-control" required="" id="id_address"></textarea> </div>
                        
                        <p class="text-danger" id="sup_error"></p>
                        <div class="d-flex justify-content-end">
                            <div class="">
                                <button type="reset" class="btn btn-danger btn-sm w-100">
                                    <i class="bx bx-reset"></i>
                                    Reset
                                </button>
                            </div>
                            <span class="px-1"></span>
                            <div class="">
                                <button type="button" id="id_submit_supplier" class="btn btn-secondary btn-sm w-100">
                                    <i class="bx bx-save"></i>
                                    Save
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-body">
                <div class="category">
                  <div class='add-product-category' id="id_category_form">
                      <div class='add-product-category-nav d-flex mt-2 py-3 px-2 align-items-center'>
                          <div>
                              <h6 class='mt-2 fw-bold'>Add Category</h6>
                          </div>
                      </div>
                      <form method='post' class='px-2'>
                          {% csrf_token %}
                          <div class='mb-2'>
                              <label for='id_name'>Category Name</label>
                              <input 
                                  name='name' 
                                  id='id_category_name' 
                                  type='text' 
                                  class='form-control'
                              />
                          </div>
                          <small id='id_error'></small>
                          <div class="d-flex justify-content-end">
                              <div class="">
                                  <button type="reset" class="btn btn-danger btn-sm w-100">
                                      <i class='bx bx-reset'></i>
                                      reset
                                  </button>
                              </div>
                              <span class="px-1"></span>
                              <div class="">
                                  <button type="button" onclick="categorySubmit();" class="btn btn-secondary btn-sm w-100">
                                      <i class='bx bx-save'></i>
                                      save
                                  </button>
                              </div>
                          </div>
                      </form>
                  </div>
             </div> 
              </div>
          </div>
      </div>
  </div>


  <div class="apportionment" id="apportionment-section" style="display: none;">
    <table class="table table-bordered">
      <thead>
        <th class="fs-6 text-dark" style="color:black;">Product</th>
        <th class="fs-6 text-dark" style="color:black;">Quantity</th>
        <th class="fs-6 text-dark" style="color:black;">Supplier Price</th>
        <th class="fs-6 text-dark" style="color:black;">Total Supplier Price</th>
        <th class="fs-6 text-dark" style="color:black;">Total Product Expenses</th>
        <th class="fs-6 text-dark" style="color:black;">Unit Product Expense</th>
        <th class="fs-6 text-dark" style="color:black;">Total Purchase Price + Expense</th>
        <th class="fs-6 text-dark" style="color:black;">Total Purchase Price</th>                                                                   
      </thead>
      <tbody class="" id="apportionment-table"></tbody>
      <tfoot id="expense-footer"></tfoot>
    </table>
    <div class="d-flex justify-content-between align-items-center">
      <button class="btn btn-outline-dark btn-sm" id="back_button" onclick="showMain()">Back</button>
      <button class="btn btn-dark btn-sm mt-1" id="confirm_btn">Confirm</button>
  </div>
  </div>
</div>

  <div class="modal fade" id="batchModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
              <h5 class="fw-bold">Enter Batch Code</h5>
              <form class="mt-2">
                {{ batch_form | crispy}}
                <p id="cartError" class="text-danger"></p>
                <div class="d-flex justify-content-end">
                  <div class="">
                      <button type="reset" class="btn btn-danger btn-sm w-100">
                          <i class='bx bx-reset'></i>
                          Reset
                      </button>
                  </div>
                  <span class="px-1"></span>
                  <div class="">
                      <button type="button" onclick="addBatchCode();" class="btn btn-secondary btn-sm w-100">
                          <i class='bx bx-save'></i>
                          Save
                      </button>
                  </div>
              </div>
              </form>
            </div>
            </div>
        </div>
    </div>
</div>



<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h5 class="fw-bold">Add Product</h5>
                <form method="post" class='mt-2 p-2'>
                  {% csrf_token %} 
                  <div id="div_id_batch_code" class="mb-3 d-none"> 
                      <label for="id_batch_code" class="form-label requiredField">
                          Batch code<span class="asteriskField">*</span>
                      </label>
                      <div class="d-flex form-group">
                        <select class="select form-select" id='id_code_select'>
                            <option value="">-----</option>
                        </select>
                        <button 
                          type="button" 
                          class="btn border bx bx-plus" 
                          id="add_batch_modal">
                        </button>
                    </div>
                  </div>
                  <div id="div_id_name" class="mb-3 form-group">
                        <label for="id_name" class="form-label requiredField">
                          Name
                          <span class="asteriskField">*</span> 
                      </label> 
                        <div class="d-flex align-items-center">
                            <input type="text"
                                   name="name"
                                   maxlength="255"
                                   class="textinput form-control"
                                   required id="id_name">
                            <button class="btn btn-light border btn-sm" type="button">s</button>
                            <button class="btn btn-light bx bx-edit border mx-1" type="button"></button>
                            <button class="btn btn-light bx bx-trash border" type="button"></button>
                        </div>
                  </div> 
                  <div id="div_id_category form-group" class="mb-3"> 
                      <label for="id_category" class="form-label requiredField">
                          Category<span class="asteriskField">*</span> 
                      </label> 
                      <div class='d-flex align-items-center'>
                          <select name="category" class="select form-select" required id="id_category"> 
                              <option value="">---------</option> 
                          </select> 
                          <button class='btn border small' type="button" id='id_add_category'>
                              <i class='bx bx-plus'></i>
                          </button>
                      </div>
                  </div> 
                  <div id="div_id_tax_type" class="mb-3"> 
                      <label for="id_tax_type" class="form-label requiredField">
                      Tax type
                      <span class="asteriskField">*</span> 
                      </label> 
                      <select name="tax_type" class="select form-select" required id="id_tax_type"> 
                          <option value="" selected>---------</option>
                          <option value="exempted">Exempted</option> 
                          <option value="standard">Standard</option> 
                          <option value="zero rated">Zero Rated</option>
                      </select> 
                  </div>
                  <div id="div_id_min_stock_level" class="mb-3"> 
                      <label for="id_min_stock_level" class="form-label requiredField">
                          Min stock level
                          <span class="asteriskField">*</span> 
                      </label> 
                      <input 
                          type="number" 
                          name="min_stock_level" 
                          value="0" 
                          class="numberinput form-control" 
                          required id="id_min_stock_level"
                      > 
                  </div>
                  <div id="div_id_description" class="mb-3"> 
                      <label for="id_description" class="form-label requiredField">
                          Description<span class="asteriskField">*</span> 
                      </label> 
                      <textarea 
                          name="description" 
                          cols="20" 
                          rows="2" 
                          class="textarea form-control" 
                          required id="id_description"
                      ></textarea> 
                  </div>
                  <div class="mb-3"> 
                      <div id="div_id_end_of_day" class="form-check"> 
                          <input type="checkbox" name="end_of_day" class="checkboxinput form-check-input" id="id_end_of_day"> 
                          <label for="id_end_of_day" class="form-check-label">
                              End of day
                          </label> 
                      </div> 
                  </div>
                  <div class="mb-3"> 
                    <div id="div_id_service" class="form-check"> 
                      <input type="checkbox" name="service" class="checkboxinput form-check-input" id="id_service"> 
                      <label for="id_service" class="form-check-label">
                        Service
                    </label> 
                  </div> 
                </div>
                <p class='text-danger' id='error'></p>
                  <div class="d-flex justify-content-end">
                      <div class="">
                          <button type="reset" class="btn btn-danger btn-sm w-100">
                              <i class='bx bx-reset'></i>
                              Reset
                          </button>
                      </div>
                      <span class="px-1"></span>
                      <div class="">
                          <button type="button" id="id_submit_product" class="btn btn-secondary btn-sm w-100">
                              <i class='bx bx-save'></i>
                              Save
                          </button>
                      </div>
                  </div>
              </form>
            </div>
        </div>
    </div>
</div>

    <div class="modal fade" id="noteStatusModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-body">
                <h5 class="fw-bold">Proceed by filling the Purchase Order form below</h5>
                <form class="mt-2">
                  {{ note_form | crispy}}
                  <p id="cartError" class="text-danger"></p>
                  <div class="d-flex justify-content-end">
                    <div class="">
                        <button type="reset" class="btn btn-outline-dark btn-sm w-100">
                            <i class='bx bx-reset'></i>
                            Reset
                        </button>
                    </div>
                    <span class="px-1"></span>
                    <div class="">
                        <button type="button" onclick="processCart();" class="btn btn-dark btn-sm w-100">
                            <i class='bx bx-save'></i>
                            Save
                        </button>
                    </div>
                </div>
                </form>
              </div>
          </div>
      </div>
    </div>

    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-body text-center" id='payment_content'>
                <i class='bx bx-check-circle h1'></i>
                <h5>Product Successfully Created</h5>
              </div>
          </div>
      </div>
    </div>

    <div class="modal fade" id="supplierSuccessModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-body text-center" id='payment_content'>
                <i class='bx bx-check-circle h1'></i>
                <h5>Supplier Successfully Created</h5>
              </div>
          </div>
      </div>
    </div>

    <div class="modal fade" id="poSuccessModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-body text-center" id='payment_content'>
                <i class='bx bx-check-circle h1'></i>
                <h5>Purchase Order Successfully Created</h5>
              </div>
          </div>
      </div>
    </div>
    
</div>   
<script src="{% static 'js/calculater.js' %}"></script>
<script>
    let cart = [];
    let prodData = [];
    let searchValue = '';
    let prodQauntity = 0;
    let prodPrice = 0;
    let prodCost  = 0;
    let finalTotal = 0;
    let expenseCount = 0;
    let otherExpenses = 0;
    let expensesData = [];
    let products = [];
    let purchaseData = [];
    let formData = [];
    let holdPurchaseOrder = false
   
    const errorEl = document.getElementById('error');
    const addToCartError = document.getElementById('cart_error');
    const supError = document.getElementById('sup_error');
    const productBtn = document.getElementById('id_add_product');
    const supplierBtn = document.getElementById('id_add_supplier');
    const batchModalBtn = document.getElementById('add_batch_modal');
 
    const batchModal = new bootstrap.Modal(document.getElementById('batchModal'));

    const noteModal = new bootstrap.Modal(document.getElementById('noteStatusModal'));
    const productFormModal = new bootstrap.Modal(document.getElementById('addSupplierModal'));
    const supplierFormModal = new bootstrap.Modal(document.getElementById('addProductModal'));
    
    const poSuccessModal = new bootstrap.Modal(document.querySelector('#poSuccessModal'));
    const successModal = new bootstrap.Modal(document.querySelector('#successModal'));
    const categoryModal = new bootstrap.Modal(document.querySelector('#categoryModal'));
    const supplierSuccessModal = new bootstrap.Modal(document.getElementById('supplierSuccessModal'));

    const productSubmitBtn = document.getElementById('id_submit_product');
    const supplierSubmitBtn = document.getElementById('id_submit_supplier');
    const addToCartBtn = document.getElementById('id_add_to_cart');
    const confirmBtn = document.getElementById('confirm_btn');

    const cartError = document.getElementById('cartError');

    const savePurchasaeOrderButton = document.getElementById('save_purchase_order')
    //savePurchasaeOrderButton.addEventListener('click', () => {
    //    holdPurchaseOrder = true;
    //    processCart()
    //})

    calculateExpression('id_p_price', errorId = null)

    function addExpense() {
      expenseCount++;
      
      // Create new elements for the expense name and amount
      const row = document.createElement('tr');
      row.id = `expense-row-${expenseCount}`;

      // Name column
      const cell = document.createElement('td');
      cell.colSpan='3';

      const nameCell = document.createElement('td');
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = 'Expense Name';
      nameInput.className = 'form-control';
      nameInput.id = `expense-name-${expenseCount}`;
      nameCell.appendChild(nameInput);

      // Amount column
      const amountCell = document.createElement('td');
      const amountInput = document.createElement('input');
      amountInput.type = 'number';
      amountInput.placeholder = 'Amount';
      amountInput.className = 'form-control text-center';
      amountInput.id = `expense-amount-${expenseCount}`;
      amountInput.oninput = () => calculateExpense();
      amountCell.appendChild(amountInput);

      // Insert the new row into the table
      row.appendChild(cell);
      row.appendChild(nameCell);
      row.appendChild(amountCell);
      
      const otherRow = document.getElementById('other-expense-row');
      otherRow.insertAdjacentElement('afterend', row);
    }

    // Function to calculate total expenses in 'Other' field
    function calculateExpense() {
      let totalExpense = 0;
      for (let i = 1; i <= expenseCount; i++) {
        const amount = parseFloat(document.getElementById(`expense-amount-${i}`).value) || 0;
        totalExpense += amount;
      }

      // Set the total in the 'Other' field
      document.getElementById('id_other').value = totalExpense.toFixed(2);
      calculateTotals();
    }

    function showMain() {
        document.getElementById('main-section').style.display = 'flex';
        document.getElementById('apportionment-section').style.display = 'none';
    }


    productSubmitBtn.addEventListener('click', ()=>{
      addProduct()
    })

    supplierSubmitBtn.addEventListener('click', ()=>{
      addSupplier()
    })

    productBtn.addEventListener('click', ()=>{
        productFormModal.show()
    })

    confirmBtn.addEventListener('click', ()=>{
        noteModal.show()
        submitTableData()
    })

    document.querySelector('#id_add_category').addEventListener(
        'click', ()=>{
            categoryModal.show()
            supplierFormModal.hide()
        }
    ) 

    batchModalBtn.addEventListener('click', ()=>{
      batchModal.show()
      supplierFormModal.hide()
      // productFormModal.hide()
    })

    function isCartEmpty(){
        if (cart.length === 0){
            confirmBtn.disabled=true;
        }else{
            confirmBtn.disabled=false;
        }
    }

    isCartEmpty()

    function reload(){
      window.location.reload()
    }

    // add batch_code
    function addBatchCode(){
      const data = {batch_code:$('#id_code').val()}
      
      fetch("{% url 'inventory:batch_code' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"), 
          },
          body: JSON.stringify(data),
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              fetchBatchCodes()
              supplierFormModal.show()
              batchModal.hide()
              Swal.fire({
                title: 'success',
                text: 'Batch code successfully saved.',
                icon:'success',
                timer: 2000,
                showConfirmButton: false
              })
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message,
              });
            }
          })
          .catch((error) => {
            Swal.fire({
                title:'warning',
                text:error,
                icon:'warning',
              })
          });
    }

    // retreive batch codes
    async function fetchBatchCodes(){
          try {
              const response = await fetch('{% url "inventory:batch_code" %}');
              console.log(response)
              if (!response.ok) {
                  console.log(response)
              }

              const data = await response.json();
              console.log(data)
              updateBatchCodes(data);
          } catch (error) {
              console.error('Error fetching batch codes:', error);
          } 
      }

    fetchBatchCodes()

    // update batchcodes
    function updateBatchCodes(data){
        const catElement = document.querySelector('#id_code_select')
        
        while(catElement.options.length > 1){
              catElement.remove(1)
        }
        data.forEach((batch)=>{
          console.log(data, batch)
            catElement.innerHTML += `<option value=${batch.id}>${batch.code}</option>`
        })
    }

    function categorySubmit(){
        
      const data = {name:$('#id_category_name').val()}
        
      fetch("{% url 'inventory:add_product_category' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"), 
          },
          body: JSON.stringify(data),
        })
          .then(response => response.json())
          .then((response) => {
            if (response.success) {
              Swal.fire({
                title: 'success',
                text: 'Category successfully saved.',
                icon:'success',
                timer: 2000,
                showConfirmButton: false
              })
              fetchCategories()
              categoryModal.hide()
              supplierFormModal.show()
            } else {
              Swal.fire({
                title:'warning',
                text:response.message,
                icon:'warning',
              })
            }
          })
          .catch((error) => {
            console.log(error)
          });
        }

      async function fetchCategories(){
          try {
              const response = await fetch('{% url "inventory:add_product_category" %}');
  
              if (!response.ok) {
                  throw new Error('Network response was not ok.');
              }
              const data = await response.json();
              updateCategory(data);
          } catch (error) {
              console.error('Error fetching categories:', error);
          } 
      }

      fetchCategories()

      function updateCategory(data){
          const catElement = document.querySelector('#id_category')

          console.log('loading products')
      
          while(catElement.options.length > 1){
              catElement.remove(1)
          }
          data.forEach((category)=>{
              catElement.innerHTML += `<option value=${category.id}>${category.name}</option>`
          })
      }
    
        function addProduct() {
            const data = {
              name: document.getElementById('id_name').value,
              category: document.getElementById('id_category').value,
              tax_type: document.getElementById('id_tax_type').value,
              min_stock_level: parseInt(document.getElementById('id_min_stock_level').value),
              description: document.getElementById('id_description').value,
              end_of_day: document.getElementById('id_end_of_day').checked,
              service: document.getElementById('id_service').checked,
            };

            console.log(data)
          
            fetch("{% url 'inventory:product' %}", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
              },
              body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                supplierFormModal.hide();
                fetchProducts();
                Swal.fire({
                  icon: 'success',
                  title: 'Product Added',
                  text: 'The product has been successfully added!',
                  timer: 2000,
                  showConfirmButton: false
                });
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: data.message,
                });
              }
            })
            .catch((error) => {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Something went wrong while adding the product.',
              });
            });
          }
          
    async function fetchProducts(){
        try {
            const response = await fetch("{% url 'inventory:product' %}");

            if (!response.ok) {
                throw new Error('Network response was not ok.');
            }
            const data = await response.json();
            
            updateProduct(data);
        } catch (error) {
            console.error('Error fetching categories:', error);
        } 
    }

    function updateProduct(data){
        const prodElement = document.querySelector('#id_product')
        prodElement.innerHTML = '<option value="">Select Product</option>';
        
        while(prodElement.options.length > 1){
          prodElement.remove(1)
        }
        data.forEach((data)=>{
            prodElement.innerHTML += `<option value=${data.id}>${data.name}</option>`
        })

    }

    fetchProducts()
    
    supplierBtn.addEventListener('click', ()=>{
        supplierFormModal.show()
    })

  
    $(document).ready(function() {
      $('#id_product').select2(
          {placeholder: 'Select Product'}
      )
      .on('change', function (e){
           const pElement = document.getElementById('id_product')
           const pSelectedOption = pElement.options[pElement.selectedIndex] 
            let product = pSelectedOption.textContent;
            product = product.split(' [')[0]
            console.log(product)
           fetch(`/inventory/inventory/?name=${product}`)
          .then(response => response.json())
          .then(data=>{
            prodData.push(data)
          })
          .catch(error => console.error('Error:', error))
      })
     
    })

    $(document).ready(function() {
        $('#id_supplier').select2(
            {placeholder: 'Select Supplier'}
        )
        .on('change', function (e){
            const pElement = document.getElementById('id_supplier')
            const pSelectedOption = pElement.options[pElement.selectedIndex] 
            supplier = pSelectedOption.textContent;
            console.log(supplier)
        })
       
      })

      function addSupplier() {
        const data = {
          name: document.getElementById('id_sup_name').value,
          contact: document.getElementById('id_contact_name').value,
          email: document.getElementById('id_email').value,
          phone: document.getElementById('id_phone').value,
          address: document.getElementById('id_address').value,
        };
      
        fetch("{% url 'inventory:create_supplier' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            supplierFormModal.hide();
            fetchSuppliers();
            Swal.fire({
              icon: 'success',
              title: 'Supplier Added',
              text: 'The supplier was successfully added!',
              timer: 2000,
              showConfirmButton: false
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: data.message,
            });
          }
        })
        .catch((error) => {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Something went wrong while adding the supplier.',
          });
        });
    }      

    async function fetchSuppliers(){
        try {
            const response = await fetch("{% url 'inventory:supplier_list_json' %}");

            if (!response.ok) {
                throw new Error('Network response was not ok.');
            }
            const data = await response.json();
            
            updateSuppliers(data);
        } catch (error) {
            console.error('Error fetching categories:', error);
        } 
    }

    function updateSuppliers(data){
        const supElement = document.querySelector('#id_supplier')
        supElement.innerHTML = '<option value="">Select Supplier</option>';
        
        while(supElement.options.length > 1){
          supElement.remove(1)
      }
        data.forEach((data)=>{
            supElement.innerHTML += `<option value=${data.id}>${data.name}</option>`
        })

    }

    function generateUniqueId() {
        return Math.floor(Math.random() * 1000000000).toString(36);
      }
    
    function updateCartDisplay() {
        const cartItemsList = document.getElementById("cart-items");
        cartItemsList.innerHTML = "";

        cart.forEach((item, index) => {
            const row = document.createElement("tr");

            row.innerHTML = `
            <td>
                <button class="btn" data-id=${item.id} onclick="removeItem(this);">
                    <i class='bx bx-trash-alt'></i>
                </button>
            </td>
            <td>
                ${item.product}
            </td>
            <td>
                <input type="number" class="form-control" id="quantity-${item.id}" value="${item.quantity}" min="1" 
                    onchange="updateItemQuantity('${item.id}', this.value)">
            </td>
            <td>
                <input type="number" class="form-control" id="price-${item.id}" value="${item.price}" min="0" step="0.01" 
                    onchange="updateItemPrice('${item.id}', this.value)">
            </td>
            <td class='text-center' id="total-${item.id}">${(item.quantity * item.price).toFixed(2)}</td>
        `;
            cartItemsList.appendChild(row);
        });

        calculateTotals(); 
    }

    function updateItemPrice(id, newPrice) {
        const item = cart.find((item) => item.id === id);
        if (item) {
            item.price = parseFloat(newPrice); 
            updateItemTotal(item); 
            calculateTotals(); 
        }
    }

    function updateItemQuantity(id, newQuantity) {
        const item = cart.find((item) => item.id === id);
        if (item) {
            item.quantity = Number(newQuantity); 
            updateItemTotal(item); 
            calculateTotals();
        }
    }

    function updateItemTotal(item) {
        const totalElement = document.getElementById(`total-${item.id}`);
        const totalPrice = (item.quantity * item.price).toFixed(2);
        totalElement.textContent = totalPrice; 
    }

    

    function addItem() {
        const pElement = document.getElementById('id_product');
        const pSelectedOption = pElement.options[pElement.selectedIndex];
        let product = pSelectedOption.textContent.split(' [')[0];
        const supplier = document.getElementById('id_supplier').value;
        const price = parseFloat(document.getElementById('id_p_price').value);
        const quantity = Number(document.getElementById('id_p_quantity').value);

        
      
        if (!product || !quantity || !price || !supplier) {
          Swal.fire({
            icon: 'error',
            title: 'Missing Information',
            text: 'Please fill in all the fields: Product, Quantity, Price, and Supplier.',
          });
          return;
        }
      
        const existingItem = cart.find((item) => item.product === product);
        if (existingItem) {
          Swal.fire({
            icon:'error',
            text:'Product Exists',
            title:'error'
          })
          return;
        } else {
          const newTransfer = { 
            id: generateUniqueId(),
            product: product,
            quantity: quantity,
            price: price,
            supplier: supplier,
          };
            cart.push(newTransfer);
            cart.reverse()
        }
        
        updateCartDisplay();
        calculateTotals();
        isCartEmpty();
      
        Swal.fire({
          icon: 'success',
          title: 'Item Added',
          text: 'The item was successfully added to your cart!',
          timer: 1500,
          showConfirmButton: false
        });
      }
      
    
    const removeItem = (el) => {
        const id = el.dataset.id
        cart = cart.filter((item) => item.id !== id);
        updateCartDisplay();
    }
    
    function processCart() {

      const data= {
        'po_items':cart,
        'hold':holdPurchaseOrder,
        'expenses':expensesData,
        'cost_allocations':formData,
          'purchase_order': {
          'batch': document.getElementById('id_batch').value.trim(),
          'payment_method':document.getElementById('id_payment_method').value,
          'supplier':document.getElementById('id_supplier').value,
          'delivery_date':document.getElementById('id_delivery_date').value,
          'total_cost': finalTotal,
          'status':document.getElementById('id_status').value,
          'notes':document.getElementById('id_notes').value.trim(),
          'discount':parseFloat(document.getElementById('id_discount').value) || 0,
          'tax_amount':parseFloat(document.getElementById('tax').textContent) || 0,
          'other_amount':parseFloat(document.getElementById('id_other').value) || 0
        }
      }
      
      fetch("{% url 'inventory:create_purchase_order' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"), 
        },
        body: JSON.stringify(data),
      })
      .then(response => response.json())
      .then(data=>{
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'success',
              text: 'Purchase Order Successfully Created',
            }).then(()=>{
              window.location.reload() 
            })
          } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message,
              });
          } 
        })
        .catch((error) => {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error,
          });
        });
    }


    function calculateTotals() {
      let subtotal = 0;
      cart.forEach(item => {
          subtotal += item.price * item.quantity;
      });

      let discount = parseFloat(document.getElementById('id_discount').value) || 0;
      let discountedTotal = subtotal - discount;

      let taxRate = 0.15;
      let tax = 0

      let other = parseFloat(document.getElementById('id_other').value) || 0;

      finalTotal = discountedTotal + other;

      // Update the table
      document.getElementById('subtotal').innerText = subtotal.toFixed(2);
      document.getElementById('tax').innerText = tax.toFixed(2);
      document.getElementById('id_total').innerText = finalTotal.toFixed(2);
    }

    calculateTotals();

    // cost apportionment
    document.getElementById('next_button').addEventListener('click', ()=>{
      if (cart.length != 0){

        document.getElementById('main-section').style.display = 'none';
        document.getElementById('apportionment-section').style.display = 'block';
        const expenseFooter = document.getElementById('expense-footer');

        let totalExpenses = 0;
        let rate = 0;
      
        const apportionmentTable = document.getElementById('apportionment-table');
        let other_amount = parseFloat(document.getElementById('id_other').value) || 0;

        totalExpenses = other_amount;
  
        cost = totalProductCost(cart, totalExpenses);
        console.log(cost)

        apportionmentTable.innerHTML = '';
        
          // populate the table 
        cart.reverse().forEach((item) => {
          const row = document.createElement("tr");
          let id = 1;
          let actualCostPrice = 0;
          let result = allocateCost(cost, item.price, item.quantity, totalExpenses)

          console.log(result)
          // add actual cost price 
          actualCostPrice = result.expCost;

          // add to cart
          item.actualPrice = actualCostPrice;

          let total = parseFloat(item.price * item.quantity) + parseFloat(result.allocated);
          let totalBuying = item.price * item.quantity;
          let product = item.product.toString();

          row.innerHTML = `
            <td id='${item.id}'><small>${item.product}</small></td>
            <td id='${item.id}'><small>${item.quantity}</small></td>
            <td id='${item.id}'><small>${item.price.toFixed(2)}</small></td>
            <td id='${item.id}'><small>${totalBuying.toFixed(2)}</small></td>
            <td id='${item.id}'><small>${result.allocated}</small></td>
            <td id='${item.id}'>
                <small>
                    <input
                      value='${result.allocationRate.toFixed(2)}' 
                      class='po-input form-control' 
                      type='number'
                      data-id='${item.id}'
                      oninput='priceOverride(
                        this, 
                        {
                          tB:${result.allocated},
                          exp:${totalExpenses},
                          product:"${product}",
                          acp:${result.allocationRate.toFixed(2)}
                        }
                      )'
                    />
                </small>
            </td>
            <td id='${item.id}'>
              <small>
                ${actualCostPrice}
              </small>
            </td> 
            <td id='${item.id}'><small>${total.toFixed(2)}</small></td>
          `;
        
          apportionmentTable.appendChild(row);

          expenseFooter.innerHTML = '';  

          expenseFooter.innerHTML += `
            <tr>
                <td class='fw-bold'><small>Total Expenses</small></td>
                <td colspan="3"></td>
                <td><small id="total_expenses" class='fw-bold'></small></td>
                <td colspan="3"></td>
            </tr>
          `;

          for (let i = 1; i <= expenseCount; i++) {
            const expenseName = document.getElementById(`expense-name-${i}`).value;
            const expenseAmount = parseFloat(document.getElementById(`expense-amount-${i}`).value) || 0;

              // Push each expense as an object to the expensesData array
              let expenseExist = expensesData.filter((exp) => exp.name === expenseName)
           
              expensesData.push({
                  name: expenseName,
                  amount: expenseAmount
              });

              console.log(expensesData)
            
            // Create and append the expense row to the footer
            const expenseRow = document.createElement('tr');
            expenseRow.innerHTML += `
              <td>${expenseName}</td>
              <td colspan='3'></td>
              <td>${expenseAmount.toFixed(2)}</td>
              <td colspan='3'></td>
            `;

            expenseFooter.appendChild(expenseRow);
          }
          document.getElementById('total_expenses').innerHTML = totalExpenses.toFixed(2);
      });
      }else{
        Swal.fire({
          icon: 'warning',   
          text: 'Please add purchase order items!',
          title: 'Warning', 
        });
        return;
      }
    })

    // cost price overide
    function priceOverride(input, data) {
      let expense = 0;
      let totalCost = 0;
      let exp = parseFloat(document.getElementById('total_expenses').textContent);

      const newCart = JSON.parse(JSON.stringify(cart));
      const newCost = parseFloat(input.value);
      const expFooter = document.getElementById('expense-footer');  
      const tdEls = document.querySelectorAll(`[id^='${input.dataset.id}']`);

      expense = exp;

      if (data.acp !== newCost) {
        console.log('Costs' + data.acp, newCost)
        const productId = `product_${data.product.replace(/\s+/g, '_')}`;

        let existingProduct = document.getElementById(productId);

        existItem = cart.find((item) => item.product === data.product)
        existItem.actualPrice = parseFloat(input.value)
        
        // push product 
        products.push(data.product)

        if (!existingProduct) {
          
          addProductToFooter(expFooter, data, productId);
          products.push(data.product);  

          recalculateTotalExpenses(exp, data.tB);
          updateValues(newCart, expense, data.product)
          tdEls.forEach((td)=>{
            td.classList.add('bg-danger');
            td.classList.add('text-light');
          })
        } else {
          // If product exists, update the amount
           updateProductAmount(existingProduct, data);
          // console.log('Updated product:', data.product);
        }

      } else {

        const productId = `product_${data.product.replace(/\s+/g, '_')}`;
        let existingProduct = document.getElementById(productId);

        if (existingProduct) {
          existingProduct.remove();
          revertTotalExpenses(data.exp, data.tB);
        }
        updateValues(newCart, expense, data.product)
        tdEls.forEach((td)=>{
          td.classList.remove('bg-danger');
          td.classList.remove('text-light');
        })
      }

    }

    function revertTotalExpenses(exp, tB) {
      // Add the original cost back to total expenses
      document.getElementById('total_expenses').innerHTML = (parseFloat(exp)).toFixed(2);
    }

    // New helper method to add a product to the footer
    function addProductToFooter(expFooter, data, productId) {
      expFooter.innerHTML += `
        <tr id='${productId}'>
          <td class='text-danger'>${data.product}</td>
          <td colspan='3'></td>
          <td class='text-danger' id='value_${productId}'>(${data.tB.toFixed(2)})</td>
          <td colspan='3'></td>
        </tr>
      `;
    }

    // update an existing product's amount
    function updateProductAmount(existingProduct, data) {
      let amountCell = existingProduct.querySelector(`#value_${existingProduct.id}`);
      let currentAmount = parseFloat(amountCell.textContent.replace(/[()]/g, ''));
      let newAmount = currentAmount + data.tB; 
      amountCell.textContent = `(${newAmount.toFixed(2)})`; 
    }

    // recalculate total expenses
    function recalculateTotalExpenses(exp, tB) {
      expense = (exp - tB).toFixed(2)
      document.getElementById('total_expenses').innerHTML = expense;
    }

    // Update values and UI after product removal
    function updateValues(newCart, expenses, product) {
        // Find the index of the product to be removed
        let totalCost = totalProductCost(newCart);

        for(prod in products){
          let existingItemIndex = newCart.findIndex((item) => item.product === products[prod]);

          if (existingItemIndex !== -1) {
              newCart.splice(existingItemIndex, 1);  
          }

        
        }
        const rows = document.querySelectorAll('#apportionment-table tr');

        newCart.forEach((item) => {
            rows.forEach((row) => {
                const firstCell = row.querySelector('td:first-child small');

                if (firstCell && firstCell.textContent.trim() === item.product) {
                    
                    let result = allocateCost(
                        totalCost, 
                        item.price, 
                        item.quantity, 
                        expenses
                    );

                    let totalBuying = item.price * item.quantity;
                    let total = totalBuying + parseFloat(result.allocated);

                    // Update the row content with new values
                    row.innerHTML = `
                        <td id='${item.id}'><small>${item.product}</small></td>
                        <td id='${item.id}'><small>${item.quantity}</small></td>
                        <td id='${item.id}'><small>${item.price.toFixed(2)}</small></td>
                        <td id='${item.id}'><small>${totalBuying.toFixed(2)}</small></td>
                        <td id='${item.id}'><small>${result.allocated}</small></td>
                        <td id='${item.id}'><small>${result.allocationRate.toFixed(2)}</small></td>
                        <td id='${item.id}'>
                            <small>
                                <input 
                                    value='${result.expCost}' 
                                    class='po-input form-control' 
                                    type='number'
                                    data-id='input_${item.id}'
                                    oninput='priceOverride(
                                        this, 
                                        {
                                            tB:${result.allocated},
                                            exp:${expenses},
                                            product:"${item.product}",
                                            acp:${result.expCost}
                                        }
                                    )'
                                />
                            </small>
                        </td>
                        <td id='${item.id}'><small>${total.toFixed(2)}</small></td>
                    `;
                }
            });
        });
    }

    // update UI
    function updateUi(params) {
      
    }

    // calculate total product costs
    function totalProductCost(cart) {
      let totalCost = 0;

      cart.forEach((item) => {
        totalCost += item.price * item.quantity;
      })
      
      return parseFloat(totalCost) || 0;
    }


    // Allocate expenses costs -> Cost Based Allocation
    function allocateCost(totalCost, price, quantity, expenses) {
      let productCost = 0;
      let productCostAllocationRate = 0;

      productCost = price * quantity;
      productCostAllocationRate = productCost / totalCost;

      console.log(productCostAllocationRate)

      let expCost = (productCost + (productCostAllocationRate * expenses)) / quantity
      let allocated = productCostAllocationRate * expenses;

        return {
        expCost:expCost.toFixed(2),
        allocated:allocated.toFixed(2),
        allocationRate:expCost - price 
      }
    }

    function updateValues(newCart, expenses) {
        let totalCost = totalProductCost(newCart);

        // Remove products from 'newCart'
        console.log('products' + products)
        products.forEach((product) => {
            let existingItemIndex = newCart.findIndex((item) => item.product === product);
            if (existingItemIndex !== -1) {
                newCart.splice(existingItemIndex, 1);
            }
        });

        // Update the rows of the table based on 'newCart'
        const rows = document.querySelectorAll('#apportionment-table tr');
        newCart.forEach((item) => {
            rows.forEach((row) => {
                const firstCell = row.querySelector('td:first-child small');
                if (firstCell && firstCell.textContent.trim() === item.product) {

                    let result = allocateCost(
                        totalCost,
                        item.price,
                        item.quantity,
                        expenses
                    );

                    let totalBuying = item.price * item.quantity;
                    let total = totalBuying + parseFloat(result.allocated);

                    // Update the row content with new values
                    row.innerHTML = `
                    <td id='${item.id}'><small>${item.product}</small></td>
                    <td id='${item.id}'><small>${item.quantity}</small></td>
                    <td id='${item.id}'><small>${item.price.toFixed(2)}</small></td>
                    <td id='${item.id}'><small>${totalBuying.toFixed(2)}</small></td>
                    <td id='${item.id}'><small>${result.allocated}</small></td>
                    <td id='${item.id}'><small>${result.allocationRate.toFixed(2)}</small></td>
                    <td id='${item.id}'>
                        <small>
                            <input 
                                value='${result.expCost}' 
                                class='po-input form-control' 
                                type='number'
                                data-id='input_${item.id}'
                                oninput='priceOverride(
                                    this, 
                                    {
                                        tB:${result.allocated},
                                        exp:${expenses},
                                        product:"${item.product}",
                                        acp:${result.expCost}
                                    }
                                )'
                            />
                        </small>
                    </td>
                    <td id='${item.id}'><small>${total.toFixed(2)}</small></td>
                `;
                }
            });
        });
    }

    // Function to collect data from the table and submit it to the backend
    function submitTableData() {
        const rows = document.querySelectorAll('#apportionment-table tr');

        // Loop through each row and extract data
        rows.forEach((row) => {
            let product = row.querySelector('td:first-child small')?.textContent.trim();
            let quantity = row.querySelector('td:nth-child(2) small')?.textContent.trim();
            let price = row.querySelector('td:nth-child(3) small')?.textContent.trim();
            let totalBuying = row.querySelector('td:nth-child(4) small')?.textContent.trim();
            let allocated = row.querySelector('td:nth-child(5) small')?.textContent.trim();
            let allocationRate = row.querySelector('td:nth-child(6) input')?.value;
            let expCost = row.querySelector('td:nth-child(7) small')?.textContent.trim();
            let total = row.querySelector('td:nth-child(8) small')?.textContent.trim();

            // Prepare the data object for each row
            if (product) {
                formData.push({
                    product: product,
                    quantity: quantity,
                    price: price,
                    totalBuying: totalBuying,
                    allocated: allocated,
                    allocationRate: allocationRate,
                    expCost: expCost,
                    total: total
                });
            }
        });
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }    
</script>
        
{% endblock content %}