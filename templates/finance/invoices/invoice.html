{% extends "base.html" %}
{% load static%}
{% block title%} Invoices {% endblock%}
{% block content %}
<div class="finance d-flex">
    <div class="px-2 main-content ">
        <div class="finance-navba mt-2">
            <nav class="border rounded d-flex justify-content-between align-items-center p-2">
                <div class='mt-1'>
                    <h5 class='fw-bold'>Invoices</h5>
                </div>
                <form method="get" class="d-flex justify-content-between align-items-center">
                    <input
                        id="search"
                        name="q"
                        type="search"
                        value="{{search_query}}"
                        class="form-control"
                        placeholder="search..."
                    />
                </form>
            </nav>
        </div>
        <div class='row mt-2'>
            <div class='col'>
                <div class='card'>
                    <div class='card-body rounded'>
                        <h6>Due</h6>
                        <h6 class='text-center text-light text-muted'>${{total_due}}</h6>
                    </div>
                </div>
            </div>
            <div class='col'>
                <div class='card'>
                    <div class='card-body rounded'>
                        <h6>Paid</h6>
                        <h6 class='text-center text-light text-muted'>${{total_paid}}</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class='mt-3 mb-3'>
            <div class='mt-2 px-1 fw-bold'>List</div>
        </div>
        
        <div class='table-responsive'>
            <table class="table table-striped border rounded table-responsive table-sm p-2">
                <thead>
                    <tr class='fw-normal'>
                        <th>Date</th>
                        <th>Invoice #</th>
                        <th>Customer</th>
                        <th>Details</th>
                        <th>Amount Paid</th>
                        <th>Amount Due</th>
                        <th>Amount</th>
                        <th>Processed by</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices %}
                        <tr style='color: #6c757d;'>
                            {% if invoice.payment_status == 'Paid'%}
                                <td><small>{{invoice.issue_date}}</small></td>
                                <td><small>#{{invoice.invoice_number}}</small></td>
                                <td><a href="{% url 'finance:customer' invoice.customer.id%}">{{invoice.customer.name}}</a></td>
                                <td><small>{{invoice.products_purchased}}</small></td>
                                <td><small>{{invoice.currency.symbol}} {{invoice.amount_paid}}</small></td>
                                <td><small>{{invoice.currency.symbol}} {{invoice.amount_due}}</small></td>
                                <td><small>{{invoice.currency.symbol}} {{invoice.amount}}</small></td>
                                <td><small>{{invoice.user.username}}</small></td>
                                <td>
                                    <span>
                                        <a href="{% url 'finance:invoice_preview' invoice.id %}" class='btn btn-light btn-sm'>
                                            <i class='bx bx-show'></i>
                                        </a>
                                    </span>  
                                    <span>
                                        {% if request.user.role == 'admin' %}
                                            <button class="btn btn-light btn-sm text-success" disabled>
                                                <i class='bx bx-rectangle'></i>
                                            </button>
                                        {% endif %}
                                    </span>
                                    <span>
                                        {% if request.user.role == 'admin' %}
                                            <button data-id={{invoice.id}} id='whatsappBtn' class="btn btn-light btn-sm text-success">
                                                <i class='bx bxl-whatsapp'></i>
                                            </button>
                                        {% endif %}
                                    </span>
                                    <span>
                                        {% if request.user.role == 'admin' %}
                                            <button class="btn btn-light btn-sm text-danger">
                                                <i class='bx bx-trash'></i>
                                            </button>
                                        {% endif %}
                                    </span>  
                                </td>
                            {% else %}
                                <td class='text-danger'><small>{{invoice.issue_date}}</small></td>
                                <td class='text-danger'><small>#{{invoice.invoice_number}}</small></td>
                                <td><a href="{% url 'finance:customer' invoice.customer.id%}">{{invoice.customer.name}}</a></td>
                                <td><small>{{invoice.products_purchased}}</small></td>
                                <td class='text-danger'><small>{{invoice.currency.symbol}} {{invoice.amount_paid}}</small></td>
                                <td class='text-danger'><small>{{invoice.currency.symbol}} {{invoice.amount_due}}</small></td>
                                <td class='text-danger'><small>{{invoice.currency.symbol}} {{invoice.amount}}</small></td>
                                <td class='text-danger'><small>{{invoice.user.username}}</small></td>
                                <td>
                                    <span>
                                        <a href="{% url 'finance:invoice_preview' invoice.id %}" class='btn btn-light btn-sm'>
                                            <i class='bx bx-show'></i>
                                        </a>
                                    </span>  
                                    <span>
                                        {% if request.user.role == 'admin' %}
                                            <a href={% url 'finance:update_invoice' invoice.id %} class="btn btn-light btn-sm text-success">
                                                <i class='bx bx-right-arrow'></i>
                                            </a>
                                        {% endif %}
                                    </span>
                                    <span>
                                        {% if request.user.role == 'admin' %}
                                            <button data-id={{invoice.id}} id='whatsappBtn' class="btn btn-light btn-sm text-success">
                                                <i class='bx bxl-whatsapp'></i>
                                            </button>
                                        {% endif %}
                                    </span>
                                    <span>
                                        {% if request.user.role == 'admin' %}
                                            <button class="btn btn-light btn-sm text-danger">
                                                <i class='bx bx-trash'></i>
                                            </button>
                                        {% endif %}
                                    </span>  
                                </td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                </tbody>  
            </table>
        </div>
        <div class="modal fade" id="loaderModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Sending invoice to WhatsApp...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="sideba d-flex flex-column mt-2 px-2 border rounded ">
        <h6 class="mt-1">Filter</h6>
        <form method='get' class='d-flex'>
            <select name="category" id="id_category" class='form-select'>
                <option value="">All</option>l
                <option value="paid">Paid</option>
                <option value="due">Due</option>
            </select>
                <button type="submit" class='btn btn-secondary btn-sm btn-flat'>
                    <i class='bx bx-filter'></i>
                </button>
        </form>  
        <form method='get' class='border d-flex justify-content-center mt-2'>
            <input hidden name='day' value='today'/>
            <button class='btn btn-large btn-flat'>Today</button>
        </form> 

        <form method='get' class='border d-flex justify-content-center mt-2'>
            <input hidden name='day' value='yesterday'/>
            <button class='btn btn-large btn-flat'>Yesterday</button>
        </form> 
        
        <form method='get' class='border d-flex justify-content-center mt-2'>
            <input hidden name='day' value='t_week'/>
            <button class='btn btn-large btn-flat'>This Week</button>
        </form> 

        <form method='get' class='border d-flex justify-content-center mt-2'>
            <input hidden name='day' value='l_week'/>
            <button class='btn btn-large btn-flat'>Last week</button>
        </form> 

        <form method='get' class='border d-flex justify-content-center mt-2'>
            <input hidden name='day' value='t_month'/>
            <button class='btn btn-large btn-flat'>This month</button>
        </form> 

        <form method='get' class='border d-flex justify-content-center mt-2'>
            <input hidden name='day' value='l_month'/>
            <button class='btn btn-large btn-flat'>Last month</button>
        </form> 

        <form method='get' class='border d-flex justify-content-center mt-2'>
            <input hidden name='day' value='t_year'/>
            <button class='btn btn-large btn-flat'>This year</button>
        </form> 
    </div>

    <div class="invoice-modal hidden">
        <div class="modal-content">
            {% include 'Pos/receipt.html'%}
        </div>
    </div>

    <div class="overlay hidden"></div>
</div>

<script src="{% static 'css/bootstrap/js/bootstrap.bundle.min.js'%}"></script>
<script type="text/javascript">
    const whatsappBtn = document.getElementById('whatsappBtn');
    const loaderModal = new bootstrap.Modal(document.getElementById('loaderModal'));

    whatsappBtn.addEventListener('click', function() {
        loaderModal.show(); 
        whatsappBtn.disabled = true; 

        const invoiceId = this.dataset.id;

        fetch(`/finance/send_invoice_whatsapp/${invoiceId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            loaderModal.hide();
            whatsappBtn.disabled = false;
        })
        .catch(error => {
            loaderModal.hide();
            whatsappBtn.disabled = false; 
            console.error('Error:', error);
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }




</script>
{% endblock content %}
