{% extends "base.html" %}
{% load static%}
{% load crispy_forms_tags %}
{% block title%} Update Invoice {% endblock%}
{% block content %}
   <div class="finance">
        <div class='update-invoice'>
            <div class="mt-2 d-flex align-items-center">
                <div class="px-2 h5 mt-2">
                    <span class="fw-bold">UPDATE INVOICE FOR {{invoice.customer.name}}</span>
                    <span class="fw-bold">AMOUNT DUE: {{invoice.currency.symbol}} {{invoice.amount_due}}</span>
                </div>
            </div>
            <div class="row">
                <div class="col-8">
                    <form method="post" class="mt-3 px-2">
                        {% csrf_token %}
                        {{form|crispy}}
                        <p id="id_amount_error" class="text-danger"></p>
                        <div class="d-flex justify-content-end">
                            <button type="button" onclick="updatePayment();" class="btn btn-success btn-sm">
                                <i class="bx bx-save"></i>
                                update
                            </button>
                        </div>
                    </form>
                </div>
                <div class="col-4">
                    <h5 class="mb-3">Payment Methods</h5>
                    <div class='button-choose w-100'>
                        <div class="w-100 p-2">
                            <button type="button"  class='btn btn-light btn-lg w-100 pm' data-name='cash' id="id_cash_btn">
                                CASH
                            </button>
                        </div>
        
                        <div class="w-100 mt-2 p-2">
                            <button type="button" class='btn btn-secondary btn-lg w-100 pm' data-name='bank' id="id_bank_transfer">
                                BANK CARD
                            </button>
                        </div>
        
                        <div class="w-100 mt-2 p-2">
                            <button type="button" class='btn btn-primary btn-lg w-100 pm' data-name='ecocash' id="id_credit_ecocash">
                                ECOCASH
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div> 
        <div class="modal fade" id="loaderModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Updating Invoice</p>
                    </div>
                </div>
            </div>
        </div>        
   </div> 
   
   <script src="{% static 'css/bootstrap/js/bootstrap.bundle.min.js'%}"></script>
   <script>
        let paymentMethod = 'cash'
        const error = document.querySelector('#id_amount_error')
        const loaderModal = new bootstrap.Modal(document.getElementById('loaderModal'));

        // payment methods
        document.querySelectorAll('.pm').forEach(button => {
            button.addEventListener('click', () => {
                console.log(button.dataset.name);
                if (button.dataset.name === 'cash') { 
                    paymentMethod = button.dataset.name
                } else if (button.dataset.name === 'ecocash'){
                    paymentMethod = button.dataset.name
                } else if (button.dataset.name === 'bank'){
                    paymentMethod = button.dataset.name
                }
            });
        });

        // update payment
        function updatePayment(){
            const invoice_id = {{invoice.id}}
            const data = {
                amount_paid: parseFloat(document.querySelector('#id_amount_paid').value),
                payment_method: paymentMethod
            }
            console.log(data, document.querySelector('#id_amount_paid').value)

            loaderModal.show(); 
    
            fetch(`/finance/invoice/update/${invoice_id}/`, {
                method: "POST",
                headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"), 
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loaderModal.hide()
                    window.location.href='{% url "finance:invoice" %}'
                } else {
                    loaderModal.hide()
                    error.textContent='*' + data.message
                }
            })
            .catch((error) => {
            console.error("Error:", error);
            });
    
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
              const cookies = document.cookie.split(";");
              for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + "=") {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
                }
              }
            }
            return cookieValue;
          }    
    
   </script> 
{% endblock %}