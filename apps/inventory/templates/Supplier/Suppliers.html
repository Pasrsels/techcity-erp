{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container">
    <div class="d-flex align-items-center justify-content-between mt-2 rounded bg-dark text-light shadow header py-2 mb-4">
        <h5 class="text-light px-1">Supplier List</h5>
        <!-- Add Supplier Button -->
        <div class="px-1">
            <button type="button" class="btn btn-primary btn-sm" id="addButton">
                <i class="bx bx-plus"></i> Add Supplier
            </button>
        </div>
    </div>

    <table id="supplier_list" class="table table-striped table-bordered" style="width: 100%;">
        <thead style="background-color: #3734f4; color: rgb(33, 29, 29);">
            <tr>
                <th>Name</th>
                <th>Products</th>
                <th>Contact Number</th>
                <th>Email</th>
                <th>Address</th>
                <th>Contact Person</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for supplier in suppliers %}
            <tr>
                <td><small>{{ supplier.name }}</small></td>
                <td>
                    <small>
                        {% if supplier.products.all %}
                        <ul class="list-unstyled">
                            {% for product in supplier.products.all %}
                                <li><small>{{ product.name }}</small></li>
                            {% endfor %}
                        </ul>
                        {% else %}
                            <small>No products listed</small>
                        {% endif %}
                    </small>
                </td>
                <td><small>{{ supplier.phone }}</small></td>
                <td><small>{{ supplier.email }}</small></td>
                <td><small>{{ supplier.address }}</small></td>
                <td><small>{{ supplier.contact_person }}</small></td>
                <td class="d-flex justify-content-start">
                    <!-- Edit Button -->
                    <button class="btn btn-sm btn-primary mx-1" onclick="openEditModal({{ supplier.id }})">
                        <i class="bx bx-edit"></i> Edit
                    </button>
                    <!-- View Button -->
                    <button class="btn btn-sm btn-info mx-1" onclick="openViewModal({{ supplier.id }})">
                        <i class="bx bx-show"></i> View
                    </button>
                    <!-- Delete Button -->
                    <button class="btn btn-sm btn-danger mx-1" onclick="confirmDelete({{ supplier.id }})">
                        <i class="bx bx-trash"></i> Delete
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- View Supplier Modal -->
    <div class="modal fade" id="viewSupplierModal" tabindex="-1" aria-labelledby="viewSupplierModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <h5 class="fw-bold">Supplier Details</h5>
                    <hr class="rounded">
                    <div id="viewSupplierDetails">
                        <!-- Details will be populated here -->
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Supplier Modal -->
    <div class="modal fade" id="editSupplierModal" tabindex="-1" aria-labelledby="editSupplierModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <h5 class="fw-bold">Edit Supplier </h5>
                    <hr class="rounded">
                    <form method="post" id="editSupplierForm">
                        {% csrf_token %}
                        {{ form | crispy }}
                        <div class="d-flex justify-content-end">
                            <button type="reset" class="btn btn-danger btn-sm bx bx-reset mx-2"></button>
                            <button type="submit" class="btn btn-secondary btn-sm">
                                <i class="bx bx-save"></i>
                                Save
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Supplier Modal -->
    <div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="loaderModalLabel" data-backdrop="static" data-keyboard="false" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <h5 class="fw-bold">Add Supplier</h5>
                    <hr class="rounded">
                    <form method="post" id="supplierForm">
                        {% csrf_token %}
                        {{ form | crispy }}
                        <div class="d-flex align-items-center justify-content-between">
                            <button type="reset" class="btn btn-danger btn-sm bx bx-reset mx-2"></button>
                            <button type="submit" class="btn btn-secondary btn-sm">
                                <i class="bx bx-save"></i>
                                Save
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteSupplierModal" tabindex="-1" aria-labelledby="deleteSupplierModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <h5 class="fw-bold">Delete Supplier</h5>
                    <hr class="rounded">
                    <p>Are you sure you want to delete this supplier?</p>
                    <div class="d-flex align-items-center justify-content-between">
                        <button type="button" class="btn btn-danger btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary btn-sm" id="confirmDeleteButton">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let supId = '';
    let deleteSupId = null;

    const addButton = document.getElementById('addButton');
    const supplierModal = new bootstrap.Modal(document.getElementById('addSupplierModal'));

    addButton.addEventListener('click', () => {
        supplierModal.show();
    });

    new DataTable('#supplier_list', {
        paging: false
    });

    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('supplierForm');

        form.addEventListener('submit', function (event) {
            event.preventDefault();

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            fetch('{% url "inventory:suppliers" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    supplierModal.hide()
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Supplier added successfully!',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        form.reset();
                        window.location.reload()
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: data.message,
                        confirmButtonText: 'Try Again'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Submission Failed',
                    text: 'There was an error submitting the form. Please try again.',
                    confirmButtonText: 'OK'
                });
            });
        });
    });

    function openEditModal(supplierId) {
        supId = supplierId;
        fetch(`/inventory/suppliers/edit/${supplierId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("id_name").value = data.data[0].name;
                document.getElementById("id_contact_person").value = data.data[0].contact_person;
                document.getElementById("id_phone").value = data.data[0].phone;
                document.getElementById("id_email").value = data.data[0].email;
                document.getElementById("id_address").value = data.data[0].address;

                const editModal = new bootstrap.Modal(document.getElementById('editSupplierModal'));
                editModal.show();
            })
            .catch(error => {
                console.error("Error fetching supplier data:", error);
                Swal.fire({
                    text: "Could not load supplier data. Please try again.",
                    icon: "error",
                    title: 'Error'
                });
            });
    }

    // Handling form submission for editing supplier data
    document.getElementById('editSupplierForm').addEventListener('submit', function (event) {
        event.preventDefault();  // Prevent default form submission

        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        fetch(`/inventory/suppliers/edit/${supId}/`, {
            method: 'POST',  
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(responseData => {
            console.log(responseData);
            if (responseData.success) { 
                // Hide modal and refresh the page or update the table
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editSupplierModal'));
                editModal.hide();
                Swal.fire({
                    text: "Supplier successfully updated",
                    icon: "success",
                    title: 'Success'
                }).then(() => {
                    window.location.reload(); 
                });
            } else {
                Swal.fire({
                    text: "Error updating supplier: " + responseData.message,
                    icon: "error",
                    title: 'Error'
                });
            }
        })
        .catch(error => console.error("Error updating supplier:", error));
    });

    // Function to trigger the confirmation modal for deletion
    function confirmDelete(supplierId) {
        deleteSupId = supplierId;
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteSupplierModal'));
        deleteModal.show();
    }

    // Handle the confirmation of deletion
    document.getElementById('confirmDeleteButton').addEventListener('click', function () {
        if (deleteSupId) {
            fetch(`/inventory/suppliers/delete/${deleteSupId}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
            })
            .then(response => response.json())
            .then(responseData => {
                if (responseData.success) {
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteSupplierModal'));
                    deleteModal.hide();
                    Swal.fire({
                        text: "Supplier successfully deleted.",
                        icon: "success",
                        title: 'Deleted'
                    }).then(() => {
                        window.location.reload(); 
                    });
                } else {
                    Swal.fire({
                        text: "Error deleting supplier: " + responseData.message,
                        icon: "error",
                        title: 'Error'
                    });
                }
            })
            .catch(error => {
                console.error("Error fetching supplier details:", error);
                Swal.fire({
                    text: "Could not load supplier details. Please try again.",
                    icon: "error",
                    title: 'Error'
                });
            });
    }
</script>

{% endblock %}
