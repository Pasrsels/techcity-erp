{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="suppliers">
    <div class="d-flex align-items-center justify-content-between rounded text-light shadow header py-2 mb-4" style="background: #373f4c;">
        <h5 class="text-light px-1">Supplier List</h5>
        <!-- Add Supplier Button -->
        <div class="px-1">
            <button type="button" class="btn btn-primary btn-sm" id="addButton">
                <i class="bx bx-plus"></i> Add Supplier
            </button>
        </div>
    </div>
    <table class="table table-striped table-bordered table-hover rounded p-2 mt-3 mt-2" id="supplier_list" style="width: 100%;">
        <thead>
            <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier List</title>
    <style>
        #supplier_list th {
            transition: transform 0.3s ease;
        }

        #supplier_list th:hover {
            transform: scale(1.1); /* Enlarges only the hovered th */
            cursor: pointer; /* Adds a pointer cursor for better UX */
        }
    </style>
            <tr>
                <th>Name</th>
                <th>Products</th>
                <th>Lifetime</th>
                <th>Next Due</th>
                <th>Returns</th>
                <th>Accounts Payable</th>
                <th>Accounts Receivable</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {%for supplier in suppliers%}
            <tr style="font-size:small; text-align: center;">
                <td >
                    <small>
                        <button style = "font-size: small;" class="btn btn-link p-0 m-0 text-primary" onclick="fetchSupplierDetails({{ supplier.id }})">
                            {%if supplier.delete == False%}
                                {{ supplier.name }}
                            {%endif%}
                        </button>
                    </small>
                </td>
                <td >
                    <small>
                        {% for product in products %}
                            {%if supplier in product.suppliers.all%}
                                {{product.category.name}},
                            {%endif%}
                        {% endfor %}
                    </small>
                </td>
                <td >
                    <small>
                        {% for life in life_time %}
                            {% for l, details in life.items %}
                                {%if supplier.id == l%}
                                    $
                                    {{details.amount}} [
                                    {{details.count}}x ]
                                {%endif%}
                            {%endfor%}
                        {% endfor %}
                    </small>
                </td>
                <td >
                    <small>
                        {%for dat in balances%}
                            {%if supplier.id == dat.supplier__id%}
                                {{dat.date}}
                            {%endif%}
                        {%endfor%}
                    </small>
                </td>
                <td >
                    <small>
                        {%for lt in life_time%}
                            {%for l, t in lt.items%}
                                {%if supplier.id == l%}
                                    {{t.returned}}/{{t.quantity}}
                                {%endif%}
                            {%endfor%}
                        {%endfor%}
                    </small>
                </td>
                <td >
                    <small>
                        {% for bal in balances %}
                            {% if supplier.id == bal.supplier__id%}
                                {% if bal.balance > 0 %}
                                    {{bal.currency__name}}
                                    {{ bal.balance }} |
                                {%else%}
                                    {{bal.currency__name}}0 |
                                {% endif %}
                            {%endif%}
                        {% endfor %}
                    </small>
                </td>
                <td >
                    <small>
                        {% for bal in balances %}
                            {% if supplier.id == bal.supplier__id%}
                                {% if bal.balance < 0 %}
                                    {{bal.currency__name}}
                                    {{ bal.balance }} |
                                {%else%}
                                    {{bal.currency__name}}0 |
                                {% endif %}
                            {%endif%}
                        {% endfor %}
                    </small>
                </td>
                
                <td >
                    
                    <button class="btn bx bx-play mx-1" style="color: green; font-size:medium;" onclick="openPaymentHistoryModal({{ supplier.id }})"></button>
                </td>
            </tr>
            {%endfor%}
        </tbody>
    </table>

<!--supplier details----------------------------------------------------------------------------------------------------------->
<div class="modal fade" id="supplierDetailsModal" tabindex="-1" aria-labelledby="supplierDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen">
        <div class="modal-content">
            <div class="modal-body" style="padding: 5;">
                <div class="finance d-flex flex-column" style="height: 100%;">
                    <!-- Heading for Supplier Details -->
                    <div class='px-2 py-2 bg-dark d-flex justify-content-between text-light align-items-center rounded'>
                        <div class='h5'>Supplier Details</div>
                        <div>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-dismiss="modal">
                                <i class="fas fa-times red-icon"></i>
                              </button>
                              
                        </div>
                    </div>
                    <!-- Upper Section (60%) split into two quarters: Supplier Details and Account Info + Purchase Order Count -->
                    <div class="top-section" style="flex: 6; display: flex; overflow-y: auto;">
                        <!-- Left Quarter: Supplier Details (40% of the whole height) -->
                        <div class="col-md-6 px-3" style="flex: 1; height: 80%; margin-top: 5px;">
                            <div class="text-center mb-2">
                                <i class="fas fa-user-circle" style="font-size: 30px; color: rgb(18, 201, 233);"></i>
                            </div>
                            <h5 class="fw-bold text-center mb-2" id="supplierDetailsName" style="font-size: 18px;"></h5>
                            <ul class="list-group" id="supplierDetailsList" style="text-align: left; font-size: 14px;"></ul>
                            <div class="d-flex justify-content-between mt-2">
                                <button class="btn btn-primary btn-sm mx-1" style="background-color: rgb(18, 201, 233);" onclick="openEditModal()">Edit</button>
                                <button class="btn btn-danger btn-sm mx-1" style="background-color: red;" onclick="confirmDelete()">
                                    <i class="fas fa-trash"></i>
                                  </button>
                                  
                            </div>
                        </div>

                        <!-- Right Quarter: Account Info + Purchase Order Count (20% of the whole height) -->
                        <div class="col-md-6 px-3" style="flex: 1; height: 100%;">
                            <div class="row" style="height: 100%;">

                                <!-- Account Info Section (reduced size) -->
                                <div class="col-md-12 mb-3" style="height: 100px; margin-top: 80px; margin-bottom: 50px ;">
                                    <div class="card shadow" style="height: 100%;">
                                        <div class="card-body">
                                            <h6>Account</h6>
                                            <h6 class="text-center fw-bold">
                                                <span id="account_balance">
                                                    
                                                </span>
                                            </h6>
                                        </div>
                                    </div>
                                </div>
                                

                                <!-- Purchase Order Count Section (reduced size) -->
                                <div class="col-md-12" style="height: 50%;">
                                    <div class="card shadow" style="height: 50%;">
                                        <div class="card-body">
                                            <h6>Purchase Order Count</h6>
                                            <h6 class="text-center text-muted fw-bold" id="purchase_countO">
                                                <!-- {% with 0 as purchase_order_count %}
                                                    {% for life in life_time %}
                                                        {% for l, details in life.items %}
                                                            {% if supplier.id == l %}
                                                                {% with details.count as purchase_order_count %}
                                                                {% endwith %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endfor %}
                                                    {{ purchase_order_count }}
                                                {% endwith %} -->
                                            </h6>
                                        </div>
                                    </div>
                                </div>
                                </div>
                        </div>
                    </div>

                    <!-- Bottom Section (40%) -->
                    <div class="bottom-section" style="flex: 4; overflow-y: auto;">
                        <!-- Navigation Section -->
                        <div class="mt-3 mb-3">
                            <nav class="recent-nav navbar navbar-expand-lg navbar-light bg-dark text-light px-2">
                                <ul class="navbar-nav items mr-auto">
                                    <li class="nav-item" data-name="supplier_payment_history" id="supplier_tab">
                                        <a href="#" class="nav-link text-light">Supplier Payment History</a>
                                    </li>
                                    <li class="nav-item px-2" data-name="purchase_orders" id="purchase_tab">
                                        <a href="#" class="nav-link text-light">Purchase Order</a>
                                    </li>
                                </ul>
                                <div class="ms-auto">
                                    <button type="button" class="btn btn-primary btn-sm" id="p_history_btn">Proceed to Payment</button>
                                </div>
                            </nav>
                            <!-- Underline for active tab -->
                            <div class="underline bg-primary" id="active-underline"></div>
                        </div>
                        
                        <!-- Payment History Table -->
                        <div id="supplier_payment_section">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Order Name</th>
                                        <th>Amount</th>
                                        <th>Paid</th>
                                        <th>Account Balance</th>
                                        <th>Accounts Payable</th>
                                        <th>Accounts Receivable</th>
                                        <th>User</th>
                                    </tr>
                                </thead>
                                <tbody id="usd_payment_history">
                                    <tr>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Purchase Order Table -->
                        <div id="purchase_order_section" style="display: none;">
                            <div class="mt-2 w-100">
                                <table class='table table-bordered' id='order_table' style="width: 100%;">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Delivery Date</th>
                                            <th>Batch</th>
                                            <th>Supplier</th>
                                            <th>Total Cost</th>
                                            <th>Notes</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="8">No data available</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <style>
                            /* Style for the active underline */
                            .underline {
                                height: 4px;
                                width: 0;
                                transition: 0.3s ease-in-out;
                                position: relative;
                                margin-top: -2px;
                            }
                        
                            .nav-item.active {
                                font-weight: bold;
                            }
                        
                            /* Adjusting borders in Purchase Order Table */
                            #order_table th, #order_table td {
                                border: 1px solid #dee2e6 !important; /* Add visible divisions */
                            }
                        </style>
                        
                       
                        
                                   
                        <!-- <div id="zigTable" style="display: none;">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Order name</th>
                                        <th>Amount</th>
                                        <th>Paid</th>
                                        <th>Account balance</th>
                                        <th>Accounts Payable</th>
                                        <th>Accounts Receivable</th>
                                        <th>User</th>
                                    </tr>
                                </thead>
                                <tbody id="zig_payment_table"></tbody>
                            </table>
                        </div> -->
                    <!-- </div>
                </div>
            </div>
        </div>
    </div>
</div> -->

<!--------------------------------------------------------------------------------------------------------->>    
    <!-- Edit Supplier Modal -->
    <div class="modal fade" id="editSupplierModal" tabindex="-1" aria-labelledby="editSupplierModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <h5 class="fw-bold">Edit Supplier </h5>
                    <hr class="rounded">
                    <form method="post" id="editSupplierForm">
                        {% csrf_token %}
                        {{ form | crispy }}
                        <div class="d-flex justify-content-end">
                            <button type="reset" class="btn btn-danger btn-sm bx bx-reset mx-2"></button>
                            <button type="submit" class="btn btn-secondary btn-sm">
                                <i class="bx bx-save"></i>
                                Save
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Supplier Modals -->
    <div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="loaderModalLabel" data-backdrop="static" data-keyboard="false" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <h5 class="fw-bold">Add Supplier</h5>
                    <hr class="rounded">
                    <form method="post" id="supplierForm">
                        {% csrf_token %}
                        {{ form | crispy }}
                        <div class="d-flex align-items-center justify-content-between">
                            <button type="reset" class="btn btn-danger btn-sm bx bx-reset mx-2"></button>
                            <button type="submit" class="btn btn-secondary btn-sm">
                                <i class="bx bx-save"></i>
                                Save
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteSupplierModal" tabindex="-1" aria-labelledby="deleteSupplierModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <h5 class="fw-bold">Delete Supplier</h5>
                    <hr class="rounded">
                    <p>Are you sure you want to delete this supplier?</p>
                    <div class="d-flex align-items-center justify-content-between">
                        <button type="button" class="btn btn-danger btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary btn-sm" id="confirmDeleteButton">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h5 class="fw-bold">Add Payment</h5>
                <hr class="rounded">
                <form method="post" id="paymentForm">
                    {% csrf_token %}
                    <!-- Currency and Next Due -->
                    <div class="mb-3 d-flex align-items-center">
                        <div class="me-3" style="flex: 1;">
                            <label for="currency" class="form-label">Currency</label>
                            <select class="form-control" id="currency" name="currency">
                                <option value="USD">USD Dollar</option>
                                <option value="ZiG">ZiG</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label for="next_due" class="form-label">Next Due</label>
                            <input type="text" class="form-control" id="next_due" name="next_due" readonly value="--">
                        </div>
                    </div>
                
                    <!-- Payment Method -->
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">Payment Method</label>
                        <select class="form-control" id="payment_method" name="payment_method" required>
                            <option value="">Select Payment Method</option>
                            <option value="Ecocash">Ecocash</option>
                            <option value="Cash">Cash</option>
                            <option value="ZimSwitch">ZimSwitch</option>
                            <option value="MasterCard">MasterCard</option>
                            <option value="Visa">Visa</option>
                        </select>
                    </div>
                
                    <!-- Amount and USD Value -->
                    <div class="mb-3 d-flex align-items-center">
                        <div class="me-3" style="flex: 1;">
                            <label for="amount" class="form-label">Amount</label>
                            <input type="number" class="form-control" id="amount" name="amount" required>
                        </div>
                        <div style="flex: 1;">
                            <label for="usd_value" class="form-label">USD Value</label>
                            <input type="text" class="form-control" id="usd_value" name="usd_value" readonly value="--">
                        </div>
                    </div>
                
                    <!-- Buttons -->
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary btn-sm mx-2" data-bs-dismiss="modal">Close</button>
                        <button type="reset" class="btn btn-danger btn-sm mx-2">Reset</button>
                        <button type="button" class="btn btn-primary btn-sm">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>



<!-- Payment History Modal -->
<div class="modal fade" id="paymentHistoryModal" tabindex="-1" aria-labelledby="paymentHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <!-- Heading -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold">Payment History</h5>
                    <div class="d-flex" >
                        <p class="mx-2">
                            <span id="id_balance"></span>
                        </p>
                        <p>
                            <span id="id_deposit"></span>
                        </p>
                    </div>
                </div>
                <hr class="rounded">
                <!-- Proceed to Payment and Balance Owed -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <!-- Proceed to Payment Button -->
                    <button type="button" class="btn btn-primary btn-sm" id="p_history_btn">Proceed to Payment</button>
                </div>
                <!-- Tables -->
                <div id="usdTable">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Order name</th>
                                <th>Amount</th>
                                <th>Paid</th>
                                <th>Account balance</th>
                                <th>Accounts Payable</th>
                                <th>Accounts Receivable</th>
                                <th>User</th>
                            </tr>
                        </thead>
                        <tbody id="usd_payment_history"></tbody>
                    </table>
                </div>
                <div id="zigTable" style="display: none;">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Order name</th>
                                <th>Amount</th>
                                <th>Paid</th>
                                <th>Account balance</th>
                                <th>Accounts Payable</th>
                                <th>Accounts Receivable</th>
                                <th>User</th>
                            </tr>
                        </thead>
                        <tbody id="zig_payment_table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>



<script>
    
    let supId = '';
    let deleteSupId = null;
    let editSupId = null;
    let historyData = []

    const historyBtn = document.querySelectorAll('#p_history_btn');
    const addButton = document.getElementById('addButton');
    const supplierModal = new bootstrap.Modal(document.getElementById('addSupplierModal'));
    // const supPaymentModal = new bootstrap.Modal(document.getElementById('supPaymentModal'));
    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
    const paymentHistoryModal = new bootstrap.Modal(document.getElementById('paymentHistoryModal'));
    const navButtons = document.querySelectorAll('.nav-item');
  
    addButton.addEventListener('click', () => {
        supplierModal.show();
    });

    historyBtn.forEach((b)=>{
        console.log(b, 'Button')
        b.addEventListener('click', () => {
            paymentHistoryModal.hide()
            paymentModal.show()
        });
    })
    new DataTable('#supplier_list', {
            paging: false,
    });

        
    const amountInput = document.getElementById('amount');
    const currencySelect = document.getElementById('currency');

    // Listen for changes to amount and currency  
    amountInput.addEventListener('input', ()=>{
        updateUsdValue()
    }
    
    );
    currencySelect.addEventListener('change', ()=>{
        updateUsdValue()
    });

    function updateUsdValue() {
        
        const usdValueInput = document.getElementById('usd_value');
        const amount = parseFloat(amountInput.value) || 0;
        const currency = currencySelect.value;
                
        if (currency === 'ZiG') {
            usdValueInput.value = (amount / 30).toFixed(2); // Convert to USD equivalent
        } else if (currency === 'USD') {
                usdValueInput.value = amount.toFixed(2); // Display the same amount
            } 
        else {
            usdValueInput.value = '--'; // Default value if no valid currency selected
            }
        }                


    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('supplierForm');

        form.addEventListener('submit', function (event) {
            event.preventDefault();

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            fetch('{% url "inventory:suppliers" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    supplierModal.hide()
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Supplier added successfully!',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        form.reset();
                        window.location.reload()
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: data.message,
                        confirmButtonText: 'Try Again'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Submission Failed',
                    text: 'There was an error submitting the form. Please try again.',
                    confirmButtonText: 'OK'
                });
            });
        });
    });

    // Payment History Modal
    function openPaymentHistoryModal(supplierId) {
        paymentHistoryModal.show();
        fetch(`/inventory/suppliers/payment-history/${supplierId}/`,
            {
                method:'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            }
        )
        .then(response=>response.json())
        .then(data=>{
            if (data.success){
                console.log('supplier data', data)

                // assign to global
                historyData = data.history

                // assign to respective elements
                document.getElementById('id_balance').textContent = `${data.history[0].account_currency} Balance ${data.history[0].account_balance}`
                
            }else{
                Swal.fire({
                    icon:'error',
                    title:'Error',
                    text:'Failed to fetch supplier payment data.'
                })
            }
            
        })
    }

    // Payment Modal
    function openPaymentModal() {
        paymentModal.show();
        supplierDetailsModal.hide();
    }

    const displayData = (data) => {
        const usdTable = document.getElementById('usd_payment_history')
        const zigTable = document.getElementById('zig_payment_table')

        usdTable.innerHTML = ''
        zigTable.innerHTML = ''

        data.forEach((supplier)=>{
            if(supplier.currency__name == 'USD'){
                usdTable.innerHTML += `
                    <tr>
                        <td>${ new Date(supplier.timestamp).toLocaleDateString() }</td>
                        <td>${ supplier.amount }</td>
                        <td>${ supplier.account__balance }</td>
                        <td>${ supplier.user__username }</td>
                    </tr>
                `
            }else{
                zigTable.innerHTML += `
                    <tr>
                        <td>${ new Date(supplier.timestamp).toLocaleDateString() }</td>
                        <td>${ supplier.amount }</td>
                        <td>${ supplier.account__balance }</td>
                        <td>${ supplier.user__username }</td>
                    </tr>
                `
            }
        })
    }
    // Toggle between USD and ZiG tables in the Payment History Modal
    // document.getElementById('toggleCurrencyButton').addEventListener('click', function() {
    //         const usdTable = document.getElementById('usdTable');
    //         const zigTable = document.getElementById('zigTable');
    //         if (usdTable.style.display === 'none') {
    //             usdTable.style.display = 'block';
    //             zigTable.style.display = 'none';
    //             this.textContent = 'Switch to ZiG';
    //         } else {
    //             usdTable.style.display = 'none';
    //             zigTable.style.display = 'block';
    //             this.textContent = 'Switch to USD';
    //         }
    //     });


                            // JavaScript for toggling between sections
                            const supplierTab = document.getElementById("supplier_tab");
                            const purchaseTab = document.getElementById("purchase_tab");
                            const supplierSection = document.getElementById("supplier_payment_section");
                            const purchaseSection = document.getElementById("purchase_order_section");
                            const underline = document.getElementById("active-underline");
                        
                            function moveUnderline(tab) {
                                const rect = tab.getBoundingClientRect();
                                underline.style.width = `${rect.width}px`;
                                underline.style.left = `${tab.offsetLeft}px`;
                            }
                        
                            function setActiveTab(activeTab) {
                                document.querySelectorAll(".nav-item").forEach(tab => tab.classList.remove("active"));
                                activeTab.classList.add("active");
                                moveUnderline(activeTab);
                            }
                        
                            supplierTab.addEventListener("click", function (e) {
                                e.preventDefault();
                                supplierSection.style.display = "block";
                                purchaseSection.style.display = "none";
                                setActiveTab(this);
                            });
                        
                            purchaseTab.addEventListener("click", function (e) {
                                e.preventDefault();
                                supplierSection.style.display = "none";
                                purchaseSection.style.display = "block";
                                setActiveTab(this);
                            });
                        
                            // Initialize with default active tab
                            window.onload = function () {
                                setActiveTab(supplierTab);
                            };
                       

    // Function to open the edit modal and populate it with supplier data
    function openEditModal() {
        fetch(`/inventory/suppliers/edit/${editSupId}/`)  // Adjust this URL to match your actual endpoint
            .then(response => response.json())
            .then(data => {
                console.log(data, 'supplier');
                // Populate form fields with supplier data
                document.getElementById("id_name").value = data.data[0].name;
                document.getElementById("id_contact_person").value = data.data[0].contact_person;
                document.getElementById("id_phone").value = data.data[0].phone;
                document.getElementById("id_email").value = data.data[0].email;
                document.getElementById("id_address").value = data.data[0].address;

                // Show the modal
                const editModal = new bootstrap.Modal(document.getElementById('editSupplierModal'));
                editModal.show();
            })
            .catch(error => {
                console.error("Error fetching supplier data:", error);
                Swal.fire({
                    text: "Could not load supplier data. Please try again.",
                    icon: "error",
                    title: 'Error'
                });
            });
    }

    // Handling form submission for editing supplier data
    document.getElementById('editSupplierForm').addEventListener('submit', function (event) {
        event.preventDefault();  // Prevent default form submission
        console.log('here',editSupId)
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        fetch(`/inventory/suppliers/edit/${editSupId}/`, {
            method: 'POST',  
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(responseData => {
            console.log(responseData);
            if (responseData.success) { 
                // Hide modal and refresh the page or update the table
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editSupplierModal'));
                editModal.hide();
                Swal.fire({
                    text: "Supplier successfully updated",
                    icon: "success",
                    title: 'Success'
                }).then(() => {
                    window.location.reload(); 
                });
            } else {
                Swal.fire({
                    text: "User: " + responseData.message,
                    icon: "warning",
                    title: 'Access denied'
                });
            }
        })
        .catch(error => console.error("Error updating supplier:", error));
    });

    // Function to trigger the confirmation modal for deletion
    function confirmDelete() {
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteSupplierModal'));
        deleteModal.show();
    }

    // Handle the confirmation of deletion
    document.getElementById('confirmDeleteButton').addEventListener('click', function () {
        console.log('here',deleteSupId)

        if (deleteSupId) {
            fetch(`/inventory/suppliers/delete/${deleteSupId}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
            })
            .then(response => response.json())
            .then(responseData => {
                if (responseData.success) {
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteSupplierModal'));
                    deleteModal.hide();
                    Swal.fire({
                        text: "Supplier successfully deleted.",
                        icon: "success",
                        title: 'Deleted'
                    }).then(() => {
                        window.location.reload(); 
                    });
                } else {
                    Swal.fire({
                        text: "User: " + responseData.message,
                        icon: "warning",
                        title: 'Failed to delete'
                    });
                }
            })
            .catch(error => {
                console.error("Error deleting supplier:", error);
                Swal.fire({
                    text: "There was an error deleting the supplier. Please try again.",
                    icon: "error",
                    title: 'Error'
                });
            });
        }
    })
    
    // supplier details in a modal when we click name in the supplier listt
    function fetchSupplierDetails(supplierId) {
        deleteSupId = supplierId;
        editSupId = supplierId;
        fetch(`/inventory/suppliers/supplier-information/${supplierId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate modal with supplier details
                    const modalTitle = document.getElementById('supplierDetailsName');
                    const detailsList = document.getElementById('supplierDetailsList');
                    
                    modalTitle.textContent = data.supplier_data.name; // Set the supplier name
                    detailsList.innerHTML = `
                        <style>
                            .list-group-item a {
                                text-decoration: none; /* Remove underline by default */
                                color: inherit; /* Inherit text color */
                            }

                            .list-group-item a:hover {
                                text-decoration: underline; /* Add underline on hover */
                                color: blue; /* Change color on hover (optional) */
                                cursor: pointer; /* Show pointer cursor on hover */
                            }
                        </style>

                            <ul class="list-group">
                                <li class="list-group-item">
                                    <i class="fas fa-user" style="color: blue; margin-right: 10px;"></i> ${data.supplier_data.contact_person}
                                </li>
                                <li class="list-group-item">
                                    <i class="fas fa-phone" style="color: green; margin-right: 10px;"></i> 
                                    <a href="tel:${data.supplier_data.phone}">${data.supplier_data.phone}</a>
                                </li>
                                <li class="list-group-item">
                                <i class="fab fa-whatsapp" style="color: green; margin-right: 10px;"></i> 
                                <a 
                                    href="https://wa.me/${data.supplier_data.phone}" 
                                    target="_blank" 
                                    style="text-decoration: none; color: inherit;">
                                    Chat on WhatsApp
                                </a>
                            </li>


                                <li class="list-group-item">
                                    <i class="fas fa-envelope" style="color: red; margin-right: 10px;"></i> 
                                    <a href="mailto:${data.supplier_data.email}">${data.supplier_data.email}</a>
                                </li>
                                <li class="list-group-item">
                                    <i class="fas fa-map-marker-alt" style="color: orange; margin-right: 10px;"></i> ${data.supplier_data.address}
                                </li>
                            </ul>

                        `;
                    // Show modal
                    const supplierDetailsModal = new bootstrap.Modal(document.getElementById('supplierDetailsModal'));
                    supplierDetailsModal.show();

                    accountBalances(supplierId)
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to fetch supplier details.',
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching supplier details:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'There was an issue fetching the supplier details. Please try again.',
                });
            });
    }

     navButtons.forEach((btn)=>{
        btn.addEventListener(
            'click', ()=>{
                navButtons.forEach(b => b.classList.remove('active')); 
                event.target.classList.add('active'); 
                show(btn.dataset.name)
            }
        )
    })

     

    document.addEventListener("DOMContentLoaded", () => {
    // Get references to the tables
    const paymentHistoryTable = document.getElementById("paymentHistoryTable"); // Payment History Table
    const purchaseOrderTable = document.getElementById("purchaseOrderTable"); // Purchase Order Table
    const proceedToPaymentBtn = document.getElementById("p_history_btn"); // Proceed to Payment Button

    // Check if the necessary elements exist
    if (!paymentHistoryTable || !purchaseOrderTable || !proceedToPaymentBtn) {
        console.error("Missing required elements.");
        return;
    }

    // Fetch Payment History data (AJAX)
    fetch('/path/to/payment-history/')
        .then(response => response.json())
        .then(data => {
            const tableBody = paymentHistoryTable.querySelector('tbody');
            tableBody.innerHTML = ''; // Clear existing rows
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.date}</td>
                    <td>${item.order_name}</td>
                    <td>${item.amount}</td>
                    <td>${item.paid}</td>
                    <td>${item.account_balance}</td>
                    <td>${item.accounts_payable}</td>
                    <td>${item.accounts_receivable}</td>
                    <td>${item.user}</td>
                `;
                tableBody.appendChild(row);
            });
        })
        .catch(error => console.error("Error fetching payment history:", error));
        document.querySelector().addEventListener('input', ()=>{
        const search_q = document.querySelector().value
        let filteredData = transactionsData[0].filter((data)=>{
            return(data.invoice_number.includes(search_q))
        })
        transactionsTable.innerHTML=''
        displayTransactionTable(filteredData)
    })

    // Fetch Purchase Orders data (AJAX)
    fetch('/path/to/purchase-orders/')
        .then(response => response.json())
        .then(data => {
            const tableBody = purchaseOrderTable.querySelector('tbody');
            tableBody.innerHTML = ''; // Clear existing rows
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.order_date}</td>
                    <td>${item.delivery_date}</td>
                    <td>${item.batch.toLowerCase()}</td>
                    <td>${item.supplier.name}</td>
                    <td>${item.total_cost}</td>
                    <td>${item.notes}</td>
                    <td>${item.status}</td>
                    <td>
                        <a href="${item.detail_url}" class="btn bx bx-show"></a>
                        <a href="${item.print_url}" class="btn bx bx-printer mx-1"></a>
                        ${item.status !== 'received' ? `<button class="btn btn-sm btn-light" onclick="changeStatus(${item.id})">Change Status</button>` : ''}
                        <a href="${item.edit_url}" class="btn btn-outline-dark btn-sm bx bx-edit"></a>
                        <button class="btn bx bx-trash btn-outline-dark btn-sm" onclick="confirmDeletePurchaseOrder(${item.id})"></button>
                        <button class="btn btn-outline-primary btn-sm bx bx-user" onclick="showSupplierDetails(${item.id})"></button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        })
        .catch(error => console.error("Error fetching purchase orders:", error));

    // Event listener for "Proceed to Payment" button
    proceedToPaymentBtn.addEventListener("click", () => {
        alert("Proceeding to Payment...");
        // Add AJAX or backend interaction logic here to proceed with the payment
        fetch("/path/to/proceed-to-payment/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"), // Assumes CSRF token handling
            },
            body: JSON.stringify({ action: "proceed_to_payment" }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Payment successfully processed!");
            } else {
                alert("Payment processing failed.");
            }
        })
        .catch(error => console.error("Error:", error));
    });

    // Handle changing status (AJAX)
    window.changeStatus = (orderId) => {
        fetch(`/path/to/change-status/${orderId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ action: "change_status" }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Order status updated.");
                location.reload(); // Optionally reload page to reflect changes
            } else {
                alert("Failed to update status.");
            }
        })
        .catch(error => console.error("Error changing status:", error));
    };

    // Handle deleting purchase order (AJAX)
    window.confirmDeletePurchaseOrder = (orderId) => {
        if (confirm("Are you sure you want to delete this purchase order?")) {
            fetch(`/path/to/delete-purchase-order/${orderId}/`, {
                method: "DELETE",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Purchase order deleted.");
                    location.reload(); // Reload page to reflect changes
                } else {
                    alert("Failed to delete purchase order.");
                }
            })
            .catch(error => console.error("Error deleting purchase order:", error));
        }
    };

    // Show supplier details in modal or on a new page (AJAX)
    window.showSupplierDetails = (orderId) => {
        fetch(`/path/to/supplier-details/${orderId}/`)
            .then(response => response.json())
            .then(data => {
                // Show supplier details in a modal or another part of the page
                alert("Supplier Details: " + JSON.stringify(data));
            })
            .catch(error => console.error("Error fetching supplier details:", error));
    };
});

    const accountBalances = (supplierId) => {
        console.log(supplierId)
        // {% for bal in balances %}
        //     {% if supplier.id == bal.supplier__id %}
        //         document.getElementById('account_balance').innerText = {{ bal.currency__name }} + {{ bal.balance }}
        //         if({{ bal.balance }} < 0){
        //             document.getElementById('account_balance').classList.add('text-danger') 
        //         }else{
        //             document.getElementById('account_balance').classList.remove('text-danger') 
        //         }
        //     {% endif %}
        // {% endfor %}
        fetch(`/inventory/suppliers/supplier-information/${supplierId}/`, {
            method:'GET'
        })
        .then(response => response.json())
        .then(data => {
            console.log(data.account_data, 'account data')
            console.log(data.purchase_order_count,'purchse_order_count')
            if(data.success){
                const accountEl = document.getElementById('account_balance')
                const purchaseordercount = document.getElementById('purchase_countO')
                accountEl.innerHTML = `${data.account_data[0].currency} ${data.account_data[0].balance} <br> ${data.account_data[1].currency} ${data.account_data[1].balance} `
                purchaseordercount.innerHTML = `${data.purchase_order_count}`
            }
            else{
                Swal.fire({
                    icon:'error',
                    text: data.messsage,
                    title: 'Error'
                })
            }
    })
        .catch((error)=>{
            console.log(error)
        })
    }


    // Utility function to get the CSRF token from cookies
    function getCSRFToken() {
        let cookieValue = null;
        const name = 'csrftoken';
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
