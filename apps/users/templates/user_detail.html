{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block title %} User Details {% endblock %}
{% block content %}
<div class="py-2">
  <!-- Page Header -->
  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <h4 class="mb-0">User Profile</h4>
      <div>
        <button id="editUser" class="btn btn-primary btn-sm" data-user-id="{{ user.id }}">
          <i class="bx bx-edit me-1"></i>Edit Details
        </button>
        <button id="ViewUserPermission" class="btn btn-outline-primary btn-sm ms-2" data-user-id="{{ user.id }}">
          <i class="bx bx-shield me-1"></i>Manage Permissions
        </button>
      </div>
    </div>
  </div>
  <!-- User Profile Card -->
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">{{ user.first_name }} {{ user.last_name }}</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <!-- Profile Image Column -->
        <div class="col-md-3 text-center mb-4 mb-md-0">
          <div class="position-relative d-inline-block">
            <img 
              src="{% if user.profile.profile_image %}{{ user.profile.profile_image.url }}{% else %}{% static 'assets/avatar.png' %}{% endif %}" 
              alt="Profile Picture" 
              class="img-thumbnail rounded-circle" 
              style="width: 150px; height: 150px; object-fit: cover;">
          </div>
          <div class="user-code mt-3 p-2 bg-light rounded">
            <small class="text-muted d-block">USER CODE</small>
            <span class="fw-bold">{{ user.code }}</span>
          </div>
        </div>
    <!-- Personal Details Column -->
    <div class="col-md-4 mb-4 mb-md-0">
      <h6 class="text-primary border-bottom pb-2 mb-3">Personal Details</h6>
      <div class="mb-2">
        <small class="text-muted d-block">Full Name</small>
        <span>{{ user.first_name }} {{ user.last_name }}</span>
      </div>
      <div class="mb-2">
        <small class="text-muted d-block">Email Address</small>
        <span>{{ user.email }}</span>
      </div>
      <div class="mb-2">
        <small class="text-muted d-block">Phone Number</small>
        <span>{{ user.phonenumber }}</span>
      </div>
    </div>
    
    <!-- Work Details Column -->
    <div class="col-md-5">
      <h6 class="text-primary border-bottom pb-2 mb-3">Work Information</h6>
      <div class="row">
        <div class="col-6 mb-2">
          <small class="text-muted d-block">Company</small>
          <span>{{ user.company }}</span>
        </div>
        <div class="col-6 mb-2">
          <small class="text-muted d-block">Branch</small>
          <span>{{ user.branch }}</span>
        </div>
        <div class="col-6 mb-2">
          <small class="text-muted d-block">Role</small>
          <span>{{ user.role }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
  </div>
</div>
<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="post" id="userEditForm">
          {% csrf_token %}
          <div class="row">
            <div class="col-md-6">
              {{ form.first_name|as_crispy_field }}
            </div>
            <div class="col-md-6">
              {{ form.last_name|as_crispy_field }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              {{ form.username|as_crispy_field }}
            </div>
            <div class="col-md-6">
              {{ form.email|as_crispy_field }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              {{ form.phonenumber|as_crispy_field }}
            </div>
            <div class="col-md-6">
              {{ form.company|as_crispy_field }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              {{ form.branch|as_crispy_field }}
            </div>
            <div class="col-md-6">
              {{ form.role|as_crispy_field }}
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="reset" form="userEditForm" class="btn btn-outline-danger">
          <i class="bx bx-reset me-1"></i>Reset
        </button>
        <button type="submit" form="userEditForm" class="btn btn-primary">
          <i class="bx bx-save me-1"></i>Save Changes
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Permissions Modal -->
<div class="modal fade" id="ViewUserPermissionsModal" tabindex="-1" aria-labelledby="ViewUserPermissionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ViewUserPermissionModalLabel">User Permissions</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>Category</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="Permission-data">
              <!-- Permission data will be loaded here -->
            </tbody>
          </table>
        </div>
        <div id="permissions-loading" class="text-center py-4 d-none">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <div id="permissions-empty" class="text-center py-4 d-none">
          <p class="text-muted mb-0">No permissions assigned yet</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="addPermissionBtn">
          <i class="bx bx-plus me-1"></i>Add Permission
        </button>
      </div>
    </div>
  </div>
</div>
{% block extra_js %}
<script src="{% static 'css/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals
    const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
    const permissionsModal = new bootstrap.Modal(document.getElementById('ViewUserPermissionsModal'));
    
    // User edit functionality
    const editUserBtn = document.getElementById('editUser');
    if (editUserBtn) {
      editUserBtn.addEventListener('click', function() {
        const userId = this.getAttribute('data-user-id');
        loadUserData(userId);
      });
    }

    // Load user data function
    function loadUserData(userId) {
      const url = "{% url 'users:ajax_get_user_data' 0 %}".replace('0', userId);
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          document.querySelector('#editUserModal input[name="first_name"]').value = data.first_name;
          document.querySelector('#editUserModal input[name="last_name"]').value = data.last_name;
          document.querySelector('#editUserModal input[name="username"]').value = data.username;
          document.querySelector('#editUserModal input[name="email"]').value = data.email;
          document.querySelector('#editUserModal input[name="phonenumber"]').value = data.phonenumber;
          
          const companySelect = document.querySelector('#editUserModal select[name="company"]');
          const branchSelect = document.querySelector('#editUserModal select[name="branch"]');
          const roleSelect = document.querySelector('#editUserModal select[name="role"]');
          
          if (companySelect) companySelect.value = data.company;
          if (branchSelect) branchSelect.value = data.branch;
          if (roleSelect) roleSelect.value = data.role;
          
          editModal.show();
        })
        .catch(error => {
          console.error('Error loading user data:', error);
          showToast('Error loading user data', 'danger');
        });
    }

    // Company/Branch dependency
    const companySelect = document.querySelector('#id_company');
    if (companySelect) {
      companySelect.addEventListener('change', function() {
        const url = "{% url 'users:ajax_load_branches' %}";
        const companyId = this.value;
        
        fetch(`${url}?company_id=${companyId}`)
          .then(response => response.json())
          .then(data => {
            const branchSelect = document.querySelector('#id_branch');
            branchSelect.innerHTML = '';
            
            data.forEach(branch => {
              const option = document.createElement('option');
              option.value = branch.id;
              option.textContent = branch.name;
              branchSelect.appendChild(option);
            });
          })
          .catch(error => {
            console.error('Error loading branches:', error);
          });
      });
    }

    // Permissions management
    const viewPermissionsBtn = document.getElementById('ViewUserPermission');
    if (viewPermissionsBtn) {
      viewPermissionsBtn.addEventListener('click', function() {
        const userId = this.getAttribute('data-user-id');
        loadUserPermissions(userId);
        permissionsModal.show();
      });
    }

    // Load user permissions
    function loadUserPermissions(userId) {
      const permissionsTable = document.getElementById('Permission-data');
      const loadingElement = document.getElementById('permissions-loading');
      const emptyElement = document.getElementById('permissions-empty');
      
      permissionsTable.innerHTML = '';
      loadingElement.classList.remove('d-none');
      emptyElement.classList.add('d-none');
      
      const url = "{% url 'users:userPermissionsUD' 0 %}".replace('0', userId);
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          loadingElement.classList.add('d-none');
          
          if (data.success && data.data.length > 0) {
            data.data.forEach(item => {
              permissionsTable.innerHTML += `
                <tr>
                  <td>${item.username}</td>
                  <td><span class="badge bg-light text-dark">${item.category}</span></td>
                  <td class="text-end">
                    <button class="btn btn-sm btn-outline-danger" onclick="removePermission(${item.id})">
                      <i class="bx bx-trash"></i>
                    </button>
                  </td>
                </tr>
              `;
            });
          } else {
            emptyElement.classList.remove('d-none');
          }
        })
        .catch(error => {
          console.error('Error loading permissions:', error);
          loadingElement.classList.add('d-none');
          showToast('Error loading permissions', 'danger');
        });
    }
    
    // Make removePermission global for onclick handler
    window.removePermission = function(itemId) {
      if (confirm('Are you sure you want to remove this permission?')) {
        const url = "{% url 'users:userPermissionsUD' 0 %}".replace('0', itemId);
        
        fetch(url, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast('Permission removed successfully', 'success');
            // Reload permissions after deletion
            const userId = document.getElementById('ViewUserPermission').getAttribute('data-user-id');
            loadUserPermissions(userId);
          } else {
            showToast('Failed to remove permission', 'danger');
          }
        })
        .catch(error => {
          console.error('Error removing permission:', error);
          showToast('Error removing permission', 'danger');
        });
      }
    };
    
    // Toast notification helper
    function showToast(message, type = 'success') {
      // Check if toast container exists, if not create it
      let toastContainer = document.querySelector('.toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
      }
      
      // Create toast element
      const toastId = 'toast-' + Date.now();
      const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      `;
      
      toastContainer.insertAdjacentHTML('beforeend', toastHtml);
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
      toast.show();
      
      // Remove toast after it's hidden
      toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
      });
    }
  });
</script>
{% endblock extra_js %}
{% endblock content %}