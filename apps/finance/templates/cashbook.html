{% extends "base.html" %}
{% load static %}
{% block title %}Cash Book{% endblock title %}
{% block content %}

<style>
    :root {
        --primary: #11998e;
        --primary-no-gradient: #11998e;
        --primary-dark: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        --secondary: orange;
        --accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --warning: linear-gradient(135deg, #fce38a 0%, #f38181 100%);
        --danger: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        --dark: #1a1a2e;
        --dark-alt: #16213e;
        --text-light: rgba(228, 230, 234, 1);
        --text-dark: black;
        --text-muted: black;
        --glass: rgba(255, 255, 255, 0.1);
        --glass-border: rgba(255, 255, 255, 0.2);
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 8px 6px rgba(0, 0, 0, 0.12);
        --border-radius: 12px;
        --border-radius-sm: 8px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --m-bottom: 20px;
    }

    .header-btn {
        padding: 8px 16px;
        border-radius: var(--border-radius-sm);
        background: var(--primary-no-gradient);
        border: 1px solid var(--glass-border);
        color: var(--text-light);
        text-decoration: none;
        transition: var(--transition);
        font-size: 14px;
        cursor: pointer;
    }

    .header-btn:hover {
        background: var(--primary);
        transform: translateY(-1px);
    }

    .search-container {
        position: relative;
        margin-bottom: 5px;
    }

    .search-input {
        width: 100%;
        padding: 15px 50px 15px 20px;
        border-radius: var(--border-radius);
        background: var(--glass);
        border: 1px solid var(--glass-border);
        color: var(--text-dark);
        font-size: 16px;
        transition: var(--transition);
    }

    .search-input:focus {
        outline: none;
        border-color: rgba(102, 126, 234, 0.5);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-input::placeholder {
        color: var(--text-dark);
    }

    .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-dark);
    }

    .cashbook .table td, .cashbook .table th {
        padding: 0.75rem 1rem;
        vertical-align: middle;
    }
    
    .cashbook .table tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    .cashbook .form-check-input:checked {
        background-color: var(--primary);
        border-color: var(--primary);
    }
    
    .chat-messages {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .chat-message {
        padding: 0.75rem;
        border-radius: 0.5rem;
        max-width: 80%;
    }
    
    .chat-message.sent {
        background-color: #e9f5ff;
        align-self: flex-end;
    }
    
    .chat-message.received {
        background-color: #f8f9fa;
        align-self: flex-start;
    }
    
    @media (max-width: 767.98px) {
        .cashbook .d-flex.justify-content-md-end {
            justify-content: center !important;
            margin-top: 1rem;
        }
        
        #customDateRange {
            flex-wrap: wrap;
            justify-content: center;
        }
    }
    .report{
        margin-left: 6px;
    }

    .form-label{
        font-size: 12px !important;
    }
    
    .custom-filter-modal .modal-dialog,
    .cash-in-modal .modal-dialog,
    .cash-out-modal .modal-dialog {
        position: fixed;
        right: 0;
        margin: 0;
        height: 100%;
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
    }

    .custom-filter-modal.show .modal-dialog,
    .cash-in-modal.show .modal-dialog,
    .cash-out-modal.show .modal-dialog {
        transform: translateX(0);
    }

    .custom-filter-modal .modal-content {
        height: 100%;
        border-radius: 0;
        border: none;
    }

    .custom-filter-modal .modal-header {
        border-bottom: 1px solid #dee2e6;
        padding: 1rem;
    }

    .custom-filter-modal .modal-body {
        padding: 1.5rem;
    }

    .filter-section {
        margin-bottom: 1.5rem;
    }

    .filter-section h6 {
        margin-bottom: 1rem;
        color: #495057;
    }

    .date-range-inputs {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .date-range-inputs .form-group {
        flex: 1;
    }

    /* Modern Table Styles */
    .modern-table {
        border-collapse: separate;
        border-spacing: 0;
    }

    .modern-table thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #dee2e6;
    }

    .modern-table tbody tr {
        transition: all 0.2s ease;
    }

    .modern-table tbody tr:hover {
        background-color: #f8f9fa;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .modern-table td {
        border-bottom: 1px solid #f0f0f0;
    }

    .status-badge {
        padding: 0.35rem 0.65rem;
        border-radius: 50rem;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-badge.pending {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-badge.approved {
        background-color: #d4edda;
        color: #155724;
    }

    .status-badge.cancelled {
        background-color: #f8d7da;
        color: #721c24;
    }

    .transaction-modal .modal-content {
        border: none;
        border-radius: 1rem;
    }

    .transaction-modal .modal-header {
        border-bottom: 1px solid #f0f0f0;
        padding: 1.5rem;
    }

    .transaction-modal .modal-body {
        padding: 1.5rem;
    }

    .transaction-modal .form-label {
        font-weight: 500;
        color: #495057;
    }

    .transaction-modal .form-control {
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
    }

    .transaction-modal .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }

    .cash-in-modal .modal-dialog,
    .cash-out-modal .modal-dialog {
        position: fixed;
        right: 0;
        margin: 0;
        height: 100%;
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
        max-width: 500px !important; 
    }

    .cash-in-modal.show .modal-dialog,
    .cash-out-modal.show .modal-dialog {
        transform: translateX(0);
    }

    .cash-in-modal .modal-content,
    .cash-out-modal .modal-content {
        height: 100%;
        border-radius: 0;
        border: none;
    }

    .cash-in-modal{
        width: 500px !important;
    }

    /* Calculator styles */
    .calculator-container {
        position: relative;
    }

    .calculator-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
    }

    .calculator-popup {
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: none;
        width: 250px;
        padding: 1rem;
    }

    .calculator-popup.show {
        display: block;
    }

    .calculator-display {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        text-align: right;
        font-size: 1.25rem;
    }

    .calculator-buttons {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
    }

    .calculator-buttons button {
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 0.25rem;
        cursor: pointer;
    }

    .calculator-buttons button:hover {
        background: #f8f9fa;
    }

    /* Category styles */
    .category-select-container {
        position: relative;
    }

    .add-category-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #0d6efd;
        cursor: pointer;
    }

    .category-modal .modal-dialog {
        max-width: 400px;
    }

    .filter-btn.active {
        background-color: #0d6efd;
        color: white;
    }

    .category-modal {
        z-index: 1060 !important;
    }

    .category-modal .modal-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        margin: 0;
        max-width: 400px;
        width: 100%;
    }

    .category-modal .modal-content {
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .category-modal .modal-header {
        border-bottom: 1px solid #dee2e6;
        padding: 1rem;
    }

    .category-modal .modal-body {
        padding: 1.5rem;
    }

    .category-modal .modal-footer {
        border-top: 1px solid #dee2e6;
        padding: 1rem;
    }

    /* Ensure other modals stay below category modal */
    .cash-in-modal,
    .cash-out-modal,
    .custom-filter-modal {
        z-index: 1050;
    }

    .search-container .input-group {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .search-container .input-group:focus-within {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }

    .search-container .input-group-text {
        border: none;
        background: transparent;
    }

    .search-container .form-control {
        border: none;
        padding: 0.5rem 1rem;
    }

    .search-container .form-control:focus {
        box-shadow: none;
    }

    .search-container .input-group.focused {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }

    /* Add loading and error states */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }

    .error-message {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .success-message {
        color: #198754;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .modal-dialog {
        margin: 1.75rem auto;
    }
    
    @media (min-width: 992px) {
        .modal-dialog {
            max-width: 95%;
            margin: 1.75rem auto;
        }
    }
    
    .modal-content {
        min-height: 100vh;
        overflow-y: auto;
    }
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 3000;
    }

    .modal-content {
        position: relative;
        background: white;
        margin: 15% auto;
        padding: 20px;
        width: 80%;
        max-width: 100%;
        border-radius: var(--border-radius);
    }

    .close-modal {
        position: absolute;
        right: 20px;
        top: 10px;
        font-size: 24px;
        cursor: pointer;
    }

    .nav{
        background: var(--primary);
        color:#fff;
    }
    .nav-link{
        color:#fff !important;
        background: var(--primary);
    }
    .nav-tabs .nav-link.active, .nav-tabs .nav-item.show .nav-link {
        color: #fff !important;
        background-color: var(--primary) !important;
        border-color: #fff !important;
    }
    .background{
        background: var(--primary);
    }
</style>

<div class="finance">
    <div class="cashbook">
        <!-- Header Section with Navigation and Filters -->
        <header class="rounded p-2 mb-2">
            <div class="d-flex align-items-center gap-2">
                <div class="col-4">
                    <div class="card shadow-sm border-0">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title">Cash In</h5>
                            <p class="card-text fs-3"><span id="totalCashIn">0.00</span></p>
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card shadow-sm border-0">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title">Cash Out</h5>
                            <p class="card-text fs-3"><span id="totalCashOut">0.00</span></p>
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card shadow-sm border-0">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title">Balance</h5>
                            <p class="card-text fs-3"><span id="totalBalance">0.00</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div>
            <div class="row">
                <div class="d-flex flex-wrap justify-content-md-end gap-2">
                    <div class="card-body">                    
                        <div class="btn-group">
                            <button class="btn btn-outline-dark filter-btn active" data-filter="today" onclick="applyFilter('today')">Today</button>
                            <button class="btn btn-outline-dark filter-btn" data-filter="this_week" onclick="applyFilter('this_week')">This Week</button>
                            <button class="btn btn-outline-dark filter-btn" data-filter="this_month" onclick="applyFilter('this_month')">This Month</button>
                            <button class="btn btn-outline-dark filter-btn" data-filter="this_year" onclick="applyFilter('this_year')">This Year</button>
                            <button class="btn btn-outline-dark filter-btn" data-filter="custom" onclick="showCustomFilter()">Custom</button>
                        </div>
                        <button class="btn btn-outline-primary report ">
                            <i class="bi bi-download"></i>
                            Reports
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card shadow-none border-0 mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div class="d-flex gap-2 w-25">
                        <button class="btn btn-primary" id="openCashOut" type="button">
                            <i class="bx bx-plus-circle me-1"></i> Record Transaction
                        </button>
                        <button class="btn btn-outline-dark w-50" data-bs-toggle="modal" data-bs-target="#cashUpModal">
                            <i class="bi bi-plus-circle me-1"></i> Record Cash Up
                        </button>
                    </div>
                    
                    <div class="search-container w-50" style="flex: 1; min-width: 300px;">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bx bx-search"></i>
                            </span>
                            <input type="text" class="form-control border-start-0" id="searchInput" placeholder="Search transactions..." onkeyup="handleSearch(event)">
                        </div>
                    </div>
                    <div class="d-flex gap-2 w-25">
                        <a href="{% url 'finance:banking' %}" class="btn btn-outline-dark w-50">
                            <i class="bi bi-plus-circle me-1"></i> Banking
                        </a>
                        <button class="btn btn-outline-dark w-50">
                            <i class="bx bx-plus-circle me-1"></i> Transfers
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs bg-white p-2" id="cashbookTabs" role="tablist">
            {% for currency in currencies %}
                <li class="nav-item" role="presentation">
                    <button 
                        class="nav-link {% if forloop.first %}active{% endif %}" id="tab-{{ currency.name }}" 
                        data-bs-toggle="tab" 
                        data-bs-target="#{{ currency.name }}" 
                        type="button" 
                        role="tab" 
                        aria-controls="{{ currency.name }}" 
                        aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
                        onclick="loadCashbookData(1, false, '{{ currency.id }}')"
                        >
                        {{ currency.name }}
                    </button>
                </li>
            {% endfor %}
        </ul>
        
        <div class="tab-content">
            {% for currency in currencies %}
            <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="{{ currency.name }}" role="tabpanel" aria-labelledby="tab-{{ currency.name }}">
                <div class="row">
                    <div class="col">
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table modern-table" id="cashbookTable-{{ currency.name }}">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Description</th>
                                                <th>Amount</th>
                                                <th>Balance</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="cashbookTableBody-{{ currency.id }}">
                                            <!-- Table content will be loaded dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="loadingSpinner-{{ currency.id }}" class="text-center d-none">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        
        
        <!-- Chat Modal -->
        <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header">
                        <h5 class="modal-title" id="chatModalLabel">Notes & Comments</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="chatMessages" class="chat-messages p-3 bg-light rounded" style="max-height: 300px; overflow-y: auto;">
                            <!-- Chat messages will appear here -->
                        </div>
                        <div class="mt-3 position-relative">
                            <textarea id="chatInput" class="form-control shadow-none" rows="2" placeholder="Type your message..."></textarea>
                            <button type="button" class="btn btn-primary position-absolute bottom-0 end-0 m-2" onclick="sendMessage()">
                                <i class="bx bx-send"></i>
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Cash Up Modal -->
    <div class="modal fade" id="cashUpModal" tabindex="-1" aria-labelledby="cashupModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content border-0 shadow">
                {% include 'cashflows/cash_ups.html' %}
            </div>
        </div>
    </div> 

    <!-- Custom Filter Modal -->
    <div class="modal fade filter-modal" id="filterModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 95%; width: 95%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Custom Filter</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="filter-section">
                        <h6>Date Range</h6>
                        <div class="date-range-inputs">
                            <div class="form-group">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate">
                            </div>
                            <div class="form-group">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                        </div>
                    </div>
                    <div class="filter-section">
                        <h6>Search</h6>
                        <input type="text" class="form-control" id="searchQuery" placeholder="Search in description, accountant, manager, or director">
                    </div>
                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-primary" onclick="applyCustomFilter()">Apply Filters</button>
                        <button class="btn btn-outline-secondary" onclick="resetFilters()">Reset</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cash Out Offcanvas -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="cashOutCanvas" aria-labelledby="cashOutCanvasLabel">
        <div class="offcanvas-header align-items-center">
            <ul class="nav nav-tabs justify-content-between w-100 bg-white border rounded p-2 gap-2" id="cashFlowTabs" role="tablist" style="background: var(--primary);">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="cash_income-tab" data-bs-toggle="tab" data-bs-target="#cash_income-panel" type="button" role="tab" aria-controls="cash_income-panel" aria-selected="true">Income</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="cash_expense-tab" data-bs-toggle="tab" data-bs-target="#cash_expense-panel" type="button" role="tab" aria-controls="cash_expense-panel" aria-selected="false">Expenses</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="cash_expense-tab" data-bs-toggle="tab" data-bs-target="#cash_expense-panel" type="button" role="tab" aria-controls="cash_expense-panel" aria-selected="false">Transfers</button>
                </li>
            </ul>
        </div>
        <div class="offcanvas-body">
            {% include 'cashflows/cashmanagement.html' %}
        </div>
    </div>

    <!-- Add loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>  

    <!-- Add toast container -->
    <div class="toast-container" id="toastContainer"></div>
</div>
<script>
// Global variables
let currentPage = 1;
let isLoading = false;
let hasMorePages = true;
let searchTimeout;
let currentFilters = {
    filter: 'today',
    start_date: null,
    end_date: null,
    search: ''
};
let currency = {{ currency.id }};

//cashmanagement
const state = {
    cash_income: {
        page: 1,
        loading: false,
        hasMore: true
    },
    cash_expense: {
        page: 1,
        loading: false,
        hasMore: true
    }
};

const categoryModal = new bootstrap.Modal(document.getElementById('addCatModal'));
const expenseCategoryModal = new bootstrap.Modal(document.getElementById('addExpenseCategoryModal'));

document.addEventListener('DOMContentLoaded', function () {
    const openBtn = document.getElementById('openCashOut');
    const cashOutCanvas = document.getElementById('cashOutCanvas');
    const bsOffcanvas = new bootstrap.Offcanvas(cashOutCanvas);
    bsOffcanvas.show();
    openBtn.addEventListener('click', function () {
        bsOffcanvas.show();
    });
});


function toggleRecurrence(type) {

    const toggle = document.getElementById(`${type}RecurringToggle`);
    const group = document.getElementById(`${type}RecurrenceGroup`);

    if (toggle && group) {
        if(group.style.display === 'none'){
            console.log(group)
            group.style.display = 'block'
        }else{
            console.log(group)
            group.style.display = 'none'
        }
        
    }
}

function previewExpenseImage() {
    const input = document.getElementById('expImage');
    const preview = document.getElementById('expImagePreview');

    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
            preview.src = e.target.result;
            preview.classList.remove('d-none');
        };
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.classList.add('d-none');
    }
}

document.addEventListener('DOMContentLoaded', function () {
    const parentCategorySelect = document.getElementById('parentCategory');
    const newIncomeParentWrapper = document.getElementById('newIncomeParentWrapper');
    
    if (parentCategorySelect && newIncomeParentWrapper) {
        parentCategorySelect.addEventListener('change', function () {
            if (this.value === '__create_new__') {
                newIncomeParentWrapper.classList.remove('d-none');
            } else {
                newIncomeParentWrapper.classList.add('d-none');
            }
        });
    }
    
    const expenseParentSelect = document.getElementById('expenseParentCategory');
    const expenseNewParentWrapper = document.getElementById('expenseNewParentWrapper');
    
    if (expenseParentSelect && expenseNewParentWrapper) {
        expenseParentSelect.addEventListener('change', function () {
            if (this.value === '__create_new__') {
                expenseNewParentWrapper.classList.remove('d-none');
            } else {
                expenseNewParentWrapper.classList.add('d-none');
            }
        });
    }
    
    document.getElementById('cash_expense-tab').addEventListener('click', function() {
        if (document.getElementById('expense_table').children.length === 0) {
            loadExpenses();
        }
    });

    document.getElementById('saveCatBtn').addEventListener('click', saveIncomeCategory);
    document.getElementById('saveExpenseCategoryBtn').addEventListener('click', saveExpenseCategory);
});

function saveIncomeCategory() {
    const nameInput = document.getElementById('InCategoryName');
    const name = nameInput.value.trim();
    const parentSelect = document.getElementById('parentCategory');
    const selectedParent = parentSelect.value;
    const newParentInput = document.getElementById('newIncomeParentInput');
    const newParentName = newParentInput.value.trim();

    if (!name) {
        showToast("Name is required.", "error");
        return;
    }

    fetch('{% url "finance:add_income_category" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            name: name,
            parent_id: selectedParent === '__create_new__' ? null : selectedParent,
            new_parent_name: selectedParent === '__create_new__' ? newParentName : null
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const select = document.getElementById('inCategory');
            const option = document.createElement('option');
            option.value = data.id;
            option.textContent = data.name;
            option.selected = true;
            select.appendChild(option);

            nameInput.value = '';
            parentSelect.value = '';
            newParentInput.value = '';
            document.getElementById('newIncomeParentWrapper').classList.add('d-none');
            categoryModal.hide();

            showToast("Category added!", "success");
        } else {
            showToast(data.error || "Failed to save.", "error");
        }
    })
    .catch(err => {
        showToast("An error occurred.", "error");
        console.error(err);
    });
}

function saveExpenseCategory() {
    const name = document.getElementById('expenseCategoryName').value.trim();
    const parentSelect = document.getElementById('expenseParentCategory');
    const parent = parentSelect.value === '__create_new__' ? null : parentSelect.value;
    const newParent = parentSelect.value === '__create_new__' ? document.getElementById('expenseNewParentInput').value.trim() : null;

    if (!name) {
        showToast("Category name is required", "error");
        return;
    }

    const payload = { name, parent, new_parent: newParent };

    fetch('/finance/add/expense/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast("Expense category added!", "success");

            const select = document.getElementById('expCategory');
            const option = document.createElement('option');
            option.value = data.category.id;
            option.textContent = data.category.name;
            option.selected = true;
            select.appendChild(option);

            document.getElementById('expenseCategoryName').value = '';
            document.getElementById('expenseParentCategory').value = '';
            document.getElementById('expenseNewParentInput').value = '';
            document.getElementById('expenseNewParentWrapper').classList.add('d-none');

            expenseCategoryModal.hide();
        } else {
            showToast(data.error || "Error saving category", "error");
        }
    })
    .catch(() => {
        showToast("Something went wrong!", "error");
    });
}

function loadIncomes(refresh = false) {
    if (state.cash_income.loading || (!state.cash_income.hasMore && !refresh)) return;
    
    state.cash_income.loading = true;
    
    if (refresh) {
        state.cash_income.page = 1;
        state.cash_income.hasMore = true;
        document.getElementById('income_table').innerHTML = '';
    }

    document.getElementById('income_loader').classList.remove('d-none');

    setTimeout(() => {
        fetchIncomes(state.cash_income.page)
            .then(data => {
                renderIncomes(data);  
                state.cash_income.page++;
            })
            .catch(error => {
                console.error('Error loading incomes:', error);
            })
            .finally(() => {
                state.cash_income.loading = false;
                document.getElementById('income_loader').classList.add('d-none');
            });
    }, 700); 
}

function fetchIncomes(page = 1) {
    return fetch(`/finance/get-incomes/?page=${page}&limit=10`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch income data');
            }
            return response.json();
        })
        .then(data => {
            state.cash_income.hasMore = data.has_next;  
            return data.data; 
        });
}

function renderIncomes(incomes) {
    const table = document.getElementById('income_table');
    incomes.forEach(income => {
        const row = document.createElement('tr');

        row.innerHTML = `
            <td>${new Date(income.created_at).toLocaleDateString()}</td>
            <td>${income.note}</td>
            <td>${income.category}</td>
            <td>${income.branch}</td>
            <td>$${income.amount}</td>
        `;

        table.appendChild(row);
    });
}

function loadExpenses(refresh = false) {
    if (state.cash_expense.loading || (!state.cash_expense.hasMore && !refresh)) return;
    
    state.cash_expense.loading = true;
    
    if (refresh) {
        state.cash_expense.page = 1;
        state.cash_expense.hasMore = true;
        document.getElementById('expense_table').innerHTML = '';
    }

    document.getElementById('expense_loader').classList.remove('d-none');

    setTimeout(() => {
        fetchExpenses(state.cash_expense.page)
            .then(data => {
                renderExpenses(data);  
                state.cash_expense.page++;
            })
            .catch(error => {
                console.error('Error loading expenses:', error);
            })
            .finally(() => {
                state.cash_expense.loading = false;
                document.getElementById('expense_loader').classList.add('d-none');
            });
    }, 700); 
}

// Fetch expense data from API
function fetchExpenses(page = 1) {
    return fetch(`/finance/get_expenses/?page=${page}&limit=10`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch expense data');
            }
            return response.json();
        })
        .then(data => {
            state.cash_expense.hasMore = data.has_next;  
            return data.data; 
        })
        .catch(error => {
        
        });
}

// Render expense data to table
function renderExpenses(expenses) {
const table = document.getElementById('expense_table');
expenses.forEach(expense => {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${new Date(expense.created_at).toLocaleDateString()}</td>
        <td>${expense.note}</td>
        <td>${expense.category}</td>
        <td>${expense.branch}</td>
        <td>$${expense.amount}</td>
        <td>${expense.has_receipt ? 
            `<a href="${expense.receipt_url}" target="_blank" class="btn btn-sm btn-outline-info">
                <i class="bx bx-receipt"></i> View
            </a>` : 
            'None'}
        </td>
    `;

    table.appendChild(row);
});
}

// Record new expense
function recordCashExpense() {
const expName = document.getElementById('expName').value;
const expAmount = document.getElementById('expAmount').value;
const expCategory = document.getElementById('expCategory').value;
const expenseBranch = document.getElementById('expenseBranch').value;
const expImage = document.getElementById('expImage').files[0];

const isRecurring = document.getElementById('expRecurringToggle').checked;
const value = isRecurring ? document.getElementById('expenseRecurrenceValue').value : null;
const unit = isRecurring ? document.getElementById('expenseRecurrenceUnit').value : null;

if (!expAmount || expAmount <= 0) {
    showToast("Please enter a valid amount", "error");
    return;
}

if (!expCategory) {
    showToast("Please select a category", "error");
    return;
}

const payload = {
    name: expName,
    amount: expAmount,
    category: expCategory,
    branch: expenseBranch,
    r_value: isRecurring ? value : null,
    r_unit: isRecurring ? unit : null,
    receipt: null, 
};

console.log(payload)

if (expImage) {
    const reader = new FileReader();
    reader.onloadend = function () {
        payload.receipt = reader.result; 
        sendExpenseData(payload);
    };
    reader.readAsDataURL(expImage); 
} else {
    sendExpenseData(payload);
}
}

function sendExpenseData(payload) {
fetch("/finance/expenses/", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify(payload)
})
.then(response => response.json())
.then(result => {
    if (result.success) {
        showToast(result.message, "success");

        document.getElementById('expName').value = '';
        document.getElementById('expAmount').value = '';
        document.getElementById('expCategory').value = '';
        document.getElementById('expImage').value = '';
        document.getElementById('expImagePreview').classList.add('d-none');
        document.getElementById('expRecurringToggle').checked = false;
        toggleRecurrence('expense');

        loadExpenses(true);
    } else {
        showToast(result.message || "Failed to record expense", "error");
    }
})
.catch(error => {
    console.error("Error:", error);
    showToast("An error occurred while saving expense", "error");
});
}

function showToast(message, type = 'info') {

let toastContainer = document.getElementById('toast-container');
if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.id = 'toast-container';
    toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
    document.body.appendChild(toastContainer);
}

const toastId = `toast-${Date.now()}`;
const toast = document.createElement('div');
toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0`;
toast.id = toastId;
toast.setAttribute('role', 'alert');
toast.setAttribute('aria-live', 'assertive');
toast.setAttribute('aria-atomic', 'true');

toast.innerHTML = `
    <div class="d-flex">
        <div class="toast-body">
            ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
`;

toastContainer.appendChild(toast);

const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
bsToast.show();

toast.addEventListener('hidden.bs.toast', function () {
    toast.remove();
});
}


document.addEventListener('DOMContentLoaded', function() {

const incomeTableContainer = document.querySelector('#cash_income-panel .table-container');
const expenseTableContainer = document.querySelector('#cash_expense-panel .table-container');

if (incomeTableContainer) {
    incomeTableContainer.addEventListener('scroll', function() {
        const { scrollTop, scrollHeight, clientHeight } = this;
        
        if (scrollTop + clientHeight >= scrollHeight - 5 && state.cash_income.hasMore && !state.cash_income.loading) {
            loadIncomes();
        }
    });
}

if (expenseTableContainer) {
    expenseTableContainer.addEventListener('scroll', function() {
        const { scrollTop, scrollHeight, clientHeight } = this;
        
        if (scrollTop + clientHeight >= scrollHeight - 5 && state.cash_expense.hasMore && !state.cash_expense.loading) {
            loadExpenses();
        }
    });
}
});



if (document.getElementById('cash_expense-panel').classList.contains('active')) {
    if (event.ctrlKey && event.key === 'Enter') {
        recordCashExpense();
    }
}

document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
    tab.addEventListener('shown.bs.tab', function (event) {
        const targetId = event.target.getAttribute('data-bs-target');
        if (targetId === '#cash_expense-panel') {
            if (document.getElementById('expense_table').children.length === 0) {
                loadExpenses();
            }
        }
    });
});


// Cashbook
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(amount);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function loadCashbookData(page = 1, append = false, currency = null) {
    try {
        console.log(currency, 'currency')
        showLoading();

        const tableBody = document.getElementById(`cashbookTableBody-${currency}`);
        const loadingSpinner = document.getElementById(`loadingSpinner-${currency}`);
        
        if (!append) {
            tableBody.innerHTML = '';
            currentPage = 1;
        }
        
        loadingSpinner.style.display = 'block';
        
        const requestData = {
            currency: currency,
            page: page,
            per_page: 20,
            filter: currentFilters.filter,
            start_date: currentFilters.start_date,
            end_date: currentFilters.end_date,
            search: currentFilters.search || ''
        };

        console.log(requestData, 'requestData')

        const response = await fetch('{% url "finance:cashbook_data" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        if (!append) {
            console.log(data, 'data')
            tableBody.innerHTML = '';
            cash_in_element = document.getElementById('totalCashIn');
            cash_in_element.innerHTML = ''
            data.totals.cash_in.forEach(currency => {
                cash_in_element.innerHTML += `<div class="fs-6">${currency.name.toLowerCase()}: ${formatCurrency(currency.amount)}</div>`
            })

            cash_out_element = document.getElementById('totalCashOut');
            cash_out_element.innerHTML = ''
            data.totals.cash_out.forEach(currency => {
                cash_out_element.innerHTML += `<div class="fs-6">${currency.name.toLowerCase()}: ${formatCurrency(currency.amount)}</div>`
            })

            balance_element = document.getElementById('totalBalance');
            balance_element.innerHTML = ''
            data.totals.balance.forEach(currency => {   
                balance_element.innerHTML += `<div class="fs-6">${currency.name.toLowerCase()}: ${formatCurrency(currency.amount)}</div>`
            })
        }

        if (data.entries.length === 0 && !append) {
            console.log('no entries')
            tableBody.innerHTML = '';
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <div class="text-muted">
                            <i class="bx bx-search-alt fs-1"></i>
                            <p class="mt-2">No transactions found</p>
                        </div>
                    </td>
                </tr>
            `;
            console.log(tableBody, 'tableBody')
        } else {
            data.entries.forEach(entry => {
                const row = document.createElement('tr');
                const dt = new Date(entry.date.replace(' ', 'T'));
                
                const formattedDate = dt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                const formattedTime = dt.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const amount = entry.debit
                    ? `<span style="color: green;">${formatCurrency(entry.debit)}</span>`
                    : `<span style="color: red;">${formatCurrency(entry.credit)}</span>`;
                
                row.innerHTML = `
                    <td>
                        <div>${formattedDate}</div>
                        <div class="text-muted" style="font-size: 0.85em;">${formattedTime}</div>
                    </td>
                    <td>${entry.description} <br> <small class="text-muted"> by ${entry.created_by}</small></td>
                    <td>${amount}</td>
                    <td>${formatCurrency(entry.balance)}</td>
                    <td>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm text-danger" onclick="cancelTransaction(${entry.id})">
                                <i class="bx bx-x-circle"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        currentPage = data.pagination.current_page;
        hasMorePages = data.pagination.has_next;
        
        loadingSpinner.style.display = 'none';
    } catch (error) {
        console.error('Error loading cashbook data:', error);
        showToast('Failed to load transactions. Please try again.', 'danger');
    } finally {
        hideLoading();
        const loadingSpinner = document.getElementById(`loadingSpinner-${currency}`);
        loadingSpinner.style.display = 'none';
    }
}



function handleSearch(event) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const searchValue = event.target.value.trim();
        currentFilters.search = searchValue;
        currentPage = 1;
        hasMorePages = true;
        loadCashbookData(1, false, currency);
    }, 500);
}

function applyFilter(filterType) {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filterType) {
            btn.classList.add('active');
        }
    });

    currentFilters = {
        filter: filterType,
        start_date: null,
        end_date: null,
        search: ''
    };
    
    currentPage = 1;
    hasMorePages = true;
    loadCashbookData(1, false, currency);
}

function showCustomFilter() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === 'custom') {
            btn.classList.add('active');
        }
    });

    const modal = new bootstrap.Modal(document.getElementById('filterModal'));
    modal.show();
}

function applyCustomFilter() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const searchQuery = document.getElementById('searchQuery').value;
    
    currentFilters = {
        filter: 'custom',
        start_date: startDate,
        end_date: endDate,
        search: searchQuery
    };
    
    currentPage = 1;
    hasMorePages = true;
    loadCashbookData(1, false, '');
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
    modal.hide();
}

function resetFilters() {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('searchQuery').value = '';
    
    currentFilters = {
        filter: 'today',
        start_date: null,
        end_date: null,
        search: ''
    };
    
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === 'today') {
            btn.classList.add('active');
        }
    });
    
    currentPage = 1;
    hasMorePages = true;
    loadCashbookData(1, false, '');
}


function showAddCategoryModal() {
    const existingModals = document.querySelectorAll('.modal.show');
    existingModals.forEach(modal => {
        const modalInstance = bootstrap.Modal.getInstance(modal);
        if (modalInstance) {
            modalInstance.hide();
        }
    });

    const categoryModal = new bootstrap.Modal(document.getElementById('addCategoryModal'));
    categoryModal.show();
}

function refreshCategoryOptions() {
    fetch('/finance/get-categories/')
        .then(response => response.json())
        .then(data => {
            const categorySelects = document.querySelectorAll('select[name="category"]');
            categorySelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Category</option>';
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    select.appendChild(option);
                });
                select.value = currentValue;
            });
        });
}

function cancelTransaction(entryId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, cancel it!'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/finance/cancel-entry/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ entry_id: entryId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: 'Success!',
                        text: 'Entry successfully cancelled.',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        loadCashbookData(currentPage, false, '');
                    });
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: data.message || 'Failed to cancel the entry.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });
        }
    });
}

function toggleCalculator(type) {
    const calculator = document.getElementById(`${type}Calculator`);
    calculator.classList.toggle('show');
}

function handleScroll() {
    const table = document.querySelector('.table-responsive');
    const tableBottom = table.scrollTop + table.clientHeight;
    const tableHeight = table.scrollHeight;
    
    if (tableHeight - tableBottom < 200 && !isLoading && hasMorePages) {
        loadCashbookData(currentPage + 1, true, '');
    }
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.getElementById('toastContainer').appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

function validateForm(form) {
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    return isValid;
}

document.addEventListener('keydown', (e) => {

    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById('searchInput').focus();
    }
    

    if (e.key === 'Escape') {
        const openModals = document.querySelectorAll('.modal.show');
        openModals.forEach(modal => {
            const modalInstance = bootstrap.Modal.getInstance(modal);
            if (modalInstance) {
                modalInstance.hide();
            }
        });
    }
});


document.addEventListener('DOMContentLoaded', () => {
    loadCashbookData(1, false, {{ currency.id }});
    document.querySelector('.table-responsive').addEventListener('scroll', handleScroll);

    document.querySelectorAll('input[required], select[required]').forEach(field => {
        field.addEventListener('input', () => {
            if (field.value.trim()) {
                field.classList.remove('is-invalid');
            }
        });
    });

    const calculators = document.querySelectorAll('.calculator-popup');
    calculators.forEach(calculator => {
        const buttons = calculator.querySelectorAll('.calculator-buttons button');
        const display = calculator.querySelector('.calculator-display');
        const input = calculator.closest('.calculator-container').querySelector('input');

        buttons.forEach(button => {
            button.addEventListener('click', () => {
                const value = button.textContent;
                if (value === '=') {
                    try {
                        const result = eval(display.textContent);
                        display.textContent = result;
                        input.value = result;
                    } catch (e) {
                        display.textContent = 'Error';
                        showToast('Invalid calculation', 'warning');
                    }
                } else {
                    display.textContent += value;
                }
            });
        });
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.calculator-container')) {
            document.querySelectorAll('.calculator-popup').forEach(popup => {
                popup.classList.remove('show');
            });
        }
    });

    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('focus', () => {
            searchInput.parentElement.classList.add('focused');
        });
        
        searchInput.addEventListener('blur', () => {
            searchInput.parentElement.classList.remove('focused');
        });
    }
});
</script> 
{% endblock %}
