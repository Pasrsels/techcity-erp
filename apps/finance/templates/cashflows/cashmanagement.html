{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Flow Management</title>
    <style>
        .cash-flow-card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #incomeRecurrenceGroup, #expenseRecurrenceGroup {
            display: flex;
            gap: 10px;
        }
        .loader {
            text-align: center;
        }
        .search-icon {
            position: absolute;
            top: 50%;
            right: 10px;
            width: 16px;
            height: 16px;
            transform: translateY(-50%);
            background: url('/static/icons/search.svg') no-repeat center;
            background-size: contain;
            pointer-events: none;
        }

        .custom-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 999;
            background-color: #fff;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
            border-radius: 0 0 6px 6px;
        }

        .custom-dropdown.show {
            display: block;
        }

        .custom-dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .custom-dropdown-item:hover,
        .custom-dropdown-item.highlighted {
            background-color: #f1f1f1;
        }

        .add-new {
            font-weight: 500;
            color: #007bff;
        }

        .add-icon {
            margin-right: 5px;
            color: #007bff;
            font-weight: bold;
        }

        .no-results {
            padding: 10px 15px;
            color: #888;
            font-style: italic;
        }

        .new-option-badge {
            background-color: #28a745;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 12px;
            margin-left: 10px;
        }

        .form-control:focus,
        .form-select:focus,
        .form-check-input:focus,
        .btn:focus,
            input[type="checkbox"]:focus,
            input[type="radio"]:focus {
            border-color: #11998e !important;
        }
        .loading {
            display: none;
        }
        .category-list {
            background: #f8f9fa;
            border-radius: 18px;
            padding: 16px 0 0 0;
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            justify-content: flex-start;
            margin-right: 0 !important;
            margin-left: 0 !important;
            width: 100%;
        }
        .main-category-card {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            padding: 18px 18px 12px 18px;
            min-width: 220px;
            max-width: 100%;
            flex: 1 1 220px;
            display: flex;
            flex-direction: column;
            margin-bottom: 0;
            transition: box-shadow 0.2s, transform 0.2s;
            margin-right: 0 !important;
        }
        .main-category-card:hover {
            box-shadow: 0 4px 16px rgba(33,150,243,0.10);
            transform: translateY(-2px) scale(1.02);
        }
        .main-category-icon {
            font-size: 1.5em;
            margin-right: 10px;
            color: #2196f3;
            display: flex;
            align-items: center;
        }
        .category-pill {
            background: #e5e6e8 !important;
            color: #444 !important;
            font-weight: 500;
            font-size: 1em;
            border-radius: 16px !important;
            padding: 6px 18px !important;
            margin-bottom: 6px;
        }
        .add-category-link {
            color: #2196f3;
            font-weight: 600;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 6px;
            margin-top: 18px;
            margin-bottom: 8px;
            cursor: pointer;
            margin-left: 32px; /* Add space from the left edge */
        }
        .add-category-link i {
            font-size: 1.2em;
        }
        /* Ensure the add-category-link is in the same row as the plus button */
        .add-category-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 18px;
            margin-bottom: 8px;
        }
        @media (max-width: 768px) {
            .category-list {
                flex-direction: column;
                gap: 0;
            }
            .main-category-card {
                max-width: 100%;
                min-width: 0;
                margin-bottom: 18px;
            }
        }
        /* Inline Add Category Modal */
        #addCategoryInlineModal {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
            padding: 28px 18px 18px 18px;
            position: relative;
            margin-top: 18px;
            margin-bottom: 18px;
            z-index: 20;
        }
        #addCategoryInlineModal .close-btn {
            position: absolute;
            right: 18px;
            top: 18px;
            font-size: 1.3em;
            color: #888;
            background: none;
            border: none;
            cursor: pointer;
        }
        #addCategoryInlineModal .form-label {
            font-weight: 500;
            color: #444;
            margin-bottom: 6px;
        }
        #addCategoryInlineModal .form-control {
            border-radius: 12px;
            background: #f5f6fa;
            border: none;
            font-size: 1.1em;
            margin-bottom: 12px;
        }
        #addCategoryInlineModal .input-group-text {
            background: #f5f6fa;
            border: none;
        }
        #addCategoryInlineModal .btn {
            border-radius: 12px;
            font-size: 1.1em;
            min-width: 100px;
        }
        #addCategoryInlineModal .btn-primary {
            background: #2196f3;
            border: none;
        }
        #addCategoryInlineModal .btn-outline-primary {
            border: 1.5px solid #2196f3;
            color: #2196f3;
        }
        #addCategoryInlineModal .add-sub-btn {
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1em;
            margin-left: 8px;
            padding: 0;
            min-width: 0;
        }
        #addCategoryInlineModal .action-btns {
            display: flex;
            justify-content: space-between;
            margin-top: 18px;
        }
        .offcanvas-body {
            padding-right: 0 !important;
            padding-left: 0 !important;
        }
        .category-search-btn {
            display: flex;
            align-items: center;
            width: 100%;
            background: #f5f6fa;
            border: none;
            border-radius: 12px;
            padding: 0 16px;
            height: 60px;
            color: #aaa;
            font-size: 1.1em;
            font-weight: 400;
            cursor: pointer;
            box-shadow: none;
            transition: background 0.2s;
        }
        .category-search-btn:focus {
            outline: none;
            box-shadow: none;
            border: none;
        }
        .category-search-btn .icon {
            margin-right: 12px;
            font-size: 1.3em;
            color: #bbb;
        }
        .category-search-btn .placeholder {
            color: #bbb;
            font-size: 1.1em;
            font-weight: 400;
        }
        .category-select-panel {
            width: 100%;
        }
        .category-input-wrapper {
            display: flex;
            align-items: center;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 0 12px;
            height: 48px;
            width: 100%;
        }
        .category-input-wrapper .icon {
            color: #bdbdbd;
            font-size: 1.2em;
            margin-right: 10px;
        }
        .category-input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            color: #bdbdbd;
            font-size: 1em;
            font-weight: 400;
            padding: 0;
        }
        .category-input::placeholder {
            color: #bdbdbd;
            opacity: 1;
            font-weight: 400;
        }
        .main-category-title-green {
            color: #11998e; /* or your preferred green */
            font-weight: 600;
        }
        .main-category-card .main-category-plus-btn {
            width: 24px !important;
            height: 24px !important;
            font-size: 1em !important;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            border: 1.5px solid #2196f3 !important;
            color: #2196f3 !important;
            background: #fff !important;
            box-shadow: none !important;
            transition: none;
        }
        .main-category-card .main-category-plus-btn:focus,
        .main-category-card .main-category-plus-btn:active,
        .main-category-card .main-category-plus-btn:hover {
            background: #fff !important;
            color: #2196f3 !important;
            border: 1.5px solid #2196f3 !important;
            box-shadow: none !important;
        }
        .main-category-card .main-category-plus-btn i {
            color: #2196f3 !important;
            font-size: 1.1em;
        }
        /* Align plus button with subcategories */
        .main-category-card .d-flex.justify-content-between.align-items-center.mb-2 {
            align-items: flex-start !important;
        }
        /* Modal for editing subcategories */
        .modal-category-edit {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.3);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal-category-edit .modal-content {
            background: #fff;
            border-radius: 12px;
            padding: 32px 24px 24px 24px;
            min-width: 350px;
            max-width: 95vw;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            position: relative;
        }
        .modal-category-edit .close-btn {
            position: absolute;
            top: 12px;
            right: 16px;
            background: none;
            border: none;
            font-size: 1.5em;
            color: #888;
            cursor: pointer;
        }
        .modal-category-edit .subcat-pill {
            background: #e5e6e8;
            color: #444;
            border-radius: 16px;
            padding: 6px 18px;
            margin: 0 6px 6px 0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .modal-category-edit .remove-subcat {
            color: #dc3545;
            cursor: pointer;
            font-size: 1.1em;
        }
    </style>
</head> 
<body>
    <!-- TABS: Update Income/Expenses tab buttons (move to correct location, outside JS blocks) -->
    <ul class="nav nav-tabs justify-content-between w-100 bg-white border rounded p-2 gap-2 stylish-tabs" id="cashFlowTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link income-tab" id="cash_income-tab" data-bs-toggle="tab" data-bs-target="#cash_income-panel" type="button" role="tab" aria-controls="cash_income-tab" aria-selected="true">Income</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link expense-tab" id="cash_expense-tab" data-bs-toggle="tab" data-bs-target="#cash_expense-panel" type="button" role="tab" aria-controls="cash_expense-tab" aria-selected="false">Expenses</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link transfer-tab" id="transfer-tab" data-bs-toggle="tab" data-bs-target="#transfer-panel" type="button" role="tab" aria-controls="transfer_tab" aria-selected="false">Transfers</button>
        </li>
    </ul>
    <div class="tab-content" id="cashFlowTabsContent">
        <div class="tab-pane fade show active" id="cash_income-panel" role="tabpanel" aria-labelledby="cash_income-tab">
            <div class="row">
                <div class="col">
                    <div class="card p-3">
                        <div class="">
                            <div class="input-group">
                                <div class="d-flex justify-content-between w-100 mb-4 bg-light" style="height: 60px;">
                                    <div class="d-flex align-items-center bg-light px-1">
                                        <i class='bx bx-payment' style="color:#11998e;"></i>
                                        <select class="form-select bg-light border-0 b" id="payment_type" name="payment_type">
                                            <option value="cash">Cash</option>
                                            <option value="bank">Bank</option>
                                            <option value="ecocash">Ecocash</option>
                                        </select>
                                    </div>
                                    <div class="d-flex align-items-center bg-light px-1">
                                        <i class='bx bx-wallet'></i>
                                        <select class="form-select bg-light border-0 b" id="currency" name="currency">
                                            {% for currency in currencies %}
                                                <option value="{{ currency.id }}" {% if currency.default %} selected {% endif %}>{{ currency.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <!-- ENTER AMOUNT SECTION WITH FLOATING LABEL AND AMOUNT IN WORDS -->
                                <div class="mb-4">
                                    <div class="form-floating">
                                        <input type="number" class="form-control border-0 text-center fs-3 bg-light" id="inAmount" placeholder="Enter amount" oninput="updateAmountInWords(this)" style="height: 60px;">
                                        <label for="inAmount" class="text-muted">Enter amount</label>
                                    </div>
                                    <div id="amountInWords" class="text-secondary mt-1" style="font-size: 0.95em;"></div>
                                </div>
                            </div>

                        <!-- INCOME PANEL: Replace first category search with Notes -->
                        <div class="mb-4 d-flex gap-2 align-items-start">
                            <div class="d-flex bg-light w-100">
                                <span class="input-group-text bg-light border-0">
                                    <i class="bx bx-pencil"></i>
                                </span>
                                <input type="text" class="form-control bg-light border-0" id="incomeNotes" placeholder="Notes" style="height: 60px;">
                            </div>
                        </div>

                        <!-- CATEGORY SECTION WITH BUTTON -->
                        <div class="mb-4 d-flex gap-2 align-items-start">
                            <div class="w-100">
                                <label class="form-label">Category</label>
                                <div class="category-select-panel">
                                    <div class="category-input-wrapper">
                                        <span class="icon"><i class="bi bi-shapes"></i></span>
                                        <input type="text" class="category-input" placeholder="search or add category" readonly onclick="openCategoryPanel()" />
                                    </div>
                                </div>
                            </div>
                        </div>
                                                            
                        <div class="mb-4">
                            <div class="input-group">
                                <span class="input-group-text bg-light border-0"><i class="bx bx-map"></i></span>
                                <select class="form-select border-0 bg-light" id="inBranch" style="height: 60px;">
                                    {% for branch in branches %}
                                        {% if request.user.role|lower == 'admin' %}
                                            <option value="{{ branch.id}}">{{ branch.name }}</option>
                                        {% elif forloop.first %}
                                            <option value="{{ request.user.branch.id}}">{{ request.user.branch }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="custom-dropdown dropdown">
                            <button class="form-control text-start dropdown-toggle" type="button" id="contactDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                Search or Select
                            </button>
                            <ul class="dropdown-menu p-2" aria-labelledby="contactDropdown">

                                <!-- Search Input -->
                                <li class="dropdown-header-input">
                                <input type="text" class="form-control" placeholder="Search or Select" oninput="filterContacts(this.value)">
                                </li>

                                <div id="contactOptions">
                                <!-- Radio Options -->
                                <li>
                                    <label class="dropdown-item dropdown-item-radio">
                                    <input type="radio" name="contact" value="casper"> casper
                                    </label>
                                </li>
                                <li>
                                    <label class="dropdown-item dropdown-item-radio">
                                    <input type="radio" name="contact" value="Casper Moyo"> Casper Moyo
                                    </label>
                                </li>
                                </div>

                                <li><hr class="dropdown-divider"></li>

                                <!-- Add New Contact -->
                                <li>
                                <div class="dropdown-item add-contact text-primary" onclick="openAddContactModal()">
                                    <i class="bi bi-plus-circle me-1"></i> Add New Contact
                                </div>
                                </li>

                                <!-- Import CSV -->
                                <li>
                                <div class="dropdown-item import-csv bg-success bg-opacity-10 text-success rounded">
                                    <i class="bi bi-cloud-arrow-up me-1"></i> Import Bulk contacts from CSV
                                </div>
                                </li>
                            </ul>
                            </div>

                        <div class="d-flex mb-3">
                            <input class="form-check bg-dark" type="checkbox" id="incomeRecurringToggle" onchange="toggleRecurrence('income')">
                            <label class="form-check-label px-2" for="incomeRecurringToggle">Recurring Income?</label>
                        </div>

                        <div class="mb-3 mt-2" id="incomeRecurrenceGroup" style="display: none;">

                        <!-- Repeat Interval -->
                        <div class="bg-light p-3 rounded shadow-sm mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <span class="input-group-text bg-light border-0">
                                    <i class="bx bx-repeat"></i>
                                </span>
                                <label class="mb-0 me-2">Repeat every</label>
                                <input type="number" class="form-control border-0 bg-light text-center" id="inRecurrenceValue" min="1" value="1" style="width: 80px;">
                                <select class="form-select border-0 bg-light w-auto" id="inRecurrenceUnit">
                                    <option value="day">Day(s)</option>
                                    <option value="week">Week(s)</option>
                                    <option value="month">Month(s)</option>
                                    <option value="year">Year(s)</option>
                                </select>
                            </div>
                        </div>

                        <!-- From Date Block -->
                        <div class="bg-light p-3 rounded shadow-sm mb-3">
                            <label for="fromDate" class="form-label">From</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-0">
                                    <i class="bx bx-calendar"></i>
                                </span>
                                <input id="fromDate" class="form-control border-0 bg-light" type="date">
                            </div>
                        </div>

                        <!-- To Date Block -->
                        <div class="bg-light p-3 rounded shadow-sm">
                            <label for="toDate" class="form-label">To</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-0">
                                    <i class="bx bx-calendar"></i>
                                </span>
                                <input id="toDate" class="form-control border-0 bg-light" type="date">
                            </div>
                        </div>
                    </div>

                    <div class="d-flex mb-3">
                        <input class="form-check bg-dark" type="checkbox" id="incomeReminderToggle" onchange="toggleReminderDate()">
                        <label class="form-check-label px-2" for="incomeReminderToggle">Set a Reminder?</label>
                    </div>

                    <div class="mb-3" id="reminderDateGroup" style="display: none;">
                        <label for="reminderDate" class="form-label">Reminder Date</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0">
                                <i class="bx bx-calendar"></i>
                            </span>
                            <input type="date" class="form-control border-0 bg-light" id="reminderDate">
                        </div>
                    </div>

                    <div class="mt-5">
                        <button type="button" class="header-btn w-100" onclick="recordIncome()">Record Income</button>
                    </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
        
        <!-- Expense Tab -->
        <div class="tab-pane fade" id="cash_expense-panel" role="tabpanel" aria-labelledby="cash_expense-tab">
            <div class="row">
                <div class="col">
                    <div class="card p-3">
                        <form action="" id="expense-form">
                            <div class="">
                                <div class="input-group">
                                    <div class="input-group">
                                    <div class="d-flex justify-content-between w-100 mb-4 bg-light" style="height: 60px;">
                                        <div class="d-flex align-items-center bg-light px-1">
                                            <i class='bx bx-payment' style="color:#11998e;"></i>
                                            <select class="form-select bg-light border-0 b" id="exp_payment_type" name="payment_type">
                                                <option value="cash">Cash</option>
                                                <option value="bank">Bank</option>
                                                <option value="ecocash">Ecocash</option>
                                            </select>
                                        </div>
                                        <div class="d-flex align-items-center bg-light px-1">
                                            <i class='bx bx-wallet'></i>
                                            <select class="form-select bg-light border-0 b" id="exp_currency" name="currency">
                                                {% for currency in currencies %}
                                                    <option value="{{ currency.id }}" {% if currency.default %} selected {% endif %}>{{ currency.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <!-- EXPENSE PANEL: ENTER AMOUNT SECTION WITH FLOATING LABEL AND AMOUNT IN WORDS -->
                                    <div class="mb-4">
                                        <div class="form-floating">
                                            <input type="number" class="form-control border-0 text-center fs-3 bg-light" id="exp_Amount" placeholder="Enter amount" oninput="updateAmountInWords(this, 'exp')" style="height: 60px;">
                                            <label for="exp_Amount" class="text-muted">Enter amount</label>
                                        </div>
                                        <div id="expAmountInWords" class="text-secondary mt-1" style="font-size: 0.95em;"></div>
                                    </div>
                                    </div>
                                </div>
                            </div>

                            <!-- EXPENSE PANEL: Replace first category search with Notes -->
                            <div class="mb-4 d-flex align-items-center bg-light p-2">
                                <span class="input-group-text bg-light border-0">
                                    <i class="bx bx-pencil"></i>
                                </span>
                                <input type="text" class="form-control bg-light border-0" id="expenseNotes" placeholder="Notes">
                            </div>

                            <!-- EXPENSE PANEL: Category Selection (Cleared) -->
                            <div class="mb-4 d-flex gap-2 align-items-start">
                                <div class="w-100">
                                    <label class="form-label">Category</label>
                                    <div class="category-select-panel">
                                        <div class="category-input-wrapper">
                                            <span class="icon"><i class="bi bi-shapes"></i></span>
                                            <input type="text" class="category-input" placeholder="search or add category" readonly onclick="openCategoryPanel('expense')" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4 d-flex flex-column bg-light d-none" id="main-exp" style="height:145px;">
                                <p class="p-1 mt-2">Add sub category under new main category?</p>
                                <div class="d-flex align-items-center">
                                    <div>
                                        <span class="input-group-text bg-light border-0"><i class="bx bx-category"></i></span>
                                    </div>
                                    <div class="search-select bg-light align-items-center me-2" id="exp-main-categories">
                                        <input type="text" class="custom-search-input w-100" placeholder="Search or add  maincategory" autocomplete="off">
                                        <div class="custom-dropdown"></div>
                                        <input type="text" id="exp_main_category_text" class="form-control" hidden/>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center mt-3 p-1">
                                    <label for="accumulate" class="me-2">Use once?</label>
                                    <input class="form-check p-2" type="checkbox" id="id_once">
                                </div>
                            </div>
                                                                
                            <div class="mb-4">
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="bx bx-map"></i></span>
                                    <select class="form-select border-0 bg-light" id="exp_Branch" style="height: 60px;">
                                        {% for branch in branches %}
                                            {% if request.user.role|lower == 'admin' %}
                                                <option value="{{ branch.id}}">{{ branch.name }}</option>
                                            {% elif forloop.first %}
                                                <option value="{{ request.user.branch.id}}">{{ request.user.branch }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="bx bx-user"></i></span>
                                    <select class="form-select border-0 bg-light" id="exp_accountTo" style="height: 60px;">
                                        <option value="">Account to</option>
                                        {% for user in contacts %}
                                            <option value="{{ user.id }}">{{ user.username }} {{ user.name  }}</option>
                                        {% endfor %}
                                    </select>
                                    <button class="btn btn-primary" type="button" id="toggleContactFormBtn">
                                        Add Contact
                                    </button>
                                </div>
                                <!-- Hidden Contact Form -->
                                <div id="inlineContactForm" class="p-3 rounded bg-light mt-3" style="display: none;">
                                    <h5 class="mb-3">Add New Contact</h5>
                                    <form id="contactForm">
                                        <div class="mb-3">
                                            <label for="contactName" class="form-label">Contact Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="contactName" placeholder="" required>
                                        </div>

                                        <div class="mb-3">
                                            <label for="mobileNumber" class="form-label">Mobile Number <small class="text-muted">(Optional)</small></label>
                                            <div class="input-group">
                                                <span class="input-group-text">ðŸ‡®</span>
                                                <input type="tel" class="form-control" id="mobileNumber" placeholder="e.g. +263778587612">
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Contact Type</label>
                                            <div>
                                                <input type="radio" class="btn-check" name="contactType" id="customer" value="Customer" checked>
                                                <label class="btn btn-outline-primary" for="customer">Customer</label>

                                                <input type="radio" class="btn-check" name="contactType" id="supplier" value="Supplier">
                                                <label class="btn btn-outline-primary" for="supplier">Supplier</label>
                                            </div>
                                        </div>

                                        <div class="text-end">
                                            <button type="button" id="contactFormBtn"  class="btn btn-primary">Save</button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <div class="d-flex mb-3">
                                <input type="checkbox" class="form-check" onclick="toggleLoanFields()" id="isLoan"/>
                                <label for="isLoan" class="px-2">Is this a loan?</label>
                            </div>

                            <div id="loanFields" style="display: none;">
                                <div class="bg-light p-3 rounded shadow-sm mb-3">
                                    <label for="loanRepaymentAmount" class="form-label">Repayment Amount</label>
                                    <input type="number" class="form-control border-0 bg-light" id="loanRepaymentAmount" placeholder="e.g. 200.00">
                                </div>
                                
                                <div class="bg-light p-3 rounded shadow-sm mb-3">
                                    <label for="loanInterestRate" class="form-label">Interest Rate (%)</label>
                                    <input type="number" class="form-control border-0 bg-light" id="loanInterestRate" placeholder="e.g. 10">
                                </div>

                                <div class="bg-light p-3 rounded shadow-sm mb-3">
                                    <label for="loanPeriod" class="form-label">Repayment Period</label>
                                    <div class="d-flex gap-2">
                                        <input type="number" class="form-control border-0 bg-light w-50" id="loanPeriodValue" value="1" min="1">
                                        <select id="loanPeriodUnit" class="form-select border-0 bg-light w-50">
                                            <option value="day">Day(s)</option>
                                            <option value="week">Week(s)</option>
                                            <option value="month">Month(s)</option>
                                            <option value="year">Year(s)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex mb-3">
                                <input class="form-check bg-dark" type="checkbox" id="exp_RecurringToggle" onchange="exptoggleRecurrence('income')">
                                <label class="form-check-label px-2" for="exp_RecurringToggle">Recurring Expenses?</label>
                            </div>

                            <div class="mb-3 mt-2" id="exp_RecurrenceGroup" style="display: none;">
                                <!-- Repeat Interval -->
                                <div class="bg-light p-3 rounded shadow-sm mb-3">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="input-group-text bg-light border-0">
                                            <i class="bx bx-repeat"></i>
                                        </span>
                                        <label class="mb-0 me-2">Repeat every</label>
                                        <input type="number" class="form-control border-0 bg-light text-center" id="expRecurrenceValue" min="1" value="1" style="width: 80px;">
                                        <select class="form-select border-0 bg-light w-auto" id="exp_category_textRecurrenceUnit">
                                            <option value="day">Day(s)</option>
                                            <option value="week">Week(s)</option>
                                            <option value="month">Month(s)</option>
                                            <option value="year">Year(s)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- From Date Block -->
                                <div class="bg-light p-3 rounded shadow-sm mb-3">
                                    <label for="fromDate" class="form-label">From</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0">
                                            <i class="bx bx-calendar"></i>
                                        </span>
                                        <input id="exp_fromDate" class="form-control border-0 bg-light" type="date">
                                    </div>
                                </div>

                                <!-- To Date Block -->
                                <div class="bg-light p-3 rounded shadow-sm">
                                    <label for="exp_toDate" class="form-label">To</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0">
                                            <i class="bx bx-calendar"></i>
                                        </span>
                                        <input id="exp_toDate" class="form-control border-0 bg-light" type="date">
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex mb-3">
                                <input class="form-check bg-dark" type="checkbox" id="expReminderToggle" onchange="exptoggleReminderDate()">
                                <label class="form-check-label px-2" for="expcomeReminderToggle">Set a Reminder?</label>
                            </div>

                            <div class="mb-3" id="exp_reminderDateGroup" style="display: none;">
                                <label for="reminderDate" class="form-label">Reminder Date</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0">
                                        <i class="bx bx-calendar"></i>
                                    </span>
                                    <input type="date" class="form-control border-0 bg-light" id="exp_reminderDate">
                                </div>
                            </div>
                        
                            <div class="mt-5">
                                <button type="submit" class="header-btn w-100">Record Expense</button>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- transfer Tab -->
        <div class="tab-pane fade" id="transfer-panel" role="tabpanel" aria-labelledby="transfer_tab">
            <div class="row">
                <div class="col">
                    <div class="card p-3">
                        <div class="input-group">
                            <!-- Transfer Form -->
                            <form id="transferForm" class="w-100">
                                <div class="d-flex justify-content-between w-100 mb-4 bg-light rounded" style="height: 60px;">
                                    <div class="d-flex align-items-center bg-light px-1">
                                        <i class='bx bx-payment' style="color:#11998e;"></i>
                                        <select class="form-select bg-light border-0 b" id="transfer_payment_type" name="payment_type">
                                            <option value="cash">Cash</option>
                                            <option value="bank">Bank</option>
                                            <option value="ecocash">Ecocash</option>
                                        </select>
                                    </div>
                                    <div class="d-flex align-items-center bg-light px-1">
                                        <i class='bx bx-wallet'></i>
                                        <select class="form-select bg-light border-0 b" id="transfer_currency" name="currency">
                                            {% for currency in currencies %}
                                                <option value="{{ currency.id }}" {% if currency.default %} selected {% endif %}>{{ currency.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0"><i class="bx bx-money"></i></span>
                                        <input type="number" class="form-control border-0 text-center fs-3 bg-light" id="transfer_Amount" onclick="clearInput(this)" value="0.00" placeholder="Enter amount" style="height: 100px;">
                                    </div>
                                </div>

                                <div class="w-100 bg-light mb-4 p-2 rounded">
                                    <h6><i class="bx bx-export"></i> From</h6>
                                    <div class="form-section d-flex flex-column w-100">
                                        <div class="mb-4">
                                            <select class="form-select border-1" id="transferFromType" name="transferFromType">
                                                <option value="branch">Branch</option>
                                                <option value="person">Person</option>
                                            </select>
                                        </div>
                                        <div>
                                            <select class="form-select border-1" id="transferFromBranch" name="transferFromBranch">
                                                <option value="">Select Branch</option>
                                                {% for branch in branches %}
                                                    {% if request.user.role|lower == 'admin' %}
                                                        <option value="{{ branch.id}}">{{ branch.name }}</option>
                                                    {% elif forloop.first %}
                                                        <option value="{{ request.user.branch.id}}">{{ request.user.branch }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div id="fromPersonContainer" style="display: none;">
                                            <select class="form-select border-1" id="transferFromPerson" name="fromPerson">
                                                <option value="">Select Person</option>
                                                {% for user in users %}
                                                    <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- To Section -->
                                <div class="bg-light mb-4 p-2 rounded">
                                    <h6><i class="bx bx-import"></i> To</h6>
                                    <div class="form-section mb-4 d-flex bg-light flex-column w-100">
                                        <div class="mb-4">
                                            <select class="form-select border-1" id="transferToType" name="transfertoType">
                                                <option value="branch">Branch</option>
                                                <option value="person">Person</option>
                                            </select>
                                        </div>
                                        <div>
                                            <select class="form-select border-1" id="transferToBranch" name="transfertoBranch">
                                                <option value="">Select Branch</option>
                                                {% for branch in branches %}
                                                    {% if request.user.role|lower == 'admin' %}
                                                        <option value="{{ branch.id}}">{{ branch.name }}</option>
                                                    {% elif forloop.first %}
                                                        <option value="{{ request.user.branch.id}}">{{ request.user.branch }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div id="toPersonContainer" style="display: none;">
                                            <select class="form-select border-1" id="transferToPerson" name="toPerson">
                                                <option value="">Select Person</option>
                                                {% for user in users %}
                                                    <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section mb-4 p-2 bg-light rounded">
                                    <h6><i class="bx bx-note"></i> Description</h6>
                                    <textarea class="form-control" id="transferDescription" name="description" rows="3" placeholder="Transfer description (optional)"></textarea>
                                </div>

                                <button type="submit" class="header-btn w-100">
                                    <span class="button-text">Submit Transfer</span>
                                    <span class="loading">
                                        <i class="bx bx-loader-alt bx-spin"></i> Processing...
                                    </span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add income Category Modal -->
    <div class="modal fade" id="addCatModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <form id="addCategoryForm">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Add Income Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                    <label for="InCategoryName" class="form-label">Category Name</label>
                    <input type="text" class="form-control" id="InCategoryName" name="name" required>
                </div>
                <div class="mb-3">
                    <label for="parentCategory" class="form-label">Parent (optional)</label>
                    <select class="form-select" id="parentCategory" name="parent">
                      <option value="">None</option>
                      {% for cat in income_categories %}
                        <option value="{{ cat.id }}">{{ cat }}</option>
                      {% endfor %}
                      <option value="__create_new__">+ Add New Parent Category</option>
                    </select>
                  </div>
                  <div class="mb-3 d-none" id="newIncomeParentWrapper">
                    <label for="newIncomeParentInput" class="form-label">New Parent Category</label>
                    <input type="text" class="form-control" id="newIncomeParentInput" placeholder="Type new parent category">
                  </div>
              </div>
              <div class="modal-footer">
                <button type="button" id="saveCatBtn" class="btn btn-success">Save</button>
              </div>
            </div>
          </form>
        </div>
    </div>

    <!-- Add Expense Category Modal -->
    <div class="modal fade" id="addExpenseCategoryModal" tabindex="-1" aria-labelledby="addExpenseCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title">Add Expense Category</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
            <div class="mb-3">
                <label for="expenseCategoryName" class="form-label">Name</label>
                <input type="text" class="form-control" id="expenseCategoryName" required>
            </div>
            <div class="mb-3">
                <label for="expenseParentCategory" class="form-label">Parent (optional)</label>
                <select class="form-select" id="expenseParentCategory">
                <option value="">None</option>
                {% for cat in expense_categories %}
                    {% if not cat.parent %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endif %}
                {% endfor %}
                <option value="__create_new__">+ Add New Parent</option>
                </select>
            </div>
            <div class="mb-3 d-none" id="expenseNewParentWrapper">
                <label for="expenseNewParentInput" class="form-label">New Parent Name</label>
                <input type="text" class="form-control" id="expenseNewParentInput" placeholder="Type new parent category">
            </div>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-success" id="saveExpenseCategoryBtn">Save</button>
            </div>
        </div>
        </div>
    </div>
    
    <!-- Add Income Category Modal -->
    <div class="modal fade" id="addIncomeCategoryModal" tabindex="-1" aria-labelledby="addIncomeCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-0">
            <div class="modal-header">
                <h5 class="modal-title" id="addIncomeCategoryModalLabel"><i class="bx bx-plus-circle me-2"></i>Add Income Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addIncomeCategoryForm">
                <div class="mb-3">
                    <label for="newIncomeCategoryName" class="form-label">Category Name</label>
                    <input type="text" class="form-control" id="newIncomeCategoryName" name="name" required>
                </div>
                <div class="text-end">
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
                </form>
            </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loan-modal" tabindex="-1" aria-labelledby="addIncomeCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-0">
            <div class="modal-header">
                <h5 class="modal-title" id="addIncomeCategoryModalLabel"><i class="bx bx-plus-circle me-2"></i>Enter loan details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                to be made
            </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addContactModal" tabindex="-1" aria-labelledby="addContactModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content p-3">
            <div class="modal-header">
                <h5 class="modal-title" id="addContactModalLabel">Add New Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="contactForm">
                <div class="mb-3">
                    <label for="contactName" class="form-label">Contact Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="contactName" placeholder="" required>
                </div>

                <div class="mb-3">
                    <label for="mobileNumber" class="form-label">Mobile Number <small class="text-muted">(Optional)</small></label>
                    <div class="input-group">
                    <span class="input-group-text">ðŸ‡®</span>
                    <input type="tel" class="form-control" id="mobileNumber" placeholder="e.g. +263778587612">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Contact Type</label>
                    <div>
                    <input type="radio" class="btn-check" name="contactType" id="customer" value="Customer" checked>
                    <label class="btn btn-outline-primary" for="customer">Customer</label>

                    <input type="radio" class="btn-check" name="contactType" id="supplier" value="Supplier">
                    <label class="btn btn-outline-primary" for="supplier">Supplier</label>
                    </div>
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
                </form>
            </div>
            </div>
        </div>
    </div>

    <!-- CATEGORY SIDE PANEL (OFFCANVAS) -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="categorySelectOffcanvas" aria-labelledby="categorySelectOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="categorySelectOffcanvasLabel">Select Category</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <input type="text" class="form-control mb-3" placeholder="Search categories...">
            <div class="category-list">
                <div class="main-category-card">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <span class="main-category-icon"><i class="bi bi-geo-alt-fill"></i></span>
                            <span class="fw-bold main-category-title-green">Travel</span>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary rounded-circle main-category-plus-btn" onclick="openEditSubcategoryModal('Travel', ['Car','Lunch','Bike'])"><i class="bi bi-plus"></i></button>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge category-pill">Car</span>
                        <span class="badge category-pill">Lunch</span>
                        <span class="badge category-pill">Bike</span>
                    </div>
                </div>
                <div class="main-category-card">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <span class="main-category-icon"><i class="bi bi-tools"></i></span>
                            <span class="fw-bold main-category-title-green">Repairs</span>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary rounded-circle main-category-plus-btn" onclick="openEditSubcategoryModal('Repairs', ['Phone','Laptop','Home'])"><i class="bi bi-plus"></i></button>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge category-pill">Phone</span>
                        <span class="badge category-pill">Laptop</span>
                        <span class="badge category-pill">Home</span>
                    </div>
                </div>
                <div class="main-category-card">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <span class="main-category-icon"><i class="bi bi-cash-coin"></i></span>
                            <span class="fw-bold main-category-title-green">Salary</span>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary rounded-circle main-category-plus-btn" onclick="openEditSubcategoryModal('Salary', ['Monthly','Bonus','Freelance'])"><i class="bi bi-plus"></i></button>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge category-pill">Monthly</span>
                        <span class="badge category-pill">Bonus</span>
                        <span class="badge category-pill">Freelance</span>
                    </div>
                </div>
            </div>
            <div class="add-category-row">
                <div></div>
                <div class="add-category-link" onclick="openAddCategoryInlineModal()">
                    <i class="bi bi-plus"></i>
                    Add New Category
                </div>
            </div>
            <!-- Inline Add Category Modal (hidden by default) -->
            <div id="addCategoryInlineModal" style="display:none;">
                <button class="close-btn" onclick="closeAddCategoryInlineModal()">&times;</button>
                <h5 class="offcanvas-title w-100 text-center mb-3">Add New Category</h5>
                <form onsubmit="saveCategory(event)">
                    <div class="mb-3">
                        <label for="newCategoryNameInline" class="form-label">Enter the category name</label>
                        <input type="text" class="form-control" id="newCategoryNameInline" placeholder="Category name">
                    </div>
                    <div class="mb-3">
                        <label for="newSubCategoryNameInline" class="form-label">Add up to 3 subcategories</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newSubCategoryNameInline" placeholder="Subcategory name">
                            <button class="btn btn-outline-primary add-sub-btn" type="button" id="addSubBtnInline"><span style="font-size:1.2em;font-weight:bold;line-height:1;">+</span></button>
                        </div>
                        <div id="subCategoryListInline" class="d-flex gap-2 mt-2"></div>
                    </div>
                    <div class="action-btns">
                        <button type="button" class="btn btn-outline-primary" onclick="closeAddCategoryInlineModal()">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal for editing subcategories (ensure this is outside any conditional blocks and at the end of body) -->
    <div id="editSubcategoryModal" class="modal-category-edit">
        <div class="modal-content">
            <button class="close-btn" onclick="closeEditSubcategoryModal()">&times;</button>
            <h5 id="editSubcategoryModalTitle" class="mb-3"></h5>
            <div id="editSubcategoryList" class="mb-3"></div>
            <div class="input-group mb-3">
                <input type="text" id="newSubcategoryInput" class="form-control" placeholder="Add new subcategory">
                <button class="btn btn-outline-primary" type="button" onclick="addNewSubcategory()">Add</button>
            </div>
        </div>
    </div>

<script>
let categoriesData = [];
let expense_child_categories = [];
let expense_main_categories = [];
let income_child_categories = [];
let income_main_categories = [];


const loanModal = new bootstrap.Modal(document.getElementById('loan-modal'));
function clearInput(el){
    el.value = '';
}

    document.getElementById('toggleContactFormBtn').addEventListener('click', function () {
        const form = document.getElementById('inlineContactForm');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    });

    document.getElementById('contactFormBtn').addEventListener('click', async function (e) {
        e.preventDefault();

        console.log('here')

        const name = document.getElementById('contactName').value.trim();
        const mobile = document.getElementById('mobileNumber').value.trim();
        const contactType = document.querySelector('input[name="contactType"]:checked').value;

        if (!name) {
            alert("Contact name is required.");
            return;
        }

        try {
            const response = await fetch("{% url 'finance:create_contact' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    name: name,
                    mobile: mobile,
                    type: contactType
                })
            });

            const result = await response.json();

            if (response.ok) {
                const select = document.getElementById('exp_accountTo');
                const option = document.createElement('option');
                option.value = result.id;
                option.text = result.name;
                option.selected = true;
                select.appendChild(option);
                document.getElementById('inlineContactForm').style.display = 'none';
                document.getElementById('contactForm').reset();

                Toastify({
                    text: "Contact added successfully!",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#28a745",
                }).showToast();
            } else {
                Toastify({
                    text: result.error || "An error occurred.",
                    duration: 4000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#dc3545",
                }).showToast();
            }

        }catch (error) {
            console.error("Error:", error);
            Toastify({
                text: "Failed to add contact. Please try again.",
                duration: 4000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "#dc3545",
            }).showToast();
        }
    });

function showLoanModal(){
    loanModal.show()
}

function toggleLoanFields() {
    const isLoan = document.getElementById("isLoan").checked;
    const loanFields = document.getElementById("loanFields");

    if (isLoan) {
        loanFields.style.display = "block";
    } else {
        loanFields.style.display = "none";
    }
}

function openAddContactModal() {
    const cashOutCanvas = document.getElementById('cashOutCanvas');
    const bsOffcanvas = new bootstrap.Offcanvas(cashOutCanvas);
    const modalElement = document.getElementById('addContactModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    bsOffcanvas.hide();

    console.log('here')
}

document.addEventListener("DOMContentLoaded", function() {
    const fromType = document.getElementById("transferFromType");
    const fromBranch = document.getElementById("transferFromBranch");
    const fromPersonContainer = document.getElementById("fromPersonContainer");

    const toType = document.getElementById("transferToType");
    const toBranch = document.getElementById("transferToBranch");
    const toPersonContainer = document.getElementById("toPersonContainer");

    function toggleFromFields() {
        if (fromType.value === "branch") {
            fromBranch.parentElement.style.display = "block";
            fromPersonContainer.style.display = "none";
        } else {
            fromBranch.parentElement.style.display = "none";
            fromPersonContainer.style.display = "block";
        }
    }

    function toggleToFields() {
        if (toType.value === "branch") {
            toBranch.parentElement.style.display = "block";
            toPersonContainer.style.display = "none";
        } else {
            toBranch.parentElement.style.display = "none";
            toPersonContainer.style.display = "block";
        }
    }

    fromType.addEventListener("change", toggleFromFields);
    toType.addEventListener("change", toggleToFields);

    toggleFromFields();
    toggleToFields();
})

class CustomSearchSelect {
    constructor(containerId, options = {}) {
        this.container = document.getElementById(containerId);
        this.input = this.container.querySelector('.custom-search-input');
        this.dropdown = this.container.querySelector('.custom-dropdown');
        this.hiddenInput = options.hiddenInput;
        this.data = options.data || [];
        this.newOptions = []; 
        this.placeholder = options.placeholder || 'Search...';
        this.onSelect = options.onSelect || (() => {});
        this.onAddNew = options.onAddNew || (() => {});
        this.selectedValue = null;
        this.selectedText = null;
        this.highlightedIndex = -1;
        this.filteredData = [...this.data];
        this.allowAddNew = options.allowAddNew !== false; 

        this.init();
    }

    init() {
        this.input.placeholder = this.placeholder;
        this.bindEvents();
    }

    bindEvents() {
        this.input.addEventListener('input', (e) => this.handleInput(e));
        this.input.addEventListener('focus', () => this.showDropdown());
        this.input.addEventListener('keydown', (e) => this.handleKeydown(e));

        document.addEventListener('click', (e) => {
            if (!this.container.contains(e.target)) {
                this.hideDropdown();
            }
        });
    }

    handleInput(e) {
        const query = e.target.value.toLowerCase().trim();
        
        this.filteredData = this.data.filter(item => 
            item.name.toLowerCase().includes(query)
        );

        this.highlightedIndex = -1;
        this.renderDropdown(query);
        this.showDropdown();
    }

    handleKeydown(e) {
        const totalItems = this.getTotalDropdownItems();
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                this.highlightedIndex = Math.min(this.highlightedIndex + 1, totalItems - 1);
                this.updateHighlight();
                break;
            case 'ArrowUp':
                e.preventDefault();
                this.highlightedIndex = Math.max(this.highlightedIndex - 1, -1);
                this.updateHighlight();
                break;
            case 'Enter':
                e.preventDefault();
                this.handleEnterKey();
                break;
            case 'Escape':
                this.hideDropdown();
                this.input.blur();
                break;
        }
    }

    handleEnterKey() {
        if (this.highlightedIndex >= 0) {
            const isAddNewOption = this.highlightedIndex >= this.filteredData.length;
            
            if (isAddNewOption) {
                const newText = this.input.value.trim();
                this.addNewOption(newText);
            } else {
                this.selectItem(this.filteredData[this.highlightedIndex]);
            }
        }
    }

    getTotalDropdownItems() {
        let total = this.filteredData.length;
        
        const query = this.input.value.trim();
        if (this.shouldShowAddNew(query)) {
            total += 1;
        }
        
        return total;
    }

    shouldShowAddNew(query) {
        if (!this.allowAddNew || !query) return false;

        const exactMatch = this.data.some(item => 
            item.name.toLowerCase() === query.toLowerCase()
        );
        
        return !exactMatch;
    }

    showDropdown() {
        const query = this.input.value.trim();
        if (this.filteredData.length > 0 || this.shouldShowAddNew(query)) {
            this.renderDropdown(query);
            this.dropdown.classList.add('show');
        }
    }

    hideDropdown() {
        this.dropdown.classList.remove('show');
        this.highlightedIndex = -1;
    }

    renderDropdown(query = '') {
        let html = '';
        
        if (this.filteredData.length === 0 && !this.shouldShowAddNew(query)) {
            html = '<div class="no-results">No results found</div>';
        } else {
            html = this.filteredData.map((item, index) => `
                <div class="custom-dropdown-item" data-index="${index}" data-type="existing">
                    ${item.name}
                    ${this.newOptions.includes(item.value) ? '<span class="new-option-badge">NEW</span>' : ''}
                </div>
            `).join('');
            
            if (this.shouldShowAddNew(query)) {
                html += `
                    <div class="custom-dropdown-item add-new" data-type="add-new">
                        <span class="add-icon">+</span>
                        Add "${query}"
                    </div>
                `;
            }
        }

        this.dropdown.innerHTML = html;

        this.dropdown.querySelectorAll('.custom-dropdown-item').forEach((item, index) => {
            item.addEventListener('click', () => {
                const type = item.dataset.type;
                
                if (type === 'add-new') {
                    this.addNewOption(query);
                } else {
                    const dataIndex = parseInt(item.dataset.index);
                    this.selectItem(this.filteredData[dataIndex]);
                }
            });
        });
    }

    updateHighlight() {
        const items = this.dropdown.querySelectorAll('.custom-dropdown-item');
        items.forEach((item, index) => {
            item.classList.toggle('highlighted', index === this.highlightedIndex);
        });

        if (this.highlightedIndex >= 0 && items[this.highlightedIndex]) {
            items[this.highlightedIndex].scrollIntoView({
                block: 'nearest',
                behavior: 'smooth'
            });
        }
    }

    addNewOption(text) {
        if (!text) return;
        
        const newOption = {
            id: `new_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            name: text,
            value: `new_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            text: text,
            isNew: true
        };
        
        this.data.push(newOption);
        this.newOptions.push(newOption.value);
        
        this.selectItem(newOption);
        
        this.onAddNew(newOption);
    }

    selectItem(item) {
        this.selectedValue = item.value || item.id;
        this.selectedText = item.text || item.name;
        this.input.value = item.text || item.name;
        
        if (this.hiddenInput) {
            this.hiddenInput.value = item.value || item.id;
        }
        
        this.hideDropdown();
        this.onSelect(item);
    }

    setValue(value, text) {
        this.selectedValue = value;
        this.selectedText = text;
        this.input.value = text;
        
        if (this.hiddenInput) {
            this.hiddenInput.value = value;
        }
    }

    getValue() {
        return {
            value: this.selectedValue,
            text: this.selectedText,
            isNew: this.newOptions.includes(this.selectedValue)
        };
    }

    getNewOptions() {
        return this.data.filter(item => this.newOptions.includes(item.value));
    }

    setData(newData) {
        this.data = newData.map(item => {
            if (typeof item === 'string') {
                return { value: item, text: item, name: item };
            }
            return {
                ...item,
                value: item.value || item.id,
                text: item.text || item.name,
                name: item.name || item.text
            };
        });
        this.filteredData = [...this.data];
    }
}

const categorySearchSelect = new CustomSearchSelect('categories', {
    data: income_child_categories,
    placeholder: 'Search or add category...',
    onSelect: (item) => {
        console.log('Category selected:', item);
    },
    onAddNew: (item) => {
        console.log('New category added:', item);
    }
});


const mainCategorySearchSelect = new CustomSearchSelect('main-categories', {
    data: income_main_categories,
    placeholder: 'Search or add category...',
    onSelect: (item) => {
        console.log('Category selected:', item);
    },
    onAddNew: (item) => {
        console.log('New category added:', item);
    }
});


const expCategorySearchSelect = new CustomSearchSelect('exp-categories', {
    data: expense_child_categories,
    placeholder: 'Search or add category...',
    onSelect: (item) => {
        console.log('Category selected:', item);
    },
    onAddNew: (item) => {
        const catEL = document.getElementById('main-exp');
        catEL.classList.toggle('d-none');
        console.log('New category added:', item);
    }
});


const expMainCategorySearchSelect = new CustomSearchSelect('exp-main-categories', {
    data: expense_main_categories,
    placeholder: 'Search or add category...',
    onSelect: (item) => {
        console.log('Category selected:', item);
    },
    onAddNew: (item) => {
        console.log('New category added:', item);
    }
});

function toggleRecurrence(type) {
    const toggle = document.getElementById(`${type}RecurringToggle`);
    const group = document.getElementById(`${type}RecurrenceGroup`);
    if (group) {
        group.style.display = toggle.checked ? 'block' : 'none';
    }
}

function toggleReminderDate() {
    const toggle = document.getElementById('incomeReminderToggle');
    const dateGroup = document.getElementById('reminderDateGroup');
    dateGroup.style.display = toggle.checked ? 'block' : 'none';
}

function exptoggleRecurrence() {
    const toggle = document.getElementById('exp_RecurringToggle');
    const section = document.getElementById('exp_RecurrenceGroup');
    section.style.display = toggle.checked ? 'block' : 'none';
}

function exptoggleReminderDate() {
    const toggle = document.getElementById('expReminderToggle');
    const section = document.getElementById('exp_reminderDateGroup');
    section.style.display = toggle.checked ? 'block' : 'none';
}

async function recordIncome() {
    try {
        const formData = {
            amount: parseFloat(document.getElementById('inAmount')?.value) || 0,
            currency: document.getElementById('currency')?.value,
            category: categorySearchSelect.getValue(),
            main_category: mainCategorySearchSelect.getValue(),
            branch: document.getElementById('inBranch')?.value,
            account_to: document.getElementById('accountTo')?.value,
            is_recurring: document.getElementById('incomeRecurringToggle')?.checked,
            has_reminder: document.getElementById('incomeReminderToggle')?.checked,
            recurrence_value: document.getElementById('inRecurrenceValue').value,
            recurrence_unit: document.getElementById('inRecurrenceUnit')?.value,
            from_date: document.getElementById('fromDate')?.value,
            to_date: document.getElementById('toDate')?.value,
            reminder_dated: document.getElementById('reminderDate')?.value,
        };

        if (formData.amount <= 0) {
            showToast("Please enter a valid amount", "#dc3545");
            return;
        }

        if (!formData.currency) {
            showToast("Please select a currency", "#dc3545");
            return;
        }

        if (!formData.category?.value && !formData.income_category) {
            showToast("Please select or add a category", "#dc3545");
            return;
        }

        const submitButton = document.querySelector('.header-btn');
        const originalText = submitButton.textContent;
        submitButton.textContent = 'Recording...';
        submitButton.disabled = true;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const response = await fetch('/finance/record_income/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            Toastify({
                text: "Income transaction submitted successfully!",
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "#28a745",
                stopOnFocus: true,
            }).showToast();

            loadCashbookData(1, false, formData['currency']);
            console.log('data loaded')
        } else {
            Toastify({
                text: `${data.message || "Submission failed."}`,
                duration: 4000,
                gravity: "top",
                position: "right",
                backgroundColor: "#dc3545",
                stopOnFocus: true,
            }).showToast();
            
        }
    } catch (error) {
        console.error('Error recording income:', error);
        Toastify({
            text: `An unexpected error occurred. Please try again.`,
            duration: 4000,
            gravity: "top",
            position: "right",
            backgroundColor: "#dc3545",
            stopOnFocus: true,
        }).showToast();
    } finally {
        const submitButton = document.querySelector('.header-btn');
        submitButton.textContent = 'Record Income';
        submitButton.disabled = false;
    }
}

function showToast(message, type = "success") {
    Toastify({
        text: message,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: "#28a745" ,
        stopOnFocus: true,
    }).showToast();
}

document.getElementById("expense-form").addEventListener("submit", function (e) {
    e.preventDefault();
    recordExpense();
});

async function recordExpense() {
    try {
        const formData = {
            amount: parseFloat(document.getElementById('exp_Amount')?.value) || 0,
            currency: document.getElementById('exp_currency')?.value,
            category: expCategorySearchSelect.getValue(),
            main_category: expMainCategorySearchSelect.getValue(),
            branch: document.getElementById('exp_Branch')?.value,
            account_to: document.getElementById('exp_accountTo')?.value,
            is_recurring: document.getElementById('exp_RecurringToggle')?.checked,
            has_reminder: document.getElementById('expReminderToggle')?.checked,
            recurrence_value: document.getElementById('expRecurrenceValue')?.value,
            recurrence_unit: document.getElementById('exp_category_textRecurrenceUnit')?.value,
            from_date: document.getElementById('exp_fromDate')?.value,
            to_date: document.getElementById('exp_toDate')?.value,
            reminder_date: document.getElementById('exp_reminderDate')?.value,
            payment_type: document.getElementById('exp_payment_type')?.value,
            is_loan: document.getElementById('isLoan')?.checked,
            loan_repayment_amount: document.getElementById('loanRepaymentAmount')?.value,
            loan_interest_rate: document.getElementById('loanInterestRate')?.value,
            loan_period_value: document.getElementById('loanPeriodValue')?.value,
            loan_period_unit: document.getElementById('loanPeriodUnit')?.value,
        };
       
        if (isNaN(formData['amount']) || formData['amount'] <= 0) {
            Toastify({
                text: `Amount must be greater than zero.`,
                duration: 4000,
                gravity: "top",
                position: "right",
                backgroundColor: "#dc3545",
                stopOnFocus: true,
            }).showToast();
            return;
        }

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const response = await fetch("/finance/create_expense/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok && result.success) {
            Toastify({
                text: "Expense submitted successfully!",
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "#28a745",
                stopOnFocus: true,
            }).showToast();

            document.getElementById("expense-form").reset();
            document.getElementById("loanFields").style.display = "none";
            document.getElementById("exp_RecurrenceGroup").style.display = "none";
            document.getElementById("exp_reminderDateGroup").style.display = "none";

            loadCashbookData(1, false, formData['currency']);
        } else {
            Toastify({
                text: `${result.message || "Submission failed."}`,
                duration: 4000,
                gravity: "top",
                position: "right",
                backgroundColor: "#dc3545",
                stopOnFocus: true,
            }).showToast();
        }

    } catch (error) {
        console.error("Error:", error);
        Toastify({
            text: "Something went wrong. Please try again.",
            duration: 4000,
            gravity: "top",
            position: "right",
            backgroundColor: "#dc3545",
            stopOnFocus: true,
        }).showToast();
    }
}

const transferForm = document.getElementById("transferForm");
const submitBtn = transferForm.querySelector("button[type='submit']");
const submitText = submitBtn.querySelector(".button-text");
const loadingSpinner = submitBtn.querySelector(".loading");

transferForm.addEventListener("submit", function (e) {
    e.preventDefault();

    submitBtn.disabled = true;
    submitText.style.display = "none";
    loadingSpinner.style.display = "inline-flex";
    e.preventDefault();

    const inputs = transferForm.querySelectorAll("[id^='transfer']");
    const fromType = document.getElementById("transferFromType");
    const toType = document.getElementById("transferToType");
    const formData = {};

    inputs.forEach((input) => {
        const id = input.id.replace("transfer", "").toLowerCase();
        if (input.type === "checkbox") {
            formData[id] = input.checked;
        } else {
            formData[id] = input.value;
        }
    });

    formData["fromtype"] = fromType.value;
    formData["totype"] = toType.value;

    console.log("Submitting transfer:", formData);

    fetch("/finance/create_transfer/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"), 
        },
        body: JSON.stringify(formData),
    })
    .then((response) => response.json())
    .then((data) => {
        if (data.success) {
            Toastify({
                text: "Transfer submitted successfully!",
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "#28a745",
                stopOnFocus: true,
            }).showToast();

            transferForm.reset();
            loadCashbookData(1, false, formData['_currency']);
        } else {
            Toastify({
                text: `${data.message || "Submission failed."}`,
                duration: 4000,
                gravity: "top",
                position: "right",
                backgroundColor: "#dc3545",
                stopOnFocus: true,
            }).showToast();
        }
    })
    .catch((error) => {
        console.error("Error submitting transfer:", error);
        Toastify({
            text: "Something went wrong. Please try again.",
            duration: 4000,
            gravity: "top",
            position: "right",
            backgroundColor: "#dc3545",
            stopOnFocus: true,
        }).showToast();
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitText.style.display = "inline";
        loadingSpinner.style.display = "none";
    });
});

document.addEventListener('DOMContentLoaded', function() {
    const currencySelect = document.getElementById('currency');
    if (!currencySelect.value) {
        const defaultOption = currencySelect.querySelector('option[selected]');
        if (defaultOption) {
            currencySelect.value = defaultOption.value;
        }
    }
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('fromDate').value = today;
});

function showTab(tab) {
  // Hide all panels
  document.getElementById('incomeTabPanel').style.display = 'none';
  document.getElementById('expenseTabPanel').style.display = 'none';
  document.getElementById('transferTabPanel').style.display = 'none';
  // Reset all button classes
  document.getElementById('tabIncomeBtn').className = 'btn btn-outline-success';
  document.getElementById('tabExpenseBtn').className = 'btn btn-danger';
  document.getElementById('tabTransferBtn').className = 'btn btn-outline-info';
  // Show selected panel and update button style
  if (tab === 'income') {
    document.getElementById('incomeTabPanel').style.display = 'block';
    document.getElementById('tabIncomeBtn').className = 'btn btn-outline-success active';
  } else if (tab === 'expense') {
    document.getElementById('expenseTabPanel').style.display = 'block';
    document.getElementById('tabExpenseBtn').className = 'btn btn-primary active';
  } else if (tab === 'transfer') {
    document.getElementById('transferTabPanel').style.display = 'block';
    document.getElementById('tabTransferBtn').className = 'btn btn-outline-info active';
  }
}
// Set default tab on open
var offcanvasEl = document.getElementById('recordTransactionOffcanvas');
offcanvasEl.addEventListener('show.bs.offcanvas', function () {
  showTab('income');
});

// Amount in words logic
function updateAmountInWords(input, prefix) {
    const value = input.value;
    const words = value ? numberToWords(parseInt(value)) : '';
    const target = prefix === 'exp' ? 'expAmountInWords' : 'amountInWords';
    document.getElementById(target).textContent = words;
}
// Simple number to words (English, up to 9999 for demo)
function numberToWords(num) {
    if (!num) return '';
    const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
    const teens = ['', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
    const tens = ['', 'Ten', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
    let word = '';
    if (num < 10) word = ones[num];
    else if (num < 20) word = teens[num - 10];
    else if (num < 100) word = tens[Math.floor(num / 10)] + (num % 10 ? ' ' + ones[num % 10] : '');
    else if (num < 1000) word = ones[Math.floor(num / 100)] + ' Hundred' + (num % 100 ? ' ' + numberToWords(num % 100) : '');
    else if (num < 10000) word = ones[Math.floor(num / 1000)] + ' Thousand' + (num % 1000 ? ' ' + numberToWords(num % 1000) : '');
    else word = num.toString();
    return word;
}
// Open category panel
function openCategoryPanel(type) {
    const offcanvas = new bootstrap.Offcanvas(document.getElementById('categorySelectOffcanvas'));
    offcanvas.show();
}
function openAddCategorySheet() {
    const sheet = new bootstrap.Offcanvas(document.getElementById('addCategoryBottomSheet'));
    sheet.show();
}
// Add subcategory logic
let subcategories = [];
document.getElementById('addSubBtn')?.addEventListener('click', function() {
    const input = document.getElementById('newSubCategoryName');
    const val = input.value.trim();
    if (val && subcategories.length < 3) {
        subcategories.push(val);
        renderSubcategories();
        input.value = '';
    }
});
function renderSubcategories() {
    const list = document.getElementById('subCategoryList');
    list.innerHTML = '';
    subcategories.forEach((sub, idx) => {
        const pill = document.createElement('span');
        pill.className = 'badge category-pill';
        pill.textContent = sub;
        pill.style.cursor = 'pointer';
        pill.onclick = () => {
            subcategories.splice(idx, 1);
            renderSubcategories();
        };
        list.appendChild(pill);
    });
}

// Inline Add Category Modal logic
function openAddCategoryInlineModal() {
    document.getElementById('addCategoryInlineModal').style.display = 'block';
    document.getElementById('newCategoryNameInline').value = '';
    document.getElementById('newSubCategoryNameInline').value = '';
    subcategoriesInline = [];
    renderSubcategoriesInline();
}
function closeAddCategoryInlineModal() {
    document.getElementById('addCategoryInlineModal').style.display = 'none';
}
let subcategoriesInline = [];
document.getElementById('addSubBtnInline')?.addEventListener('click', function() {
    const input = document.getElementById('newSubCategoryNameInline');
    const val = input.value.trim();
    if (val && subcategoriesInline.length < 3) {
        subcategoriesInline.push(val);
        renderSubcategoriesInline();
        input.value = '';
    }
    if (subcategoriesInline.length >= 3) {
        document.getElementById('addSubBtnInline').disabled = true;
    } else {
        document.getElementById('addSubBtnInline').disabled = false;
    }
});
function renderSubcategoriesInline() {
    const list = document.getElementById('subCategoryListInline');
    list.innerHTML = '';
    subcategoriesInline.forEach((sub, idx) => {
        const pill = document.createElement('span');
        pill.className = 'badge category-pill';
        pill.textContent = sub;
        pill.style.cursor = 'pointer';
        pill.onclick = () => {
            subcategoriesInline.splice(idx, 1);
            renderSubcategoriesInline();
            if (subcategoriesInline.length < 3) {
                document.getElementById('addSubBtnInline').disabled = false;
            }
        };
        list.appendChild(pill);
    });
    if (subcategoriesInline.length >= 3) {
        document.getElementById('addSubBtnInline').disabled = true;
    } else {
        document.getElementById('addSubBtnInline').disabled = false;
    }
}
function saveCategory(e) {
    e.preventDefault();
    // Add your save logic here
    closeAddCategoryInlineModal();
}

// Modal logic for editing subcategories (ensure global scope)
window.currentEditMainCategory = '';
window.currentEditSubcategories = [];
function openEditSubcategoryModal(mainCategory, subcategories) {
    window.currentEditMainCategory = mainCategory;
    window.currentEditSubcategories = [...subcategories];
    document.getElementById('editSubcategoryModalTitle').textContent = mainCategory + ' Subcategories';
    renderEditSubcategoryList();
    document.getElementById('editSubcategoryModal').style.display = 'flex';
}
function closeEditSubcategoryModal() {
    document.getElementById('editSubcategoryModal').style.display = 'none';
}
function renderEditSubcategoryList() {
    const list = document.getElementById('editSubcategoryList');
    list.innerHTML = '';
    window.currentEditSubcategories.forEach((sub, idx) => {
        const pill = document.createElement('span');
        pill.className = 'subcat-pill';
        pill.textContent = sub;
        const removeBtn = document.createElement('span');
        removeBtn.className = 'remove-subcat';
        removeBtn.innerHTML = '&times;';
        removeBtn.onclick = () => {
            window.currentEditSubcategories.splice(idx, 1);
            renderEditSubcategoryList();
        };
        pill.appendChild(removeBtn);
        list.appendChild(pill);
    });
}
function addNewSubcategory() {
    const input = document.getElementById('newSubcategoryInput');
    const val = input.value.trim();
    if (val && !window.currentEditSubcategories.includes(val)) {
        window.currentEditSubcategories.push(val);
        renderEditSubcategoryList();
        input.value = '';
    }
}

</script>
</body>
</html>