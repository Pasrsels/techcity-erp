{% extends "base.html" %}
{% load static %}
{% block title %}Cash Flow{% endblock title %}
{% block content %}
<style>
    .filter-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .action-buttons .btn {
        transition: all 0.3s ease;
    }

    .action-buttons .btn:hover {
        transform: translateY(-2px);
    }

    .table th {
        background-color: #2c3e50;
        color: white;
        font-weight: 500;
    }

    .table tbody tr {
        transition: all 0.2s ease;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }

    .income-amount {
        color: #2ecc71;
        font-weight: 500;
    }

    .expense-amount {
        color: #e74c3c;
        font-weight: 500;
    }

    .modal-content {
        border-radius: 12px;
    }

    .form-control:focus {
        box-shadow: none;
        border-color: #3498db;
    }

    .stats-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .modal-header {
        background-color: #f8f9fa;
        border-radius: 12px 12px 0 0;
    }

    .category-select {
        border-radius: 6px;
        padding: 8px;
        width: 100%;
        margin-bottom: 10px;
    }
    
    /* Bottom Navigation Styles */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #ffffff;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-around;
        padding: 12px 0;
        z-index: 1000;
    }
    
    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: #6c757d;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .nav-item:hover, .nav-item.active {
        color: #3498db;
    }
    
    .nav-icon {
        font-size: 24px;
        margin-bottom: 4px;
    }
    
    .nav-text {
        font-size: 12px;
        font-weight: 500;
    }
    
    /* Add padding to main content to prevent overlap with nav */
    .container-fluid {
        padding-bottom: 70px;
    }

    .active{
        background: #3498db;
    }
</style>
<div>
    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class='d-flex align-items-center'>
                <h2 class="">Cash Flow Management</h2>
                <div class="px-2">
                    <div class="card-body">                    
                        <!-- Quick filter buttons -->
                        <div class="btn-group mb-3" role="group" aria-label="Time filters">
                            <a href="{% url 'finance:cash_flow' %}?filter_type=today" class="btn btn-outline-primary {% if filter_type == 'today' %}active{% endif %}">Today</a>
                            <a href="{% url 'finance:cash_flow' %}?filter_type=weekly" class="btn btn-outline-primary {% if filter_type == 'weekly' %}active{% endif %}">Weekly</a>
                            <a href="{% url 'finance:cash_flow' %}?filter_type=monthly" class="btn btn-outline-primary {% if filter_type == 'monthly' %}active{% endif %}">Monthly</a>
                            <a href="{% url 'finance:cash_flow' %}?filter_type=yearly" class="btn btn-outline-primary {% if filter_type == 'yearly' %}active{% endif %}">Yearly</a>
                            <a href="{% url 'finance:cash_flow' %}?filter_type=custom" class="btn btn-outline-primary {% if filter_type == 'custom' %}active{% endif %}">Custom</a>
                        </div>
                        
                        <!-- Custom date range form, shown only when custom is selected -->
                        <form method="get" id="dateRangeForm" class="{% if filter_type != 'custom' %}d-none{% endif %}">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="start_date">Start Date:</label>
                                    <input type="date" id="start_date" name="start_date" value="{{ start_date }}" class="form-control">
                                </div>
                                <div class="col-md-4">
                                    <label for="end_date">End Date:</label>
                                    <input type="date" id="end_date" name="end_date" value="{{ end_date }}" class="form-control">
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <input type="hidden" name="filter_type" value="custom">
                                    <button type="submit" class="btn btn-primary">Apply Filter</button>
                                </div>
                            </div>
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-sm btn-outline-dark" id="expenseBtn">
                   Income/Expense
                </button>
            </div>
        </div>

         <!-- Stats Cards -->
         {% comment %} <div class="row mb-1">
            <div class="col-md-3">
                <div class="stats-card">
                    <h6 class="text-muted">Total Income</h6>
                    <h3 class="income-amount">$<span id="totalIncome">{{ total_income }}</span></h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h6 class="text-muted">Total Expenses</h6>
                    <h3 class="expense-amount">$<span id="totalExpenses">{{ expenses_total }}</span></h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h6 class="text-muted">Net Cash Flow</h6>
                    <h3>$<span id="netCashFlow">{{ balance }}</span></h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h6 class="text-muted">Pending Receivables</h6>
                    <h3>$<span id="pendingReceivables">0.00</span></h3>
                </div>
            </div>
        </div> {% endcomment %}

         <!-- Financial Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Sales</h5>
                    <h2 class="card-text">{{ sales_total|floatformat:2 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Other Income</h5>
                    <h2 class="card-text">{{ income_total|floatformat:2 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Expenses</h5>
                    <h2 class="card-text">{{ expenses_total|floatformat:2 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card {% if balance >= 0 %}bg-info{% else %}bg-warning{% endif %} text-white">
                <div class="card-body">
                    <h5 class="card-title">Net Balance</h5>
                    <h2 class="card-text">{{ balance|floatformat:2 }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content area with tabs -->
    <ul class="nav nav-tabs" id="financialTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="false">Overview</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button" role="tab" aria-controls="timeline" aria-selected="true">Timeline</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab" aria-controls="products" aria-selected="false">Product Sales</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab" aria-controls="categories" aria-selected="false">Categories</button>
        </li>
    </ul>
    
    <div class="tab-content p-3 border border-top-0 mb-4" id="financialTabsContent">

        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
            <h4>Overview</h4>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Details</th>
                            <th class="text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Sales</td>
                            <td class='text-right'>{{sales_total}}</td>
                        </tr>
                        <tr>
                            <td clas='text-right'>Other Income</td>
                            <td>{{income_total}}</td>
                        </tr>
                        <tr>
                            <td>Total Income</td>
                            <td>{{ income_total }}</td>
                        </tr>
                        {% for item in combined_cashflow %}
                        <tr class="{% if item.type_label == 'expense' %}table-danger{% elif item.type_label == 'sale' %}table-primary{% else %}table-success{% endif %}">
                            <td>{{ item.datetime|date:"Y-m-d H:i" }}</td>
                            <td>{{ item.type_label|title }}</td>
                            <td>{% if item.category_name %}{{ item.category_name }}{% else %}Uncategorized{% endif %}</td>
                            <td>{{ item.source }}</td>
                            <td class="text-right">{{ item.amount|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">No financial activity in the selected period.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Timeline Tab -->
        <div class="tab-pane fade" id="timeline" role="tabpanel" aria-labelledby="timeline-tab">
            <h4>Transaction(s) Activity</h4>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>Type</th>
                            <th>Category</th>
                            <th>Source</th>
                            <th class="text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in combined_cashflow %}
                        <tr class="{% if item.type_label == 'expense' %}table-danger{% elif item.type_label == 'sale' %}table-primary{% else %}table-success{% endif %}">
                            <td>{{ item.datetime|date:"Y-m-d H:i" }}</td>
                            <td>{{ item.type_label|title }}</td>
                            <td>{% if item.category_name %}{{ item.category_name }}{% else %}Uncategorized{% endif %}</td>
                            <td>{{ item.source }}</td>
                            <td class="text-right">{{ item.amount|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">No financial activity in the selected period.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Product Sales Tab -->
        <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
            <h4>Product Sales Summary</h4>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th class="text-right">Quantity</th>
                            <th class="text-right">Revenue</th>
                            <th class="text-right">Avg. Price</th>
                            <th class="text-right">VAT</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in product_sales %}
                        <tr>
                            <td>{{product.item__name}}
                                {% if product.item__description %} 
                                    - {{ product.item__description }}
                                {% endif %}
                            </td>
                            <td class="text-right">{{ product.total_quantity }}</td>
                            <td class="text-right">{{ product.total_revenue|floatformat:2 }}</td>
                            <td class="text-right">{{ product.average_price|floatformat:2 }}</td>
                            <td class="text-right">{{ product.total_vat|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">No sales data available for the selected period.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="font-weight-bold">
                            <td>Totals</td>
                            <td class="text-right">{{ sales.aggregate.total_quantity }}</td>
                            <td class="text-right">{{ sales_total|floatformat:2 }}</td>
                            <td class="text-right">-</td>
                            <td class="text-right">{{ sales.aggregate.total_vat }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <!-- Categories Tab -->
        <div class="tab-pane fade" id="categories" role="tabpanel" aria-labelledby="categories-tab">
            <div class="row">
                <!-- Expense Categories -->
                <div class="col-md-6">
                    <h4>Expense Categories</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th class="text-right">Amount</th>
                                    <th class="text-right">% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in expenses_by_category %}
                                <tr>
                                    <td>{% if category.category__name %}{{ category.category__name }}{% else %}Uncategorized{% endif %}</td>
                                    <td class="text-right">{{ category.total|floatformat:2 }}</td>
                                    <td class="text-right">{{ category.percentage|floatformat:1 }}%</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center">No expense data available.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="font-weight-bold">
                                    <td>Total</td>
                                    <td class="text-right">{{ expenses_total|floatformat:2 }}</td>
                                    <td class="text-right">100%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <!-- Income Categories -->
                <div class="col-md-6">
                    <h4>Income Categories</h4>
                    <div class="table-responsive">Income	sales	Income	20.00
                        2025-04-07 04:15	Income	sales	Income	20.00
                        2025-04-07 14:16	Income	sales	Income	0.00
                        2025-04-07 14:48	
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th class="text-right">Amount</th>
                                    <th class="text-right">% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in income_by_category %}
                                <tr>
                                    <td>{% if category.category__name %}{{ category.category__name }}{% else %}Uncategorized{% endif %}</td>
                                    <td class="text-right">{{ category.total|floatformat:2 }}</td>
                                    <td class="text-right">{{ category.percentage|floatformat:1 }}%</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center">No income data available.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="font-weight-bold">
                                    <td>Total</td>
                                    <td class="text-right">{{ income_total|floatformat:2 }}</td>
                                    <td class="text-right">100%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div id="transactionsTableContainer" style="display: none;">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-dark hint--bottom" aria-label="transaction summary" onclick="showView('defaultTable')">
                    <i class='bx bx-chevron-left'></i>
                </button>
                <div class="px-2">
                    <h5>Transactions</h5>
                </div>
            </div>
            {% comment %} <div class="table-responsive mt-2">
              <table class="table table-hover mb-0">
                <!-- <thead>
                  <tr>
                    <th>Date</th>
                    <th>Category</th>
                    <th>Income</th>
                    <th>Expense</th>
                    <th>Total</th>
                    <th>Branch</th>
                    <th>Received By</th>
                  </tr>
                </thead> -->
                <tbody>
                  {% for cashflow in logs %}
                  <tr>
                    <td>
                        <i class='bx bx-money-withdraw'></i>
                        {{ cashflow.category }}
                        <br>
                        <small>{{ cashflow.date }}</small>
                    </td>
                    <td>
                        <span class="{% if cashflow.type == 'income' %} text-success {% else %} text-danger {% endif %}">
                            {{ cashflow.amount }}
                        </span>
                    </td>
                    <td>{{ cashflow.branch.name }}</td>
                    <td>{{ cashflow.created_by }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div> {% endcomment %}
          </div>
          
          <div id="categoriesTableContainer" style="display: none;">
            <p>Categories table goes here...</p>
          </div>

        <!-- Income Modal -->
        <div class="modal fade" id="incomeModal" tabindex="-1">
            <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                        <h5 class="modal-title">Record Income</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <select class="category-select" id="incomeName" class="form-select"></select>
                                <option value="">Income Name</option>
                                {% for name in cash_flow_names %}
                                    <option value="{{ name.id }}">{{ name.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3"></div>
                            <label class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="incomeAmount" placeholder="Enter amount">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Main Category</label>
                            <select class="category-select" id="incomeCategory" class="form-select">
                                <option value="">Select Category</option>
                                {% for category in income_categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Sub Category</label>
                            <select class="category-select" id="incomeSubCategory">
                                <option value="">Select Sub Category</option>
                                {% for category in income_categories %}
                                    <option value="{{ category.sub_income.id }}">{{ category.sub_income.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Branch</label>
                            <select class="category-select" id="incomeBranch">
                                {% for branch in branches %}
                                    <option value="{{ branch.id}}">{{ branch.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-success" onclick="recordIncome()">Record Income</button>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>

        <!-- expenses modal -->
        <div class="modal fade" id="expenseModal" tabindex="">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <div>
                            <button class="active btn btn-outline-dark">Income</button>
                            <button class="btn btn-outline-dark px-2">Expenses</button>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <select class="category-select" id="expenseName" class="form-select">
                                <option value="">Expense Name</option>
                                {% for name in cash_flow_names %}
                                    <option value="{{ name.id }}">{{ name.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="expenseAmount" placeholder="Enter amount">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Main Category</label>
                            <select class="category-select" id="expenseCategory" class="form-select">
                                <option value="">Select Category</option>
                                {% for category in expense_categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Sub Category</label>
                            <select class="category-select" id="expenseSubCategory">
                                <option value="">Select Sub Category</option>
                                {% for category in expense_categories %}
                                    <option value="{{ category.sub_expense.id }}">{{ category.sub_expense.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Branch</label>
                            <select class="category-select" id="expenseBranch">
                                {% for branch in branches %}
                                    <option value="{{ branch.id}}">{{ branch.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-danger" onclick="recordIncome()">Record Expense</button>
                    </div>

                    <div class="card cash-flow-card">
                        <div class="card-body">
                            <table class="table table-striped table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Branch</th>
                                        <th>Expected Amount</th>
                                        <th>Expense</th>
                                        <th>Amount received</th>
                                        <th>Created By</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="cash_up_table">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="receiveModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Receive Cash</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Amount Received</label>
                            <input type="number" class="form-control" id="amount-received" placeholder="Enter amount">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="createCashFlow()">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let cash_up_id = 0;
        let record_type = '';

        const expenseModal = new bootstrap.Modal(document.getElementById('expenseModal'));
        const incomeModal = new bootstrap.Modal(document.getElementById('incomeModal'));

        const expenseButton = document.getElementById('expenseBtn');
        const incomeButton = document.getElementById('incomeBtn');

         // Show/hide custom date range form based on selection
        document.addEventListener('DOMContentLoaded', function() {
            const filterButtons = document.querySelectorAll('.btn-group a');
            const dateRangeForm = document.getElementById('dateRangeForm');
            
            filterButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    if (this.href.includes('filter_type=custom')) {
                        e.preventDefault();
                        dateRangeForm.classList.remove('d-none');
                    } else {
                        dateRangeForm.classList.add('d-none');
                    }
                });
            });
        });


        function showView(view) {
            document.getElementById("defaultTable").style.display = "none";
            document.getElementById("transactionsTableContainer").style.display = "none";
            document.getElementById("categoriesTableContainer").style.display = "none";
            document.getElementById("loader").style.display = "block";

            setTimeout(() => {
                document.getElementById("loader").style.display = "none";

                if (view === 'transactions') {
                    document.getElementById("transactionsTableContainer").style.display = "block";
                } else if (view === 'categories') {
                    document.getElementById("categoriesTableContainer").style.display = "block";
                } else {
                    document.getElementById("defaultTable").style.display = "block";
                }
            }, 500); 
        }

        expenseButton.addEventListener('click', () => {
            record_type = 'expense';
            expenseModal.show();
        });

        // incomeButton.addEventListener('click', () => {
        //     record_type = 'income';
        //     incomeModal.show();
        // });

        $(document).ready(function() {
            // Configuration object for common settings
            const commonConfig = {
                theme: 'bootstrap-5',
                width: '100%'
            };

            // Configuration for fields with tags
            const tagsConfig = {
                ...commonConfig,
                tags: true,
                createTag: function(params) {
                    return {
                        id: params.term,
                        text: params.term,
                        newTag: true
                    };
                }
            };

            // Function to initialize select2 fields
            function initializeSelect2(elementId, config) {
                $(`#${elementId}`).select2(config);
            }

            // Function to add event handlers
            function addSelect2EventHandlers(elementId, fieldType) {
                // Select event
                $(`#${elementId}`).on('select2:select', function(e) {
                    let data = e.params.data;
                    if (data.newTag) {
                        console.info(`${fieldType} - New text entered:`, data.text);
                    } else {
                        console.info(`${fieldType} - Existing option selected:`, data.text);
                    }
                    console.info(`${fieldType} Value:`, data.id);
                });

                // Closing event
                $(`#${elementId}`).on('select2:closing', function(e) {
                    let searchText = $(`#${elementId}`).data('select2').$dropdown.find('.select2-search__field').val();
                    if (searchText) {
                        let exists = false;
                        $(`#${elementId} option`).each(function() {
                            if ($(this).text().toLowerCase() === searchText.toLowerCase()) {
                                exists = true;
                                return false;
                            }
                        });

                        if (!exists) {
                            let newOption = new Option(searchText, searchText, true, true);
                            $(`#${elementId}`).append(newOption).trigger('change');
                        }
                    }
                });
            }

            // Initialize Income fields
            const incomeFields = [
                { id: 'incomeCategory', type: 'Category', modal: 'incomeModal', hasEvents: true },
                { id: 'incomeName', type: 'Name', modal: 'incomeModal', hasEvents: true },
                { id: 'incomeSubCategory', type: 'SubCategory', modal: 'incomeModal', hasEvents: true },
                { id: 'incomeBranch', type: 'Branch', modal: 'incomeModal', hasEvents: false }
            ];

            // Initialize Expense fields
            const expenseFields = [
                { id: 'expenseCategory', type: 'Category', modal: 'expenseModal', hasEvents: true },
                { id: 'expenseName', type: 'Name', modal: 'expenseModal', hasEvents: true },
                { id: 'expenseSubCategory', type: 'SubCategory', modal: 'expenseModal', hasEvents: true },
                { id: 'expenseBranch', type: 'Branch', modal: 'expenseModal', hasEvents: false }
            ];

            // Initialize all fields
            [...incomeFields, ...expenseFields].forEach(field => {
                const config = {
                    ...(field.hasEvents ? tagsConfig : commonConfig),
                    dropdownParent: $(`#${field.modal}`)
                };
                
                initializeSelect2(field.id, config);
                
                if (field.hasEvents) {
                    addSelect2EventHandlers(field.id, field.type);
                }
            });

            // Helper function to get categories
            window.getCategories = function(type = 'expense') {
                const prefix = type.toLowerCase() === 'income' ? 'income' : 'expense';
                
                let category = {
                    value: $(`#${prefix}Category`).val(),
                    text: $(`#${prefix}Category`).select2('data')[0]?.text || ''
                };
                
                let subcategory = {
                    value: $(`#${prefix}SubCategory`).val(),
                    text: $(`#${prefix}SubCategory`).select2('data')[0]?.text || ''
                };

                let name = {
                    value: $(`#${prefix}Name`).val(),
                    text: $(`#${prefix}Name`).select2('data')[0]?.text || ''
                };

                return { category, subcategory, name };
            };
            
            // Make the active navigation item highlight based on current page
            const currentPath = window.location.pathname;
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.getAttribute('href') === currentPath) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        });



        function recordIncome() {
            let type = ''
            const incomeAmount = document.getElementById('incomeAmount').value;
            const ExpenseAmount = document.getElementById('expenseAmount').value;

            const categories = getCategories(record_type);
            console.info('Category:', categories.category);
            console.info('Subcategory:', categories.subcategory);
            console.info('Expense Name:', categories.expenseName);

            
            const data = {
                IncomeAmount: incomeAmount || 0.00,
                ExpenseAmount: ExpenseAmount || 0.00,
                incomeCategory: document.getElementById('incomeCategory').value,
                expenseCategory: document.getElementById('expenseCategory').value,
                incomeBranch: document.getElementById('incomeBranch').value,
                expenseBranch: document.getElementById('expenseBranch').value,
                categories: categories,
                type: record_type
            };

            console.log(data)

            fetch('/finance/record_transaction/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(response => {
                if (response.success) {
                    location.reload();
                } else {
                    alert(response.message);
                }
            });
        }

        function recordExpense() {
            const expenseAmount = document.getElementById('expenseAmount').value;
            if (!expenseAmount) {
                alert('Please enter the expense amount');
                return;
            }

            const data = {
                amount: expenseAmount,
                type: 'expense'
            };

            fetch('/finance/record_transaction/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(response => {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: 'Expense recorded successfully'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: response.message
                    });
                }
            });
        }

        function populateCashUpTable() {
            const tableBody = document.getElementById('cash_up_table');
            tableBody.innerHTML = '';

            fetch('/finance/cash_up_list/')
                .then(response => response.json())
                .then(response => {
                    if (!response.success) return;

                    const groupedData = {};
                    response.data.forEach(cashup => {
                        const date = cashup.created_at.split(' ')[0];
                        if (!groupedData[date]) {
                            groupedData[date] = [];
                        }
                        groupedData[date].push(cashup);
                    });

                    Object.keys(groupedData)
                        .sort()
                        .reverse()
                        .forEach(date => {
                            const dateRow = document.createElement('tr');
                            dateRow.className = 'table-secondary';
                            dateRow.innerHTML = `
                                <td colspan="6" class="fw-bold">
                                    ${new Date(date).toLocaleDateString()}
                                </td>
                            `;
                            tableBody.appendChild(dateRow);

                            groupedData[date].forEach(cashup => {
                                const row = document.createElement('tr');
                                row.classList.add('cashup-row');
                                row.setAttribute('data-cashup-id', cashup.id);
                                row.innerHTML = `
                                    <td><small>${cashup.branch__name}</small></td>
                                    <td><small>$${cashup.expected_cash}</small></td>
                                    <td><small>$${cashup.expense || 0.00}</small></td>
                                    <td><small>$${cashup.received_amount}</small></td>
                                    <td><small>${cashup.created_by__username}</small></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="toggleCashUpDetails(${cashup.id}, this)">View</button>
                                    </td>
                                `;
                                tableBody.appendChild(row);
                            });
                        });
                });
        }

        populateCashUpTable() 

        let cashup_id = ''

        function toggleCashUpDetails(cashUpId, btn) {
            const row = btn.closest('tr');

            cashup_id = cashUpId

            if (row.nextElementSibling && row.nextElementSibling.classList.contains('children-row')) {
                row.nextElementSibling.remove();
                return;
            }

            const loaderRow = document.createElement('tr');
            loaderRow.classList.add('children-row');
            loaderRow.innerHTML = `<td colspan="6" class="text-center py-3">
                <div class="spinner-border text-primary" role="status"></div>
            </td>`;
            row.parentNode.insertBefore(loaderRow, row.nextSibling);

            fetch('/finance/get_cash_up_details/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ cash_up_id: cashUpId })
            })
            .then(res => res.json())
            .then(data => {
                console.log(data)
                if (!data.success) {
                    loaderRow.innerHTML = `<td colspan="6" class="text-danger text-center">Failed to load details</td>`;
                    return;
                }

                console.log('here')
                console.log('sales data:', data.data.sales);

                let salesTable = '<div>No sales data available</div>';
                if (Array.isArray(data.data.sales) && data.data.sales.length > 0) {
                    salesTable = `
                        <table class="table table-borderless mb-2">
                            ${data.data.sales.map(s => `
                                <tr>
                                    <td>${s.invoice__products_purchased || 'No description'}</td>
                                    <td></td>
                                    <td>$${s.total_amount}</td>
                                    <td>
                                        <button class="btn btn-sm btn-success" id='${s.id}' onclick="recordSale(${s.id}, 'sale', ${s.invoice__branch})">Record</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </table>
                    `;
                }

                const expensesTable = `
                    <table class="table table-borderless">
                        ${data.data.expenses.map(e => `
                            <tr>
                                <td>${e.description || 'No description'}</td>
                                <td>$${e.amount}</td>
                                <td>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-warning" onclick="recordExpense(${e.id})">Record</button>
                                        <button type="button" class="btn btn-sm btn-warning dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                            <span class="visually-hidden">Toggle Dropdown</span>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#">Mark as Reviewed</a></li>
                                            <li><a class="dropdown-item" href="#">Flag Issue</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </table>
                `;

                loaderRow.innerHTML = `
                    <td colspan="6">
                        <div class="mb-2"><strong>Sales:</strong></div>
                        ${salesTable || '<div>No Sales</div>'}
                        <div class="mb-2"><strong>Expenses:</strong></div>
                        ${expensesTable || '<div>No Expenses</div>'}
                    </td>
                `;

             })
            .catch(err => {
                loaderRow.innerHTML = `<td colspan="6" class="text-danger text-center">Error loading data</td>`;
            });
        }

        function recordSale(saleId, type, branch) {
            console.log('Recording sale:', saleId, branch, cashup_id);

            // Show Swal loading modal
            Swal.fire({
                title: 'Processing...',
                text: 'Please wait while the sale is being recorded.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch('/finance/record_cashflow/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')  
                },
                body: JSON.stringify({ id: saleId, type:type, branch:branch, cashup_id:cashup_id })  
            })
            .then(response => response.json())
            .then(data => {
                Swal.close(); 

                if (data.success) {
                    Toastify({
                        text: "Sale recorded successfully!",
                        duration: 3000,
                        gravity: "top", 
                        position: "center",
                        background: "#28a745"
                    }).showToast();

                    // setTimeout(() => location.reload(), 1500);
                    const recordBtn = document.getElementById(`${data.id}`)
                    console.log(recordBtn)
                    recordBtn.textContent = 'recorded'
                    recordBtn.disabled = true
                    
                } else {
                    Toastify({
                        text: data.message || "Failed to record sale",
                        duration: 4000,
                        gravity: "top", 
                        position: "center",
                        background: "#dc3545"
                    }).showToast();
                }
            })
            .catch(error => {
                Swal.close();

                Toastify({
                    text: "An error occurred",
                    duration: 4000,
                    gravity: "top", 
                    position: "center",
                    background: "#dc3545"
                }).showToast();
            });
        }

        function recordExpense(expenseId) {
            console.log('Recording expense:', expenseId);
            // send POST request to record expense
        }


        const receiveModal = new bootstrap.Modal(document.getElementById('receiveModal'));

        function receive(id) {
            cash_up_id = id;
            receiveModal.show();
        }

        function createCashFlow() {
            const amount = document.getElementById('amount-received').value;
            if (!amount) {
                alert('Please enter the amount received');
                return;
            }

            const data = {
                amount: amount,
                cash_up_id: cash_up_id
            };

            fetch('/finance/create_cash_flow/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message);
                }
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

    </script>
</div>
{% endblock %}