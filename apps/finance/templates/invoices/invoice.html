{% extends "base.html" %}
{% load static%}
{% block title%} Invoices {% endblock%}
{% block content %}
<style>

:root {
    --primary: #11998e;
    --primary-no-gradient: #11998e;
    --primary-dark: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
    --secondary: orange;
    --accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    --warning: linear-gradient(135deg, #fce38a 0%, #f38181 100%);
    --danger: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    --dark: #1a1a2e;
    --dark-alt: #16213e;
    --text-light: rgba(228, 230, 234, 1);
    --text-dark: black;
    --text-muted: black;
    --glass: rgba(255, 255, 255, 0.1);
    --glass-border: rgba(255, 255, 255, 0.2);
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 8px 6px rgba(0, 0, 0, 0.12);
    --border-radius: 16px;
    --border-radius-sm: 8px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --m-bottom: 20px;
}

.header {
    grid-area: header;
    padding: 20px 30px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow);
}

.search-input {
    width: 100%;
    padding: 15px 50px 15px 20px;
    border-radius: var(--border-radius);
    background: var(--glass);
    border: 1px solid var(--glass-border);
    color: var(--text-light);
    font-size: 16px;
    transition: var(--transition);
}

.search-input:focus {
        outline: none;
        border-color: rgba(102, 126, 234, 0.5);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

.search-input::placeholder {
    color: var(--text-dark);
}

.form-control {
    width: 100%;
    padding: 8px;
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--glass-border);
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    color: var(--text-dark);
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
}

.modal-content {
    position: relative;
    background: white;
    margin: 15% auto;
    padding: 20px;
    width: 80%;
    max-width: 500px;
    border-radius: var(--border-radius);
}

.close-modal {
    position: absolute;
    right: 20px;
    top: 10px;
    font-size: 24px;
    cursor: pointer;
}


.search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
}

.table-container {
    max-width: 100%;
    margin: auto;
    overflow-x: auto;
    background-color: white;
}

::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: var(--glass);
}

::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--primary-dark);
}

table {
    width: 100%;
    border-collapse: collapse;
    text-align: left;
}

.btn {
        flex: 1;
        padding: 10px;
        border-radius: var(--border-radius-sm);
        border:none;
        color: var(--text-dark);
        cursor: pointer;
        transition: var(--transition);
        font-size: 12px;
    }


thead th {
    background-color: #f9f9f9;
    padding: 8px 10px;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
}

tbody td {
    padding: 8px 10px;
    border-bottom: 1px solid #eee;
}

tbody tr:hover {
    background-color: #f1f1f1;
}

input[type="checkbox"] {
    cursor: pointer;
}

.status {
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.9em;
}

.status.completed {
    background-color: #d4edda;
    color: #155724;
}

.status.pending {
    background-color: #f8d7da;
    color: #721c24;
}

.payment-btn {
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9em;
}

.payment-btn.paid {
    background-color: #28a745;
    color: white;
}

.payment-btn.due {
    background-color: #dc3545;
    color: white;
}

.table-container {
    max-height: 100vh !important;
    overflow-y: auto;
    position: relative;
}

.sticky-top-search {
    position: sticky;
    top: 0;
    background-color: white;
    z-index: 100;
    padding: 10px 0;
    border-bottom: 2px solid #ccc;
}

.sticky-header th {
    position: sticky;
    top: 56px; 
    z-index: 99;
    background-color: var(--primary); 
    color: white;
}

.table-scroll {
    width: 100%;
    display: block;
}
.heading-item{
    font-size: 12px;
}

.footer-btn {
    padding: 8px 16px;
    border-radius: var(--border-radius-sm);
    background: var(--primary-no-gradient);
    border: 1px solid var(--glass-border);
    color: var(--text-light);
    text-decoration: none;
    transition: var(--transition);
    font-size: 14px;
    cursor: pointer;
}

.footer-btn:hover {
    background: var(--primary);
    transform: translateY(-1px);
}

</style>
<div class="financ">
    <div class="header">
        <div class='h5'>
            Invoices
        </div>
        <div class="d-flex justify-content-between mt-1">
            <div>
                <select class="form-select" id="filterSelect" onchange="filterCashBook()">
                    <option value="today" {% if filter_option == 'today' %}selected{% endif %}>Today</option>
                    <option value="this_week" {% if filter_option == 'this_week' %}selected{% endif %}>This Week</option>
                    <option value="yesterday" {% if filter_option == 'yesterday' %}selected{% endif %}>Yesterday</option>
                    <option value="this_month" {% if filter_option == 'this_month' %}selected{% endif %}>This Month</option>
                    <option value="last_month" {% if filter_option == 'last_month' %}selected{% endif %}>Last Month</option>
                    <option value="this_year" {% if filter_option == 'this_year' %}selected{% endif %}>This Year</option>
                </select>
            </div>
            <div id="customDateRange" class="d-flex mx-2">
                <input type="date" id="startDate" value="{{ start_date }}" class="form-control" placeholder="Start Date">
                <input type="date" id="endDate" value="{{ end_date}}" class="form-control mx-2" placeholder="End Date">
                <button class="btn btn-outline-dark btn-sm" onclick="applyCustomFilter()">Apply</button>
            </div>
            <button class="btn btn-outline-dark btn-sm" onclick="downloadReport()">Download Report</button>
        </div>
    </div>
        <!-- {% include 'components/loader.html' %} -->
        <div class='table-responsive' style="height: 100vh;">
            <div class="search-container sticky-top-search">
                <input type="text" id="searchInput" class="search-input" placeholder="Search invoices...">
                <i class="fas fa-search search-icon"></i>
            </div>
            {% for date_heading, data in grouped_invoices.items %}
    <div class="mb-4">
        <h4 class="mt-3 d-flex flex-column justify-content-center">
            <span>{{ date_heading }}</span>
            <div class="d-flex gap-3 text-muted">
                <small class="heading-item">{{ data.invoices|length }} invoice{{ data.invoices|length|pluralize }}</small>
                <small class="heading-item">Total: {{ data.invoices.0.currency.symbol }}{{ data.total_amount }}</small>
                <small class="heading-item">Due: {{ data.invoices.0.currency.symbol }}{{ data.amount_due }}</small>
            </div>
        </h4>
        
        <table class="sticky-header table-stripped w-100" id="invoiceTable">
            <thead>
                <tr>
                    <th>Customer Name &#9650;</th>
                    <th>Reference &#9650;</th>
                    <th>Date &#9650;</th>
                    <th>Products</th>
                    <th>Grand Total &#9650;</th>
                    <th>Paid &#9650;</th>
                    <th>Due &#9650;</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for invoice in data.invoices %}
                <tr>
                    <td><small><a href="{% url 'finance:customer' invoice.customer.id %}">{{ invoice.customer.name }}</a></small></td>
                    <td><small>#{{ invoice.invoice_number }}</small></td>
                    <td><small>{{ invoice.issue_date|date:"d/m/y H:i" }}</small></td>
                    <td><small>
                        {% for item in invoice_items %}
                            {% if item.invoice == invoice %}
                                <span style="margin-right:5px;">{{item.item.name }} x {{item.quantity}}</span>
                            {% endif %}
                        {% endfor %}
                    </small></td>
                    <td><small>{{ invoice.currency.symbol }} {{ invoice.amount }}</small></td>
                    <td id="tr" data-invoiceID="{{ invoice.id }}"><small>{{ invoice.currency.symbol }} {{ invoice.amount_paid }}</small></td>
                    <td>
                        {% if invoice.amount_due > 0 %}
                        <small class="text-danger">
                            {{ invoice.currency.symbol }} {{ invoice.amount_due }}
                        </small>
                        {% else %}
                        <small class="text-success">
                            {{ invoice.currency.symbol }} {{ invoice.amount_paid }}
                        </small>
                        {% endif %}
                    </td>
                    <td>
                        <span class='px-2'>
                            <span style='cursor:pointer;' class="text-dark hint--bottom" aria-label='Preview Invoice' data-id="{{ invoice.id }}" id='previewBtn'>
                                <i class='bx bx-file'></i>
                            </span>
                        </span>
                        <span>
                            {% if invoice.amount_due > 0 %}
                            <span style='cursor:pointer;' data-id="{{ invoice.id }}" data-amount="{{ invoice.amount_due }}" id='id_update' class="text-dark">
                                <i class='bx bx-right-arrow bg-success'></i>
                            </span>
                            {% else %}
                            <span style='cursor:pointer;' class="text-dark hint--bottom" aria-label='Invoice fully paid'>
                                <i class='bx bx-bx-right-arrow bg-danger'></i>
                            </span>
                            {% endif %}
                        </span>
                        <span>
                            {% if request.user.role == 'admin' %}
                            <span id='id_delete' data-id="{{ invoice.id }}" class="text-dark hint--bottom" aria-label='sales return'>
                                <img width="18px" src="{% static 'assets/return.png' %}" />
                            </span>
                            {% endif %}
                        </span>
                        {% if invoice.payment_terms == 'pay later' %}
                        <span class='px-2'>
                            <span style='cursor:pointer;' class="text-dark" data-bs-toggle="modal" data-bs-target="#paylaterModal{{ invoice.id }}">
                                <i class='bx bx-calendar'></i>
                            </span>
                        </span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endfor %}
        </div>
        

        <div class="modal fade" id="appModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Sending invoice to WhatsApp...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body" id='payment_content'>
                        {% include 'invoices/update_invoice.html' %}
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body">
                        {% include 'invoices/update_receipt.html' %}
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="paymentsModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center" id='payment_content'>
                        {% include 'invoices/invoice_payments.html' %}
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="receiptItems" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <div class="d-flex justify-content-between">
                            <div class="">
                                <h5>SALE RETURN</h5>
                                <p id="id_date">DATE: </p>
                            </div>
                            <div>
                                <h5 id="id_invoice_number"></h5>
                                <p id="id_invoice_date">DATE: </p>
                            </div>
                        </div>
                        
                        <table id="returnsTable" class="table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th id="unit_price_header">Price</th>
                                    <th id="id_total_header">Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Invoice items will be inserted here -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"></td>
                                    <td class="fw-bold">Total (with VAT)</td>
                                    <td class="fw-bold" id="id_total"></td>
                                </tr>
                                <tr>
                                    <td colspan="3"></td>
                                    <td class="fw-bold">Paid</td>
                                    <td class="fw-bold" id="id_paid"></td>
                                </tr>
                                <tr>
                                    <td colspan="3"></td>
                                    <td class="fw-bold">Balance</td>
                                    <td class="fw-bold" id="id_balance"></td>
                                </tr>
                            </tfoot>
                        </table>
                        <hr />
                        <h5>Items selected for refund</h5>
                        <table>
                            <tbody id="id_refund_items"></tbody>
                        </table>
                        <hr/>

                        <h3>Total Refund: <span class="mx-2" id="id_refund_total"></span></h3>
                        
                        <hr/>

                    </div>
                </div>
            </div>
        </div>


        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body" id='delete_content'>
                        <h5 class='fw-bold'>Delete Invoice</h5>
                        <div>
                            <button class='btn btn-secondary w-100' onclick='deleteInvoice();'>Yes</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</div>

<!-- Paylater Modals -->
{% for date_heading, invoices in grouped_invoices.items %}
    {% for invoice in invoices %}
        {% if invoice.payment_terms == 'pay later' %}
        <div class="modal fade" id="paylaterModal{{ invoice.id }}" tabindex="-1" aria-labelledby="paylaterModalLabel{{ invoice.id }}" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="paylaterModalLabel{{ invoice.id }}">Pay Later Details - Invoice #{{ invoice.invoice_number }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs" id="paylaterTabs{{ invoice.id }}" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="dates-tab{{ invoice.id }}" data-bs-toggle="tab" data-bs-target="#dates{{ invoice.id }}" type="button" role="tab">Payment Dates</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="payments-tab{{ invoice.id }}" data-bs-toggle="tab" data-bs-target="#payments{{ invoice.id }}" type="button" role="tab">Payment History</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="paylaterTabContent{{ invoice.id }}">
                            <div class="tab-pane fade show active" id="dates{{ invoice.id }}" role="tabpanel">
                                <div class="table-responsive mt-3">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Due Date</th>
                                                <th>Amount</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for paylater_date in invoice.paylater.paylaterdates_set.all %}
                                            <tr>
                                                <td>{{ paylater_date.due_date|date:"d/m/Y" }}</td>
                                                <td>{{ invoice.currency.symbol }} {{ paylater_date.amount }}</td>
                                                <td>
                                                    <span class="badge {% if paylater_date.paid %}bg-success{% else %}bg-warning{% endif %}">
                                                        {% if paylater_date.paid %}Paid{% else %}Pending{% endif %}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if not paylater_date.paid %}
                                                    <button class="btn btn-sm btn-primary" onclick="processPaylaterPayment({{ paylater_date.id }})">
                                                        Pay Now
                                                    </button>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="payments{{ invoice.id }}" role="tabpanel">
                                <div class="table-responsive mt-3">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Payment Date</th>
                                                <th>Amount</th>
                                                <th>Payment Method</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for payment in invoice.paylater.paylaterdates_set.all %}
                                            {% if payment.paid %}
                                            <tr>
                                                <td>{{ payment.payment_date|date:"d/m/Y" }}</td>
                                                <td>{{ invoice.currency.symbol }} {{ payment.amount }}</td>
                                                <td>{{ payment.payment_method }}</td>
                                                <td>
                                                    <span class="badge bg-success">Paid</span>
                                                </td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    {% endfor %}
{% endfor %}

<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Invoice Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="invoice-preview">
                    <div class="row mb-4">
                        <div class="col-6">
                            <h4>Invoice #<span id="preview-invoice-number"></span></h4>
                            <p class="mb-1">Date: <span id="preview-date"></span></p>
                            <p class="mb-1">Customer: <span id="preview-customer"></span></p>
                            <p class="mb-1">Email: <span id="preview-email"></span></p>
                            <p class="mb-1">Phone: <span id="preview-phone"></span></p>
                            <p class="mb-1">Address: <span id="preview-address"></span></p>
                        </div>
                        <div class="col-6 text-end">
                            <h4>TechCity</h4>
                            <p class="mb-1">Branch: <span id="preview-branch"></span></p>
                            <p class="mb-1">Status: <span id="preview-status"></span></p>
                            <p class="mb-1">Payment Terms: <span id="preview-payment-terms"></span></p>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="preview-items">
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Subtotal:</strong></td>
                                    <td id="preview-subtotal"></td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-end"><strong>VAT:</strong></td>
                                    <td id="preview-vat"></td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Total:</strong></td>
                                    <td id="preview-total"></td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Amount Paid:</strong></td>
                                    <td id="preview-paid"></td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Amount Due:</strong></td>
                                    <td id="preview-due"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-end w-100">
                    <div>
                        <button type="button" class="me-2 footer-btn" onclick="printInvoice()">
                            <i class='bx bx-printer'></i> Print
                        </button>
                        <button type="button" class="footer-btn" onclick="sendInvoiceEmail()">
                            <i class='bx bx-envelope'></i> Send Email
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    let invoiceId = '';
    let invoiceAmountDue = '';
    let paymentMethod = '';
    let duePaid = 0;

    const whatsappBtn = document.getElementById('whatsappBtn');
    const appModal = new bootstrap.Modal(document.getElementById('appModal'));

    const trEl = document.querySelectorAll('#tr')
    const paymentsModal = new bootstrap.Modal(document.getElementById('paymentsModal'));

    const deleteBtn = document.querySelectorAll('#id_delete')

    const updateBtn = document.querySelectorAll('#id_update')
    const updateModal = new bootstrap.Modal(document.getElementById('updateModal'));

    const loader = new bootstrap.Modal(document.getElementById('loaderModal'));

    const error = document.querySelector('#id_amount_error');
    const returnsModal = new bootstrap.Modal(document.getElementById('receiptItems'));
    const tableEl = document.querySelector('#invoiceTable');
    const loaderSpin = document.querySelector('#loader');

    const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));

    const previewBtn = document.querySelectorAll('#previewBtn');
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));

    document.getElementById('searchInput').addEventListener('keyup', function() {
        const searchValue = this.value.toLowerCase();
        const rows = document.querySelectorAll('#invoiceTable tbody tr');
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            let found = false;

            cells.forEach(cell => {
                if (cell.textContent.toLowerCase().includes(searchValue)) {
                    found = true;
                }
            });

            if (found) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // Column Sorting
    const headers = document.querySelectorAll("thead th");
    const tableBody = document.querySelector("tbody");
    const rows = Array.from(tableBody.querySelectorAll("tr"));

    headers.forEach((header, index) => {
        header.addEventListener("click", () => {
            const isAscending = header.classList.toggle("ascending");
            const direction = isAscending ? 1 : -1;
            const type = header.innerText.trim();
            
            rows.sort((rowA, rowB) => {
                const cellA = rowA.querySelectorAll("td")[index].innerText;
                const cellB = rowB.querySelectorAll("td")[index].innerText;
                
                if (!isNaN(cellA) && !isNaN(cellB)) {
                    return direction * (parseFloat(cellA) - parseFloat(cellB));
                }
                return direction * cellA.localeCompare(cellB);
            });
            
            rows.forEach(row => tableBody.appendChild(row));
        });
    });

{% comment %}     
    setTimeout(()=>{
        loaderSpin.classList.add('hidden');
        loaderSpin.classList.remove('d-flex')
        // tableEl.classList.remove('hidden')
    }, 300) {% endcomment %}

    // payment methods
    document.querySelectorAll('.pm').forEach(button => {
        button.addEventListener('click', () => {
            let name = button.dataset.name;
            if(['ecocash', 'cash', 'bank'].includes(name)){
                paymentMethod = button.dataset.name;
                updatePayment();
            }        
        });
    });

    // update payment
    function updatePayment(){
        const amount_paid = parseFloat(document.querySelector('#id_amount_paid').value);
        let validation = false

        duePaid = amount_paid;

        const data = {
            amount_paid: amount_paid,
            payment_method: paymentMethod
        }

        let customerName = '{{invoice.customer.name}}'
        error.textContent = `Updating ${customerName}(s) invoice`;

        if (paymentMethod === ''){
            error.textContent = `* Please choose payment method`;
        }
        else if (amount_paid === '' || amount_paid <= 0){
            error.textContent = `* Amount cannot be zero or negative `;
        }else if (amount_paid > invoiceAmountDue ){
            error.textContent = `* Amount cannot be more than amount due ${invoiceAmountDue} `;
        }
        else{
            validation = true
        }

        if(validation){

            Swal.fire({
                title: 'Processing Payment',
                text: 'Please wait...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                }
            });

            fetch(`/finance/invoice/update/${invoiceId}/`, {
                method: "POST",
                headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"), 
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateModal.hide()
                    displayReceipt(invoiceId)
                } else {
                    loaderModal.hide()
                    error.textContent='*' + data.message
                }
            })
            .catch((error) => {
            console.error("Error:", error);
            });
        }
    }

    function name(params) {
        
    }

    updateBtn.forEach((btn)=>{
        btn.addEventListener(
            'click', ()=>{
                invoiceId= btn.dataset.id
                invoiceAmountDue = btn.dataset.amount
                updateModal.show()
            }    
        )
    })

    deleteBtn.forEach((btn) => {
        btn.addEventListener('click', () => {
            invoiceId = btn.dataset.id;
            console.info(invoiceId)
            Swal.fire({
                title: 'Are you sure?',
                text: 'You won\'t be able to revert this!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'No, cancel!',
            }).then((result) => {
                if (result.isConfirmed) {
                    // salesReturns()
                    deleteInvoice(invoiceId);
                }
            });
        });
    });

    const salesReturns = () => {
        fetch(`/finance/invoice/preview/json/${invoiceId}/`, {
            method: 'GET'
        })
            .then(response => response.json())
            .then(data => {
                returnsModal.show()
                displaySales(data);
                
            });
    }

    const displaySales = (data) => {
        const tableBody = document.querySelector('#returnsTable tbody');
        tableBody.innerHTML = ''; 
        let subtotal = 0;
        console.log(data)
        data.invoice_items.forEach(item => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
            <td>
                <button class='btn' onclick="removeItem(${item.id})"><i class='bx bx-minus text-danger fs-4'></i></button>
            </td>
            <td>${item.item__product__name}</td>
            <td>${item.quantity}</td>
            <td>${item.unit_price}</td>
            <td>${(parseFloat(item.unit_price) * item.quantity).toFixed(2)}</td>
            <td>
                <button class='btn' onclick="replaceItem(${item.id})"><i class='bx bx-plus text-success fs-4s'></i></button>
            </td>
        `;
            tableBody.appendChild(row);
            subtotal += item.price * item.quantity;

            
        });

        const tax = subtotal * 0.15;
        const total = subtotal + tax;
        let refundAmount = parseFloat(0.00)
        //const amountReturned = calculateAmountReturned(total);

        document.getElementById('id_invoice_number').textContent = data.invoice.invoice_number;
        document.getElementById('id_invoice_date').innerHTML = '<small class="text-muted">' + 'Date: ' + new Date(data.invoice.issue_date).toLocaleString() + '</small>';
        document.getElementById('id_total_header').textContent = 'Total' + ' ' + `(${data.invoice.currency_symbol})` || 'Total';
        document.getElementById('unit_price_header').textContent = 'Price' + ' ' + `(${data.invoice.currency_symbol})` || 'Price';
        document.getElementById('id_total').textContent = data.invoice.amount || 0.00;
        document.getElementById('id_paid').textContent = data.invoice.amount_paid || 0.00;
        document.getElementById('id_balance').textContent = data.invoice.amount_due || 0.00;
        document.getElementById('id_refund_total').textContent = `(${data.invoice.currency_symbol})` + ' ' + refundAmount || 0.00;
        
        //document.getElementById('subtotalAmount').innerText = subtotal.toFixed(2);
        //document.getElementById('taxAmount').innerText = tax.toFixed(2);
        //document.getElementById('totalAmount').innerText = total.toFixed(2);
        //document.getElementById('amountReturned').innerText = amountReturned.toFixed(2);
    }

    const removeItem = (itemId) => {
        fetch(`/finance/invoice/remove/${itemId}/`, {
            method: 'DELETE',
        })
            .then(response => {
                if (response.ok) {
                    salesReturns();
                } else {
                    console.error('Error removing item');
                }
            })
            .catch(error => console.error('Error:', error));
    }

    const replaceItem = (itemId) => {
        console.log(`Replacing item with ID: ${itemId}`);
    }


    function deleteInvoice() {
        Swal.fire({
            title: 'Processing Sales returns',
            text: 'Please wait...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading()
            }
        });
        fetch(`/finance/invoice/delete/${invoiceId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if (data.success){
                Swal.fire({
                    title: 'Success!',
                    text: data.message,
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                    window.location.reload();
                });
            }else{
                Swal.fire({
                    title: 'Error',
                    text: data.message,
                    icon: 'Error',
                    confirmButtonText: 'OK'
                })
            }
        })
        .catch(error => {
            Swal.fire({
                title: 'Error!',
                text: error,
                icon: 'error',
                confirmButtonText: 'OK'
            });
        });
    }

    trEl.forEach((tr) => {
        tr.addEventListener('click', () => {
            fetchInvoiceData(tr.dataset.invoiceid);
        });
    });


    //whatsappBtn.addEventListener('click', function() {
    //    appModal.show(); 
    //    whatsappBtn.disabled = true; 

    //    const invoiceId = this.dataset.id;

    //    fetch(`/finance/send_invoice_whatsapp/${invoiceId}/`, {
    //        method: 'POST',
    //        headers: {
    //            'Content-Type': 'application/json',
    //            'X-CSRFToken': getCookie('csrftoken')
    //        }
    //    })
    //    .then(response => response.json())
    //    .then(data => {
    //        whatsappBtn.disabled = false;
    //    })
    //    .catch(error => {
    //        whatsappBtn.disabled = false; 
    //        console.error('Error:', error);
    //    });
    //});

    async function displayReceipt(invoiceId) {
    try {
        const response = await fetch(`/finance/invoice/preview/json/${invoiceId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
        });

        if (!response.ok) {
            throw new Error('Network response was not ok.');
        }

        const data = await response.json();
        const { invoice, invoice_items: invoiceItems, lay_dates:dates} = data;
        const {
            invoice_number: invoiceNumber,
            amount: invoiceTotal,
            delivery_charge: deliveryCharge,
            discount_amount: discountAmount,
            vat: vatAmount,
            subtotal: subTotal,
            currency_symbol: currencySymbol,
            amount_paid: amountPaid,
            payment_terms: payment_terms,
            customer_name: customer_name,
            customer_email: customer_email,
            customer_cell: customer_cell,
            customer_address: customer_address,
        } = invoice;

        console.log(data)

        let amount_due = invoiceTotal - amountPaid;
        let prvPaid = amountPaid - duePaid;
        console.log(duePaid)

        document.getElementById('rcp-payment').textContent = paymentMethod;
        document.getElementById('rcp-pterms').textContent = payment_terms;
        document.getElementById('rcp-currency').textContent = currencySymbol;
        document.getElementById('rcp_amount_paid').textContent = currencySymbol + ' ' + duePaid.toFixed(2);
        document.getElementById('rcp_prv_paid').textContent = currencySymbol + ' ' + prvPaid.toFixed(2);
        //document.getElementById('available_balance').textContent = currencySymbol + ' ' + (invoiceTotal - amountPaid + prvDue)
        document.getElementById('total_amount').textContent = currencySymbol + ' ' + invoiceTotal
        document.querySelector('#invoiceNumber').textContent = invoiceNumber;
        document.getElementById('rcp_due').textContent = currencySymbol + ' ' + amount_due.toFixed(2);
        document.getElementById('id_balance').textContent = currencySymbol + ' ' + amount_due.toFixed(2);
        document.getElementById('f_prv_paid').textContent = currencySymbol + ' ' + amountPaid;

        // set customer details
        document.getElementById('customerCompany').textContent = customer_name;
        document.getElementById('customerName').textContent = customer_name;
        document.getElementById('customerPhone').textContent = customer_cell;
        document.getElementById('customerEmail').textContent = customer_email;
        document.getElementById('customerAddress').textContent = customer_address;


        const receiptTableBody = document.querySelector('#receipt');
        receiptTableBody.innerHTML = '';

        // Populate the table with invoice items
        invoiceItems.forEach(({ quantity, item__product__name, unit_price, item__product__description, total_amount }) => {
            const newRow = receiptTableBody.insertRow();
            newRow.insertCell().textContent = `${item__product__name}`
            newRow.insertCell().textContent = `(${item__product__description})`;
            newRow.insertCell().textContent = quantity;
            newRow.insertCell().textContent = `${unit_price}`;
            newRow.insertCell().textContent = `${quantity * unit_price}`;
        });;

        // Update total amounts in the footer
        document.querySelector('#subTotalAmount').textContent = `${currencySymbol} ${subTotal}`;
        //document.querySelector('#totalAmount').textContent = `${currencySymbol} ${invoiceTotal}`;
        document.querySelector('#vatAmount').textContent = `${currencySymbol} ${vatAmount}`;
       //document.querySelector('#rid_paid_amount').textContent = `${currencySymbol} ${amount_paid.toFixed(2)}`;
        //document.querySelector('#rprevious_due').textContent = `${currencySymbol} ${previousDue.toFixed(2)}`;
        
        const laybyDateEl = document.getElementById('rcp_payment_dates')
        const laybyTerms = document.getElementById('laybyTerms');
        const installmentTerms = document.getElementById('installmentTerms');

        
        //modal.classList.add("hidden");
        //overlay.classList.add("hidden");

        Swal.fire({
            icon: 'success',
            title: 'success',
            text: 'Invoice successfully processed',
            timer: 2000,
            showConfirmButton: false
        }).then(()=>{
            loaderModal.hide();
            receiptModal.show();
        })

    } catch (error) {
        console.error("Error:", error);
        loaderModal.hide();
    }
}

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function processPaylaterPayment(paylaterDateId) {
        Swal.fire({
            title: 'Process Payment',
            html: `
                <div class="mb-3">
                    <label class="form-label">Payment Method</label>
                    <select class="form-select" id="paymentMethod">
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                        <option value="bank">Bank Transfer</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Amount</label>
                    <input type="number" class="form-control" id="paymentAmount" step="0.01" readonly>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Process Payment',
            cancelButtonText: 'Cancel',
            showLoaderOnConfirm: true,
            preConfirm: () => {
                const paymentMethod = document.getElementById('paymentMethod').value;
                const amount = document.getElementById('paymentAmount').value;
                
                return fetch(`/finance/process-paylater-payment/${paylaterDateId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        payment_method: paymentMethod,
                        amount: amount
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Payment processing failed');
                    }
                    return response.json();
                })
                .catch(error => {
                    Swal.showValidationMessage(`Request failed: ${error}`);
                });
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Success!',
                    text: 'Payment processed successfully',
                    icon: 'success'
                }).then(() => {
                    location.reload();
                });
            }
        });
    }

    previewBtn.forEach(btn => {
        btn.addEventListener('click', () => {
            const invoiceId = btn.dataset.id;
            fetchInvoicePreview(invoiceId);
        });
    });

    async function fetchInvoicePreview(invoiceId) {
        currentInvoiceId = invoiceId; 
        try {
            const response = await fetch(`/finance/invoice/preview/data/${invoiceId}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const data = await response.json();
            const { invoice, invoice_items: invoiceItems } = data;
            
            document.getElementById('preview-invoice-number').textContent = invoice.invoice_number;
            document.getElementById('preview-date').textContent = new Date(invoice.issue_date).toLocaleDateString();
            document.getElementById('preview-customer').textContent = invoice.customer_name;
            document.getElementById('preview-email').textContent = invoice.customer_email;
            document.getElementById('preview-phone').textContent = invoice.customer_cell;
            document.getElementById('preview-address').textContent = invoice.customer_address;
            document.getElementById('preview-branch').textContent = invoice.branch_name;
            document.getElementById('preview-status').textContent = invoice.payment_status;
            document.getElementById('preview-payment-terms').textContent = invoice.payment_terms;

            const itemsTable = document.getElementById('preview-items');
            itemsTable.innerHTML = '';
            invoiceItems.forEach(item => {
                const row = itemsTable.insertRow();
                row.insertCell().textContent = item.item__name;
                row.insertCell().textContent = item.item__description;
                row.insertCell().textContent = item.quantity;
                row.insertCell().textContent = `${invoice.currency_symbol} ${item.unit_price}`;
                row.insertCell().textContent = `${invoice.currency_symbol} ${item.total_amount}`;
            });

            document.getElementById('preview-subtotal').textContent = `${invoice.currency_symbol} ${invoice.subtotal}`;
            document.getElementById('preview-vat').textContent = `${invoice.currency_symbol} ${invoice.vat}`;
            document.getElementById('preview-total').textContent = `${invoice.currency_symbol} ${invoice.amount}`;
            document.getElementById('preview-paid').textContent = `${invoice.currency_symbol} ${invoice.amount_paid}`;
            document.getElementById('preview-due').textContent = `${invoice.currency_symbol} ${invoice.amount_due || 0.00}`;

            previewModal.show();
        } catch (error) {
            console.error('Error fetching invoice preview:', error);
            Swal.fire({
                title: 'Error!',
                text: 'Failed to load invoice preview',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
    }

    async function sendInvoiceEmail() {
        const email = document.getElementById('preview-email').textContent;
        const invoiceNumber = document.getElementById('preview-invoice-number').textContent;
        
        if (!email) {
            Swal.fire({
                title: 'Error!',
                text: 'No email address found for this customer',
                icon: 'error',
                confirmButtonText: 'OK'
            });
            return;
        }

        try {
            const response = await fetch(`/finance/send-invoice-email/${currentInvoiceId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            if (!response.ok) {
                throw new Error('Failed to send email');
            }

            const data = await response.json();
            
            if (data.success) {
                Swal.fire({
                    title: 'Success!',
                    text: `Invoice #${invoiceNumber} has been sent to ${email}`,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            } else {
                throw new Error(data.message || 'Failed to send email');
            }
        } catch (error) {
            Swal.fire({
                title: 'Error!',
                text: error.message || 'Failed to send email',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
    }

    function printInvoice() {
        const printContent = document.querySelector('.invoice-preview').innerHTML;
        const originalContent = document.body.innerHTML;
        
        // Create a print-friendly version
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Invoice Preview</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { padding: 20px; }
                        .table { width: 100%; margin-bottom: 1rem; }
                        .table th, .table td { padding: 0.75rem; border: 1px solid #dee2e6; }
                        .text-end { text-align: right; }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        ${printContent}
                    </div>
                    <div class="no-print text-center mt-3">
                        <button onclick="window.print()" class="btn btn-primary">Print</button>
                    </div>
                </body>
            </html>
        `);
        printWindow.document.close();
    }
</script>
{% endblock content %}