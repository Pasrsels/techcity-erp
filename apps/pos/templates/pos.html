{% load static%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="Techcity Pos System"/>
    <meta name="Author"content="casper moyo" />
    <link rel="icon" href="{% static 'images/favicons/favicon.ico' %}"/>

    {% block css %}
        <link rel="stylesheet" href="{% static 'css/main.css'%}">
        <link rel="stylesheet" href="{% static 'css/bootstrap/css/bootstrap.min.css'%}">
        <link href='{% static "assets/boxicons/css/boxicons.css"%}' rel='stylesheet'>
        <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    {% endblock css %}

    <script src="{% static 'css/bootstrap/js/bootstrap.min.js'%}"></script>
    <script src="{% static 'css/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'js/jquery.js'%}"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <title>
        {% block title %}Techcity POS{% endblock title %}
    </title>
</head>
<style>
    table {
        width: 100%;
        border-collapse: collapse;
        /* text-align: left; */
    }

    tbody tr:hover {
        background-color: #f1f1f1;
    }

    .payment-modal{
        display:flex;
        justify-content:center;
        background-color: #fff;
        margin-top:20px;
        width: 100%;
        max-width: 100%;
        max-height: 100%; 
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto; 
        padding: 20px;
        position: relative;
    
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none; 
        z-index: 1;
    }

    .modal-content {
        overflow-y: auto;  
    }

    .payment-modal{
        margin: 0px;
    }

    .btn:hover{
        color: #fff !important;
    }

</style>
<body class="techcity">
    <div class="pos">
        <div class="top-bar">
          <div class="nav-bar">{% include "pos_navbar.html" %}</div>
        </div>
        {% if messages %}
          {% for message in messages %}
          <div class="alert alert-dismissible {% if message.tags %}alert-{{ message.tags }}{% endif %}">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {% endfor %}
        {% endif %}
        <div class="row g-0">
          <div class="aside-bar col-1 text-light">{% include "base/aside.html" %}</div>
          <div class="col-7 mt-2">
            <div class="main-pos-area px-2">
              <div class="position-absolute start-0 ms-3">
                <button class="btn btn-secondary mb-2" data-bs-toggle="modal" data-bs-target="#laybyModal">L</button>
                <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#PaylaterModal">P</button>
              </div>
              <div class="d-flex justify-content-between align-items-center w-100 mb-3">
                <div class="d-flex align-items-center product-search flex-grow-1">
                  <button id="menu-type" class="btn border me-1"><i class="bx bx-menu"></i></button>
                  <div class="search-container d-flex align-items-center flex-grow-1 border rounded">
                    <i class="bx bx-search ms-2"></i>
                    <input type="search" name="q" class="form-control border-0" id="id_search" placeholder="Search..." />
                  </div>
                  <button class="btn btn-light btn-sm border ms-2" id="out_of_stock">Out of Stock</button>
                </div>
                <div class="ms-3">
                  <select name="category" id="id_category" class="form-select">
                    <option value="0">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="products">
                {% include 'components/loader.html' %}
                <div class="row g-2" id="product-list"></div>
              </div>
            </div>
          </div>
          <div class="col-4 mt-2">
            <div class="cart-container rounded shadow-sm bg-white h-100">
              <div class="d-flex align-items-center justify-content-between p-3 border-bottom">
                <div class="customer-search flex-grow-1">
                  <select type="text" id="search-input" class="form-select">
                    <option value=""></option>
                  </select>
                </div>
                <div class="avatar-container ms-2">
                  <img src="{% static 'assets/avatar.png' %}" alt="Avatar" class="avatar rounded-circle" width="40">
                </div>
                <div class="d-flex align-items-center ms-2">
                  <div class="text-end">
                    <small class="text-muted">Due</small>
                    <div id="due_balance" class="fw-bold"></div>
                  </div>
                  <button class="btn btn-sm btn-primary ms-2" id="id_add_client">
                    <i class="bx bx-plus"></i> Customer
                  </button>
                </div>
              </div>
              <small class="text-danger id_client_error"></small>
              <div class="cart-items bg-light rounded m-2">
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead class="table-light">
                      <tr>
                        <th>Qty</th>
                        <th>Product</th>
                        <th>Price</th>
                        <th>Subtotal</th>
                      </tr>
                    </thead>
                    <tbody id="cart_items"></tbody>
                  </table>
                </div>
              </div>
              <div class="p-2">
                <div class="row g-2 mb-3">
                  <div class="col-6">
                    <label for="id_discount" class="form-label small">Discount</label>
                    <input id="id_discount" type="number" class="form-control text-center" placeholder="Discount" value="0" />
                  </div>
                  <div class="col-6">
                    <label for="id_dc_input" class="form-label small">Delivery Charge</label>
                    <input id="id_dc_input" type="number" class="form-control text-center" placeholder="Delivery Charge" value="0" />
                  </div>
                </div>
                <div class="totals bg-light rounded p-2 mb-3">
                  <table class="table table-sm mb-0">
                    <tr>
                      <td>Total Amount</td>
                      <td class="text-end fw-bold" id="id_total_amount">0.00</td>
                    </tr>
                    <tr>
                      <td>Tax Amount</td>
                      <td class="text-end" id="id_vat_amount">0.00</td>
                    </tr>
                    <tr class="table-active">
                      <td>Payable Amount</td>
                      <td class="text-end fw-bold" id="id_payable">0.00</td>
                    </tr>
                  </table>
                </div>
                <button class="btn btn-primary w-100" id="id_pay">Proceed to Payment</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    <div class="modal fade" id="payment-modal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-fullscreen modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    {% include 'pay_modal.html' %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                {% include 'error_modal.html' %}
            </div>
        </div>
    </div>

    </div>

    <div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    {% include 'add_client.html' %}
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="endOfDayModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    {% include 'end_of_day_modal.html' %}
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    {% include 'printable_receipt.html' %}
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loaderModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <i class='bx bx-check-circle h1'></i>
                    <h2>Invoice Successfully Processed</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <i class='bx bx-check-circle h3'></i>
                    <h4>Customer Successfully Created</h4>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="qouteModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <i class='bx bx-check-circle h1'></i>
                    <h4>Qoutation Successfully Created</h4>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="chooseCustomerModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <h4>Choose Customer first</h4>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="laybyModal" tabindex="-1" aria-labelledby="laybyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header d-flex align-items-center justify-content-between w-100 py-2 mb-4">
                    <h5 class="modal-title" id="laybyModalLabel">Laybys</h5>
                    <p id="recordCount"></p><span id="count" class="ms-3">0</span>

                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                 </div>
                    <div class="modal-body">
                        <table id="laybyTable" class="table table-striped table-bordered" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Product</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="laybyTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
       </div>
    </div>   
    <div class="modal fade" id="PaylaterModal" tabindex="-1" aria-labelledby="PaylaterModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header d-flex align-items-center justify-content-between w-100 py-2 mb-4">
                    <h5 class="modal-title" id="PaylaterModalLabel">Pay Later List</h5>
                    <p id="recordCount"></p><span id="count"class="ms-3">0</span>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                 </div>
                    <div class="modal-body">
                        <table id="PaylaterTable" class="table table-striped table-bordered" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Product</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="PaylaterTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
       </div>
    </div>   

    <div class="overlay hidden"></div>
</body>

<script src="{% static 'css/bootstrap/js/bootstrap.bundle.min.js'%}"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.8.6/jsrsasign-all-min.js"></script>
<script src={% static "js/app_modules/signature_sign.js" %}></script>

<script>   
    console.log(run())
    let cart = [];
    let data = [];
    let respData = [];
    let currencyData = [];
    const customersData = [];
    let customerBalanceData = [];

    let holdStatus = false;

    let bal = 0;
    let previousDue = 0
    let discount_amount = 0;
    let delivery_amount = 0;
    let payable_amount = 0;
    let vat_amount = 0;
    let amount_paid = 0;
    let paymentMethod = 'cash'
    let menuName = '';
    let clientName = '';
    let initialCurrencyValue = '';
    let addedToCartProduct = [];
    let paymentTerms = 'cash';
    let sub = 0
    let vatAmount
    let price = 0

    const layby_dates = []
    const taxMethod = "{{ tax_method }}"

    let error = document.querySelector('#error_message');

    // import { calculateInclusiveTax, calculateExclusiveTax } from "{% static 'js/app_modules/taxes.js' %}";
    // console.log(calculateExclusiveTax)

    const currencySelect = document.querySelector('#currency')
    const endOfDayModal = new bootstrap.Modal(document.getElementById('endOfDayModal'));
    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
    const loaderModal = new bootstrap.Modal(document.getElementById('loaderModal'));
    const qouteModal = new bootstrap.Modal(document.getElementById('qouteModal'));
    const chooseCustomerModal= new bootstrap.Modal(document.getElementById('chooseCustomerModal'))

    const customerModal = new bootstrap.Modal(document.getElementById('customerModal'));
    const menuType = document.getElementById('menu-type');
    const ostBtn = document.getElementById('out_of_stock');

    const tableEl = document.querySelector('#invoiceTable');
    const loaderSpin = document.querySelector('#loader');
    const previousDueEl = document.querySelector('#previous_due');
    const holdBtn = document.getElementById('id_hold');

    holdBtn.addEventListener('click', () => {
            holdStatus = true;
            processCart(holdBtn);
    })

    // set receipt items
    function setReceiptItems(){
        const receiptTableBody = document.querySelector('#receiptTable');
        const prvDue = document.getElementById('previous_due');
        const tpreviousDue = document.getElementById('tpreviousDue')

        tpreviousDue.textContent = prvDue.textContent
        
        receiptTableBody.innerHTML = '';

        // Populate the table with invoice items
        cart.forEach(({ quantity, product_name, price, product_description }) => {
            const newRow = receiptTableBody.insertRow();
                newRow.insertCell().textContent = `${product_name}`
                newRow.insertCell().textContent = `(${product_description})`;
                newRow.insertCell().textContent = quantity;
                newRow.insertCell().textContent = `${price}`
                newRow.insertCell().textContent = `${quantity * price}`;
            });
    }

    const laybyButton = document.getElementById("layby");
    const installmentButton = document.getElementById("Installment");
    const cashButton = document.getElementById("cash");
    const payLaterBtn = document.getElementById('pay_later');
    const laybyTerms = document.querySelector(".layby-terms");
    const payLaterTerms = document.querySelector(".paylater");
    const monthlyInstallments = document.querySelector(".monthly-installments");

    laybyTerms.style.display = "none";
    monthlyInstallments.style.display = "none";
    payLaterTerms.style.display = "none";

    const amountPaidInput = document.getElementById('id_amount_paid');
    const totalBalanceDueElement = document.getElementById('total_balance_due');
    const balanceDueElement = document.getElementById('id_balance');
    const balanceLabel = document.getElementById('balance_label');
    const paymentButtons = document.querySelectorAll(".btn-terms");

    let paymentTerm = 'cash'; 

    document.getElementById('payment_modal_btn').addEventListener('click', () => {
        document.querySelector('.payment-modal').classList.add('hidden');
    })

    function calculateBalance() {
        let total = parseFloat(totalBalanceDueElement.textContent.split(' ')[1]); 
        let amountPaid = parseFloat(amountPaidInput.value) || 0;
        let balance;

        if (paymentTerm === 'cash') {
            balance = amountPaid - total; 

            if (balance < 0) {
                balance = 0
            }

            balanceLabel.textContent = 'Change';
            balanceDueElement.textContent = Math.abs(balance).toFixed(2);
        } else {
            balance = total - amountPaid; 

            if (balance < 0) {
                balance = 0
            }

            balanceLabel.textContent = 'Amount Due';
            balanceDueElement.textContent = balance.toFixed(2);
        }
    }

    amountPaidInput.addEventListener('input', calculateBalance);
    paymentButtons.forEach(button => {
        button.addEventListener('click', function () {
            paymentTerm = this.id === 'cash' ? 'cash' : 'layby_installment';

            paymentButtons.forEach(btn => btn.classList.remove("active"));
            this.classList.add("active");

            calculateBalance();
        });
    });

    function handlePaymentTypeClick(selectedButton) {
        
        cashButton.classList.remove("active");
        laybyButton.classList.remove("active");
        installmentButton.classList.remove("active");

        selectedButton.classList.add("active");

        if (selectedButton.id === "layby") {
            laybyTerms.style.display = "block";
            monthlyInstallments.style.display = "none";
            payLaterTerms.style.display = "none";
        } else if (selectedButton.id === "Installment") {
            laybyTerms.style.display = "none";
            monthlyInstallments.style.display = "block";
            payLaterTerms.style.display = "none";
        } else if (selectedButton.id === "cash") {
            laybyTerms.style.display = "none";
            monthlyInstallments.style.display = "none";
            payLaterTerms.style.display = "none";
        } else if (selectedButton.id === "pay_later") {
            laybyTerms.style.display = "none";
            monthlyInstallments.style.display = "none";
            payLaterTerms.style.display = "block";
        }
    }

    payLaterBtn.addEventListener('click', () => {
        handlePaymentTypeClick(payLaterBtn);
        paymentTerms = 'pay later';
    })

    laybyButton.addEventListener("click", function () {
        handlePaymentTypeClick(laybyButton);
        paymentTerms = 'layby';
    });

    installmentButton.addEventListener("click", function () {
        handlePaymentTypeClick(installmentButton);
        paymentTerms = 'installment';
    });

    function handlePaymentMethodClick(selectedButton) {
        paymentButtons.forEach(button => button.classList.remove("active"));
        selectedButton.classList.add("active");
    }

    const paymentMethodButtons = document.querySelectorAll(".payment-method button");

    paymentMethodButtons.forEach(button => {
        button.addEventListener("click", function () {
            paymentMethodButtons.forEach(btn => btn.classList.remove("active"));
            this.classList.add("active");
            if (button.dataset.name === 'cash') { 
                paymentMethod = button.dataset.name;
            } else if (button.dataset.name === 'ecocash'){
                paymentMethod = button.dataset.name;
            } else if (button.dataset.name === 'bank'){
                paymentMethod = button.dataset.name;
            }
        });
        
    });

    const receipt = () =>{
        const id_amount_paid = document.getElementById('id_amount_paid');
        const depositedAmount = document.getElementById('id_deposited');
        const period = document.getElementById('id_period')
        const availableBalance = document.getElementById('availableBalance')
        const availableBal = document.getElementById('availableBal')
        const previousDue = document.getElementById('previous_due')
        const termsButtons = document.querySelectorAll('.btn');

        let value;
        let amountDue = previousDue.textContent.split('')[0];
        // default if they is previous due
        
        period.addEventListener('input', ()=>{
            if(period.value < 0){
                Swal.fire({
                    icon:'error',
                    text:'Period interval can be less than 0', 
                    title: 'error'
                })
                return;
            }
            displayDueDates(period.value)
        })

        id_amount_paid.addEventListener('input', ()=>{
            value = id_amount_paid.value;
            depositedAmount.textContent = value;

            const amountDue = parseFloat(previousDue.textContent.split(' ')[1]);
        
            // availabe balance 
            availableBalance.textContent = parseFloat(value) - amountDue || 0;
            availableBal.textContent = parseFloat(value) - amountDue || 0;
            
        })

        const calculateNextDueDate = (period) => {
            const todayDate = new Date(); 
            const dueDates = []; 

            for (let i = 1; i <= period; i++) {
                const nextDueDate = new Date(todayDate); 
                nextDueDate.setDate(todayDate.getDate() + 30 * i); 
                layby_dates.push(nextDueDate);
                dueDates.push(nextDueDate); 
            }

            return dueDates;
        };

        
        const displayDueDates = (period) => {
            const dueDates = calculateNextDueDate(period);
            const paymentDateElement = document.getElementById('payment_date');

            let dateFields = ''; 

            dueDates.forEach((date, index) => {
                // Format the date as yyyy-mm-dd for the date input field
                const formattedDate = date.toISOString().split('T')[0];

                // Create input fields for each payment date
                dateFields += `
                    <label for="payment_date_${index}">Payment ${index + 1}:</label>
                    <input type="date" id="payment_date_${index}" value="${formattedDate}">
                    <br>
                `;
            });

            paymentDateElement.innerHTML = dateFields; 
        };
    }

    receipt()

    document.addEventListener("DOMContentLoaded", function() {
        const currencySelect = document.getElementById("currency");
        initialCurrencyValue = currencySelect.value; 
        const data = {id:initialCurrencyValue}
        $.ajax({
            url: '{% url "finance:currency_json" %}',
            type: 'GET',
            data: data,
            }).done(function(response) {
                const data = response
                currencyData = []
                currencyData.push(data)
        })
    });
    
    setTimeout(()=>{
        loaderSpin.classList.add('hidden');
        loaderSpin.classList.remove('d-flex')
    }, 300)

    $(document).ready(function() {
        $('#search-input').select2(
            {placeholder: 'Select Client'}
        )
        .on('change', function (e){
            clientName = $(this).val()
            fetchCustomerAccount(clientName)
            getLastInvoiceNumber(clientName)
        })
        
    })

    ostBtn.addEventListener('click', ()=>{
        if( menuName !== 'out of stock'){
            menuName = 'out of stock';
        }else{
            menuName = '';
        }
        fetchData()
    });

    menuType.addEventListener('click', ()=>{
        if(menuType.classList.contains('bx-list-ul')){
            menuType.classList.remove('bx-list-ul');
            menuType.classList.add('bx-menu');
            menuName = 'tiles'
        }else{
            menuType.classList.add('bx-list-ul');
            menuType.classList.remove('bx-menu');
            menuName = 'list'
        }
        fetchData();
    });

    document.querySelector('#end').addEventListener(
        'click', ()=>{
            endOfDayModal.show()
        }
    )
    
    let currency_id = null;

    currencySelect.addEventListener(
        'change', ()=>{

            const data = {id:currencySelect.value};
            currency_id = currencySelect.value;

            $.ajax({
                url: '{% url "finance:currency_json" %}',
                type: 'GET',
                data: data,
                }).done(function(response) {
                    const data = response
                    currencyData = []
                    currencyData.push(data)
            })
        }
    )

    //credit
    const cashBtn = document.querySelector('#id_cash_btn')
    const bankBtn = document.querySelector('.bank')
    const ecocash= document.querySelector('.ecocash')


    // modals
    const overlay = document.querySelector(".overlay");
    const modal = new bootstrap.Modal(document.querySelector('#payment-modal'));
    const clientModal = new bootstrap.Modal(document.querySelector('#clientModal'));
    const closeModalBtn = document.querySelectorAll(".btn-close");
    const closebtn = document.getElementById('closebtn')

    closebtn.addEventListener('click', ()=>{
        modal.classList.add('hidden');
        overlay.classList.add('hidden');
    })


    document.querySelector('#id_pay').addEventListener(
        'click', ()=>{
            if(clientName){
                updateCartDisplay();
                setReceiptItems()
                modal.show()
            }else{
                Swal.fire({
                    icon:'error',
                    text:'Choose Customer First.',
                    title:'error'
                })
            }
        }
    )

    document.querySelector('#id_add_client').addEventListener(
        'click',()=>{
            clientModal.show()
        }
    )

    closeModalBtn.forEach((btn)=>{
        btn.addEventListener(
            'click', ()=>{
                clientModal.classList.add('hidden')
                modal.classList.add("hidden");
                overlay.classList.add("hidden");
            }
        )
    })

    //search filters and fetching data
    const productListContainer = document.getElementById('product-list');
    const categorySelect = document.getElementById('id_category');
    const search = document.getElementById('id_search');

    search.addEventListener('input', ()=>{
        fetchData(search.value)
    })
    
    categorySelect.addEventListener('change', function() {
        const selectedCategoryId = this.value;
        fetchData(parseInt(selectedCategoryId))
    });

    async function fetchData (param){

        let url = '/inventory/product/list/';

        if (typeof param ==="number" & param !== 0) {
            url += `?category=${param}`; 
        }else if (typeof param === "string"){
            url += `?q=${param}`; 
        }
    
        try {
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error('Network response was not ok.');
            }
            const products = await response.json();
            productListContainer.innerHTML = ''; 
            
            displayProducts(products);
            
        } catch (error) {
            console.error('Error fetching products:', error);
            productListContainer.innerHTML = '<p class="error-message">Error loading products. Please try again later.</p>';
        } finally {
        }
    }

    fetchData()

    function cartButton(){
        const cartBtn = document.querySelector('#id_pay')
        if(cart.length==0){
            cartBtn.disabled = true
        }else{
            cartBtn.disabled = false
        }
    }
    cartButton()

    function displayProducts(products) {
        productListContainer.innerHTML = '';
        products.forEach(product => {
            if (menuName === 'tiles' || menuName === '') {
                if (product.quantity > 0) {
                    const productDiv = document.createElement('div');
                    productDiv.className = 'col-3';
                    productDiv.innerHTML = `
                        <div class="card mb-4" id='id_product_card' data-product='${JSON.stringify(product)}'>
                            <div class="card-body d-flex flex-column align-items-center justify-content-center" id="id_add_to_cart">
                                <div>
                                    <img src="${product.image ? product.image : '{% static "placeholder.png" %}'}" alt="${product.product_name}">
                                </div>
                                <p class='text-center mt-2'><small class="fw-bold">${product.product_name}</small></p>
                                <p class='text-center'><small class="text-muted">${product.description}</small></p>
                                <p class='text-center'><small class="text-muted">[${product.quantity}]</small></p>

                                <span class='btn btn-outline-secondary btn-sm w-100'
                                    data-id='${product.inventory_id}'
                                    data-name='${product.product_name}'
                                    data-price='${product.price}'
                                    data-wholesale-price='${product.dealer_price}'
                                    data-tax-code='${product.tax_code}'
                                    data-tax-name='${product.tax_name}'
                                    data-tax-percent='${product.tax_percent}'
                                    onclick='addItem(this)'>
                                    RP USD${product.price}
                                </span>

                                <span class='btn btn-outline-secondary btn-sm mt-2 w-100'
                                    data-id='${product.inventory_id}'
                                    data-name='${product.product_name}'
                                    data-price='${product.dealer_price}'
                                    data-wholesale-price='${product.dealer_price}'
                                    data-tax-code='${product.tax_code}'
                                    data-tax-name='${product.tax_name}'
                                    data-tax-percent='${product.tax_percent}'
                                    onclick='addItem(this)'>
                                    WP USD${product.dealer_price}
                                </span> 
                            </div>
                        </div>
                    `;
                    productListContainer.appendChild(productDiv); 
                }
            } else if (menuName === 'out of stock') {
                if (product.quantity <= 0) {
                    const productDiv = document.createElement('div');
                    productDiv.className = 'col-3';
                    productDiv.innerHTML = `
                        <div class="card bg-danger" id='id_product_card' data-product='${JSON.stringify(product)}'>
                            <div class="card-body d-flex flex-column align-items-center justify-content-center" id="id_add_to_cart">
                                <div class="d-flex align-items-center mb-3">
                                    <i style="font-size:30px" class='bx bx-barcode'></i>
                                </div>
                                <p><small class="fw-bold">${product.product_name}</small></p>
                                <p><small class="text-muted">${product.description}</small></p>
                                <p><small class="text-muted">[${product.quantity}]</small></p>
                                <p>
                                    <small class="text-muted mx-1">USD${product.price}</small>
                                    <small class='text-muted'>Wholesale Price USD${product.dealer_price}</small>
                                </p>
                            </div>
                        </div>
                    `;
                    productListContainer.appendChild(productDiv); 
                }
            } else {
                if (!document.querySelector('ul.product-list')) {
                    const productList = document.createElement('ul');
                    productList.className = 'list-unstyled product-list';
                    productListContainer.appendChild(productList);
                }
                
                const productListItem = document.createElement('li');
                productListItem.id = 'id_add_to_cart';
                productListItem.setAttribute('data-product', product.inventory_id);
                productListItem.setAttribute('onclick', 'addItem(this)');
                productListItem.setAttribute('data-id', product.inventory_id);
                productListItem.setAttribute('data-name', product.product_name);
                productListItem.setAttribute('data-price', product.price);
                productListItem.setAttribute('data-wholesale-price', product.dealer_price);
                productListItem.setAttribute('data-tax-code', product.tax_code);
                productListItem.setAttribute('data-tax-name', product.tax_name);
                productListItem.setAttribute('data-tax-percent', product.tax_percent);
                productListItem.className = `product-list-item ${product.quantity <= 0 ? 'text-danger' : ''}`;
                productListItem.innerHTML = `
                    <i class='bx bx-barcode'></i>
                    <small class="px-1 fw-bold">${product.product_name}</small>
                    <small class="text-muted">${product.description}</small>
                    <small class="text-muted">USD${product.price}</small>
                    <small class="text-muted">[${product.quantity}]</small>
                `;
                document.querySelector('ul.product-list').appendChild(productListItem);
                return;
            }
        });
    }


    // Cart 
    async function fetchProductData (product){
        if(initialCurrencyValue){
            const id = product.dataset.product
            const value = product.dataset.price

            let url = `/inventory/product/list/?product=${id}`;

            try {
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }
                const product = await response.json();
                addItem(product, value);
                addedToCartProduct = [];
                addedToCartProduct.push(product);
                
            } catch (error) {
                console.error('Error fetching products:', error);
                productListContainer.innerHTML = '<p class="error-message">Error loading products. Please try again later.</p>';
            } finally {
            }
        }else{
            errorModal.show()
            error.textContent=''
            error.textContent=`Choose Currency`
        }
        
    }

    function generateUniqueId() {
        return Math.floor(Math.random() * 1000000000).toString(36);
    }

    function addItem(button) {
        console.log(button)
        const id = button.getAttribute('data-id');
        const name = button.getAttribute('data-name');
        const price = parseFloat(button.getAttribute('data-price'));
        const wholesalePrice = parseFloat(button.getAttribute('data-wholesale-price'));
        const taxCode = button.getAttribute('data-tax-code');
        const taxName = button.getAttribute('data-tax-name');
        const taxPercent = button.getAttribute('data-tax-percent') 
            ? parseFloat(button.getAttribute('data-tax-percent')) 
            : null;

        const value = price === wholesalePrice ? 'wp' : 'rp';
        const exchangeRate = parseFloat(currencyData[0][0]?.exchange_rate || 1);

        const finalPrice = price * exchangeRate;

        let existingItem = cart.find(item => item.inventory_id === id);
        let taxAmount = 0;

        if (taxName !== 'Exempted' && taxPercent !== null) {
            taxAmount = (finalPrice * taxPercent) / (100 + taxPercent);
        }

        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            const newItem = {
                id: generateUniqueId(),
                inventory_id: id,
                product_name: name,
                product_description: '', 
                quantity: 1,
                price: finalPrice,
                tax_amount: parseFloat(taxAmount.toFixed(2)),
                tax_code: taxCode,
                tax_name: taxName,
                tax_percent: taxPercent,
                wholesale_price: wholesalePrice * exchangeRate,
                price_type: value
            };
            cart.push(newItem);
        }

        console.log(cart)

        updateCartDisplay();
        cartButton();
        totals();
    }


    function totals(){

        let totalAmount = calculateTotalAmount(cart);
        let vatAmount = calculateVAT(totalAmount);
        let discount = $('#id_discount').val()
        let delivery = parseFloat($('#id_dc_input').val())

        console.log('vat amout: ', vatAmount)
        
        let payable = totalAmount - vatAmount + delivery;
        
        // validate for not a number
        if (delivery >= 0){
            delivery = delivery
        }else{delivery = 0}

        delivery_amount = delivery
        vat_amount = vatAmount

        if(discount === 0){
            document.getElementById("id_total_amount").textContent = `${ currencyData[0][0].symbol + ' ' + totalAmount.toFixed(2)}`;
            document.getElementById("id_vat_amount").textContent =`${ currencyData[0][0].symbol + ' ' + vatAmount.toFixed(2)}`;
            document.getElementById('id_payable').textContent = `${ currencyData[0][0].symbol + ' ' + payable.toFixed(2)}`;

            payable_amount = payable
            discount_amount = discount

            updateTfoot(vatAmount, totalAmount, delivery, payable)

        }else{
            totalAmount = totalAmount - discount
            
            discountAmount = calculateTotalAmount(cart) - totalAmount
            vatAmount = (totalAmount * 0.15) / (1 + 0.15) //  to be provided from the back
            payable = totalAmount + delivery;
            
            vat_amount = vatAmount
            payable_amount = payable
            discount_amount = discountAmount

            document.getElementById("id_total_amount").textContent = `${ currencyData[0][0].symbol + ' ' + totalAmount.toFixed(2)}`;
            document.getElementById("id_vat_amount").textContent =`${ currencyData[0][0].symbol + ' ' + vatAmount.toFixed(2)}`;
            document.getElementById('id_payable').textContent = `${ currencyData[0][0].symbol + ' ' + payable.toFixed(2)}`;

            updateTfoot(vatAmount, totalAmount, payable)
        }
    }

    function calculateTotalAmount(cart) {
        let total = cart.reduce((total, item) => total + item.price * item.quantity, 0);
        return total.toFixed(2)
    }

    function calculateVAT() {
        let vatTotal = 0;

        cart.forEach(item => {
            vatTotal += (item.tax_amount || 0) * item.quantity;
        });

        return parseFloat(vatTotal.toFixed(2));
    }

    document.querySelector('#id_discount').addEventListener(
        'input', ()=>{
            totals()
        }
    )

    document.querySelector('#id_dc_input').addEventListener(
        'input', ()=>{
            totals()
        }
    )

    function updateCartDisplay() {
        const cartItemsList = document.getElementById("cart_items");
        cartItemsList.innerHTML = ""; 
    
        let total = 0;
        cart.forEach((item) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>
                <small class='d-flex align-items-center'>
                    <small><input class='form-control form-control-sm' type='number' data-id=${item.inventory_id} value='${item.quantity}' oninput='addOrDreceaseQuantity(this);' style='width:4rem;'/></small>
                </small>
            </td>
            <td style='text-align:left !important;'><small>${item.product_name}</small></td>
            <td>
                <small>
                    <input class='form-control form-control-sm' type='number' step='0.01' data-id=${item.id} value='${parseFloat(item.price).toFixed(2)}' oninput='updatePrice(this);' style='width:7rem;'/>
                </small>
            </td>
            <td>
                <small id="total-${item.id}">${currencyData[0][0].symbol + ' ' + (parseInt(item.quantity) * parseFloat(item.price)).toFixed(2)}</small>
                <small class='bx bx-trash-alt text-danger' data-id=${item.id} onclick="removeItem(this);"></small>
            </td>
        `;
        cartItemsList.appendChild(row);
        });

    }

    function updatePrice(input) {
        const itemId = input.getAttribute("data-id");
        const newPrice = parseFloat(input.value);
    
        // Update the cart item's price and total cost dynamically
        const cartItem = cart.find(item => item.id == itemId);
        if (cartItem) {
            cartItem.price = newPrice;
            const totalElement = document.getElementById(`total-${itemId}`);
            totalElement.innerText = currencyData[0][0].symbol + ' ' + (cartItem.quantity * cartItem.price).toFixed(2);
        }
        totals();

        // Recalculate the cart total and update the display
        //updateCartTotal();
        
    
    }

    function updateCartTotal() {
        let total = cart.reduce((acc, item) => acc + (item.quantity * item.price), 0);
        document.getElementById("cart_total").innerText = currencyData[0][0].symbol + ' ' + total.toFixed(2);
    }

    function addOrDreceaseQuantity(sm) {
        const item_id = parseInt(sm.dataset.id);
        const updatedQuantity = parseInt(sm.value);

        if (!updatedQuantity) return;

        const existingItem = cart.find(item => item.inventory_id === item_id);

        if (existingItem) {
            existingItem.quantity = updatedQuantity;
            updateCartDisplay();
            cartButton();
            totals();
        }
        console.log('updated value', cart)
    }

    // update tfoot
    function updateTfoot(vat, totalAmount, payable){
        let totalDueAmount = 0;
        const symbol = currencyData[0][0].symbol;
        
        if(bal>0){
            totalDueAmount = parseFloat(bal.toFixed(2)) + parseFloat(payable.toFixed(2)); 
        }else{
            totalDueAmount = parseFloat(payable.toFixed(2)); 
        }

        const totalBalanceDue = totalDueAmount - parseFloat(amount_paid.toFixed(2));

        //sub = calculateTotalAmount(cart)
        //vatAmount = vat.toFixed(2)

        document.querySelector('#id_subtotal').textContent = `${ symbol + ' ' + calculateTotalAmount(cart) }`
        document.querySelector('#id_vat').textContent = `${ symbol + ' ' + vat.toFixed(2) }`
        // document.querySelector('#id_due_amount').textContent = `${ symbol + ' ' + payable.toFixed(2) }`
        document.querySelector('#id_balance').textContent = `${ symbol + ' ' + totalBalanceDue.toFixed(2) }`, 
        document.querySelector('#total_balance_due').textContent = `${symbol + ' ' + totalDueAmount.toFixed(2) }`

        // updateReceiptFooter(symbol, totalBalanceDue, totalDueAmount, payable)
    }

    function updateReceiptFooter(symbol, totalBalanceDue, totalDueAmount, payable){
        document.querySelector('#rid_due_amount').textContent = `${ symbol + ' ' + payable.toFixed(2) }`
        document.querySelector('#rid_balance').textContent = `${ symbol + ' ' + totalBalanceDue.toFixed(2) }`, 
        document.querySelector('#rtotal_balance_due').textContent = `${symbol + ' ' + totalDueAmount.toFixed(2) }`
    }

    const removeItem = (el) => {
        const id = el.dataset.id
        cart = cart.filter((item) => item.id !== id);
        updateCartDisplay();
        cartButton()
        totals()
    }

    // payment methods
    document.querySelectorAll('.pm').forEach(button => {
        button.addEventListener('click', () => {
            if (button.dataset.name === 'cash') { 
                paymentMethod = button.dataset.name;
            } else if (button.dataset.name === 'ecocash'){
                paymentMethod = button.dataset.name;
            } else if (button.dataset.name === 'bank'){
                paymentMethod = button.dataset.name;
            }else if (button.dataset.name === 'paylater'){
                paymentMethod = button.dataset.name;
            }
        });
    });

    async function processCart(el) {
        const amountReceived = document.getElementById('id_amount_paid');

        if (!holdStatus) {
            if (Number((amountReceived.value) <= 0) && (paymentTerms === 'cash')) {
                Swal.fire({
                    icon: 'error',
                    text: 'Amount canâ€™t be zero when payment method is cash.',
                    title: 'Error'
                }).then(() => {
                    amountReceived.focus()
                });
                return;
            }
        }

        const data = [
            {
                subtotal: calculateTotalAmount(cart),
                currency: currencyData[0][0].id,
                amount_paid: parseFloat(amountReceived.value) || 0.00,
                client_id: clientName,
                payable: payable_amount,
                vat_amount: vat_amount,
                payment_method: paymentMethod,
                recourring: document.getElementById('id_reoccuring').checked,
                paymentTerms: paymentTerms,
                hold_status: holdStatus,
                pay_later_date: document.getElementById('paylater_date').value
            }
        ];

        const url = el.dataset.name === 'qoutation' 
            ? "{% url 'finance:add_qoutation' %}" 
            : "{% url 'finance:create_invoice' %}";

        try {
            // Show loading/processing Swal
            Swal.fire({
                title: 'Processing...',
                text: 'Please wait while we process the invoice.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify({
                    data: data,
                    items: cart,
                    layby_dates: layby_dates
                }),
            });

            const result = await response.json();

            Swal.close(); 

            if (el.dataset.name === 'qoutation') {
                Swal.fire({
                    icon: 'success',
                    text: 'Quotation Processed!',
                    timer: 2000,
                    didClose: () => {
                        Swal.fire({
                            title: 'Redirecting...',
                            text: 'Taking you to the quotation preview.',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });
                        setTimeout(() => {
                            qouteModal.hide();
                            window.location.href = `/finance/qoutation/preview/${result.qoute_id}`;
                        }, 1000);
                    }
                });
            } else {
                
                console.log(result, 'result');

                if (result.success){
                    displayReceipt(result.invoice_data);
                    cart = [];
                    updateCartDisplay();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'No Invoice ID',
                        text: 'Invoice ID not found in the response.'
                    });
                }
                
            }
        } catch (error) {
            Swal.close(); 
            console.error("Error during request:", error);
            Swal.fire({
                icon: 'error',
                title: 'Oops!',
                text: 'Something went wrong while processing your request.',
            });
        }
    }


    function displayReceipt(data) {
        try {
            let content = generateReceiptContent(data);
            printReceiptSilently(content);

            Swal.fire({
                title: 'Printing Receipt...',
                text: 'Please wait while we finish printing.',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                timer: 3000,
                didOpen: () => {
                    Swal.showLoading();
                },
            }).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Done!',
                    text: 'Receipt printed successfully.',
                    confirmButtonText: 'OK'
                }).then(() => {
                    location.reload();
                });
            });

        } catch (error) {
            console.error("Error:", error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to print the receipt. Please try again.'
            });
        }
    }


    function generateReceiptContent(data) {
        const { invoice, invoice_items: invoiceItems } = data;
        const {
            invoice_number: invoiceNumber,
            amount: invoiceTotal,
            vat: vatAmount,
            subtotal: subTotal,
            currency_symbol: currencySymbol,
            receipt_hash: receiptHash,
            amount_paid: amountPaid,
            payment_terms: paymentMethod,
            device_id: deviceId,
            device_serial_number: deviceSerialNumber,
            receipt_signature: receiptSignature,
            qr_code: qrCodeURL,
            branch_name: branchName,
            branch_phone: branchPhone,
            branch_email: branchEmail,
            code: code,
            fiscal_day:fiscal_day
        } = invoice;
    
        const vatRate = 15;
    
        return `
            <style>
                .receipt {
                    font-family: Arial, sans-serif;
                    font-size: 12px;
                    width: 5.8cm;
                    margin: auto;
                    padding: 10px;
                }
                .receipt h2, .footer p, .center {
                    text-align: center;
                }
                .receipt-body table {
                    width: 100%;
                    margin-top: 10px;
                    border-collapse: collapse;
                }
                .receipt-body th, .receipt-body td {
                    padding: 2px;
                    border-bottom: 1px dashed #000;
                }
                .qr-code {
                    text-align: center;
                    margin-top: 10px;
                }
                .footer {
                    font-size: 11px;
                    margin-top: 10px;
                }
            </style>
    
            <div class="receipt">
                <h2>Pasales Investments</h2>
                <p><strong>FISCAL TAX INVOICE</strong></p>
    
                <p><strong>Invoice No:</strong> ${invoiceNumber}</p>
                <p><strong>Branch:</strong> ${branchName || 'Main'}<br>
                <strong>Phone:</strong> ${branchPhone || 'N/A'}<br>
                <strong>Email:</strong> ${branchEmail || 'N/A'}</p>
    
                <p>
                    <strong>Fiscal Day No: ${fiscal_day}</strong><br>
                    <strong>Device ID:</strong> ${deviceId}<br>
                    <strong>Device Serial:</strong> ${deviceSerialNumber}
                </p>
    
                <div class="receipt-body">
                    <table>
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Qty</th>
                                <th>${currencySymbol}Price</th>
                                <th>${currencySymbol}VAT</th>
                                <th>${currencySymbol}Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoiceItems.map(item => {
                                const total = item.unit_price * item.quantity;
                                const vat = total - (total / (1 + vatRate / 100));
                                return `
                                    <tr>
                                        <td>${item.item__name}</td>
                                        <td>${item.quantity}</td>
                                        <td>${currencySymbol}${item.unit_price}</td>
                                        <td>${currencySymbol}${vat.toFixed(2)}</td>
                                        <td>${currencySymbol}${total}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                        <tfoot>
                            <tr><td colspan="4"><strong>Subtotal</strong></td><td>${currencySymbol}${subTotal}</td></tr>
                            <tr><td colspan="4"><strong>VAT (${vatRate}%)</strong></td><td>${currencySymbol}${vatAmount}</td></tr>
                            <tr><td colspan="4"><strong>Total</strong></td><td>${currencySymbol}${invoiceTotal}</td></tr>
                            <tr><td colspan="4"><strong>Amount Paid</strong></td><td>${currencySymbol}${amountPaid}</td></tr>
                            <tr><td colspan="4"><strong>Payment Method</strong></td><td>${paymentMethod || 'Cash'}</td></tr>
                        </tfoot>
                    </table>
                </div>
    
                <div class="qr-code">
                    <img src="${qrCodeURL}" alt="QR Code" width="100" height="100" style="display:block; margin: 0 auto;">
                </div>
                <div class="footer center">
                    <p><strong>Verification Code: <br> </strong> ${code} <br>
                        Verification Url: https://fdmstest.zimra.co.zw/
                    </p>
                    <hr>
                    <p>Thank you for shopping with us</p>
                    <hr>
                </div>
            </div>
        `;
    }
    

    // Function to print the receipt silently
    function printReceiptSilently(content) {
        let printFrame = document.getElementById("print-frame");

        if (!printFrame) {
            printFrame = document.createElement("iframe");
            printFrame.id = "print-frame";
            printFrame.style.position = "absolute";
            printFrame.style.width = "0px";
            printFrame.style.height = "0px";
            printFrame.style.border = "none";
            printFrame.style.visibility = "hidden";
            document.body.appendChild(printFrame);
        }

        const frameDoc = printFrame.contentWindow || 
                        printFrame.contentDocument.document || 
                        printFrame.contentDocument;

        frameDoc.document.open();
        frameDoc.document.write(`
            <html>
            <head>
                <title>Print Receipt</title>
                <style>
                    body { font-family: Arial, sans-serif; font-size: 12px; }
                </style>
            </head>
            <body onload="window.print(); setTimeout(() => window.close(), 1000);">
                ${content}
            </body>
            </html>
        `);
        frameDoc.document.close();
    }

    
    // customer get and post
    function submitClient() {
        const data = {
            name: document.getElementById('id_name').value,
            email: document.getElementById('id_email').value,
            phonenumber: document.getElementById('id_phonenumber').value,
            address: document.getElementById('id_address').value,
        };

        fetch("{% url 'finance:add_customer' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                clientModal.hide();
                Swal.fire({
                icon: 'success',
                title: 'success',
                text: 'Customer Succesfully Added.',
                timer: 2000,
                showConfirmButton: false
                }).then(()=>{
                    customerModal.hide();
                    fetchCustomers();
                })
            } else {
                Swal.fire({
                icon: 'error',
                title: 'error',
                text: data.message,
                timer: 2000,
                showConfirmButton: false
                })
            }
        })
        .catch(error => {
            console.error("Error:", error);
        });
    }
        
    async function fetchCustomers() {
        try {
            const response = await fetch('{% url "finance:customers" %}');

            if (!response.ok) {
                throw new Error('Network response was not ok.');
            }
            const customers = await response.json();

            customersData.push(customers);
            displayCustomers(customers);

        } catch (error) {
            console.error('Error fetching customers:', error);
            productListContainer.innerHTML = '<p class="error-message">Error loading customers. Please try again later.</p>';
        }
    }

    fetchCustomers();

    function displayCustomers(customers) {
        const cusElement = document.querySelector('#search-input');
        
        while (cusElement.options.length > 1) {
            cusElement.remove(1);
        }

        customers.forEach((customer) => {
            const option = document.createElement('option');
            option.value = customer.id;
            option.textContent = customer.name;
            cusElement.appendChild(option);
        });
    }

    async function fetchCustomerAccount(customerId) {
        try {
            const response = await fetch(`/finance/customer/account/json/${customerId}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify({}),
            });

            if (!response.ok) {
                throw new Error('Network response was not ok.');
            }

            const data = await response.json();

            const balanceEl = document.querySelector('#due_balance');
            balanceEl.innerHTML = '';

            const previousDueEl = document.getElementById('previous_due');
            const balance = data.find(item => item.currency__symbol === currencyData[0][0]?.symbol);

            if (balance.balance < 0) {
                bal = Math.abs(balance.balance); 
            } else {
                bal = -Math.abs(balance.balance); 
            }

            previousDue = bal;
            previousDueEl.textContent = balance ? `${balance.currency__symbol} ${bal}` : "0.00";

            data.forEach((balance) => {
                const balanceItem = document.createElement('small');
                balanceItem.id = 'id_due';
                balanceItem.className = 'text-danger';
                balanceItem.textContent = `${balance.currency__symbol} ${balance.balance}`;
                balanceEl.appendChild(balanceItem);
            });
            setCustomer(customerId)
            totals();
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function setCustomer(customerId){
        // customer information
        const company = document.getElementById('customerCompany');
        const name = document.getElementById('customerName');
        const cell = document.getElementById('customerPhone');
        const email = document.getElementById('customerEmail')
        const address = document.getElementById('customerAddress')

        data = customersData[0].filter((cus)=> cus.id == customerId)

        name.textContent = data[0]?.name;
        name.textContent = data[0]?.name;
        cell.textContent = data[0]?.cell;
        email.textContent = data[0]?.email;
        address.textContent = data[0]?.address;
    
        }

        // const getLastInvoiceNumber = async (customerId) => {
        //     try {
        //         const response = await fetch(`/pos/last_due_invoice/${customerId}/`);

        //     if (!response.ok) {
        //         throw new Error('Network response was not ok.');
        //     }
        //     const lastInvoice = await response.json();

        //     // set the last invoice
        //     //document.getElementById('id_last_invoice').textContent = lastInvoice[0].invoice_number;

        //     } catch (error) {
        //         console.error('Error fetching Last Invoice Number:', error);
            
        //     }
        // }

        function customerAccount() {
            $.ajax({
                url: '/finance/customer/payments/json/',
                type: 'GET',
                data: { 'type': 'invoice_payments', 'customer_id': 1 },
            }).done(function (response) {
                const data = response
                //displaypaymentsTable(data)
            })
        }

    
        function displaypaymentsTable(data) {
            //customerAccountTableModal.show()
            customerAccountTable.innerHTML = '';
            data.forEach((d) => {
                customerAccountTable.innerHTML += `
                
                <tr>
                    <td><small class='${d.invoice__payment_status === 'Partial' ? "text-danger" : ''}'>${new Date(d.payment_date).toDateString()}</small></td>
                    <td><small class='${d.invoice__payment_status === 'Partial' ? "text-danger" : ''}'>#${d.invoice__invoice_number}</small></td>
                    <td><small class='${d.invoice__payment_status === 'Partial' ? "text-danger" : ''}'>${d.invoice__products_purchased}</small></td>
                    <td><small class='${d.invoice__payment_status === 'Partial' ? "text-danger" : ''}'>${d.invoice__currency__symbol} ${d.invoice__amount}</small></td>
                    <td><small class='${d.invoice__payment_status === 'Partial' ? "text-danger" : ''}'>${d.invoice__currency__symbol} ${d.amount_paid}</small></td>
                    <td><small class='${d.invoice__payment_status === 'Partial' ? "text-danger" : ''}'>${d.invoice__currency__symbol} ${d.amount_due}</small></td>
                    <td><small class='${d.invoice__payment_status === 'Partial' ? "text-danger" : ''}'>${d.user__username}</small></td>
                </tr>
                `
            })
        }

        const apiUrl =''//update endpoint
            async function fetchCustomerData() {
                try {
                    const response = await fetch(apiUrl);  
                    const customers = await response.json();  

                    if (Array.isArray(customers) && customers.length > 0) {
                        const tableBody = document.getElementById("laybyTableBody");
                        const recordCount = document.getElementById("count");
                        tableBody.innerHTML = '';

                        customers.forEach(customer => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${customer.name}</td>
                                <td>${product}</td>
                                <td>${amount}</td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            Send
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item"  href='https://wa.me/{{customer.account.customer.phone_number}}' class="text-dark">
                                                <i class='bx bxl-whatsapp'></i></a></li>
                                            <li><a class="dropdown-item"  href='mailto:{{customer.account.customer.email}}' class="text-dark">
                                                <i class='bx bx-envelope'></i></a></li>
                                        </ul>
                                    </div>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });

                        // Updating the record count
                        recordCount.innerText = customers.length;
                    } else {
                        alert('No customer data available.');
                    }
                } catch (error) {
                    console.error('Error fetching customer data:', error);
                    alert('Failed to load customer data. Please try again later.');
                }
            }

            document.getElementById('laybyModal').addEventListener('shown.bs.modal', fetchCustomerData);

        
            async function fetchCustomerData() {
                try {
                    const response = await fetch('',{  //update url
                    method: "GET",
                    });
                    const customers = await response.json();  

                    if (Array.isArray(customers) && customers.length > 0) {
                        const tableBody = document.getElementById("PaylaterTableBody");
                        const recordCount = document.getElementById("count");
                        tableBody.innerHTML = '';

                        customers.forEach(customer => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${customer.name}</td>
                                <td>${product}</td>
                                <td>${amount}</td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            Send
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item"  href='https://wa.me/{{customer.account.customer.phone_number}}' class="text-dark">
                                                <i class='bx bxl-whatsapp'></i></a></li>
                                            <li><a class="dropdown-item"  href='mailto:{{customer.account.customer.email}}' class="text-dark">
                                                <i class='bx bx-envelope'></i></a></li>
                                        </ul>
                                    </div>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });

                        recordCount.innerText = customers.length;
                    } else {
                        showError("No customer data available.");
                    }
                } catch (error) {
                    console.log(error)
                }
            }

            document.getElementById('PaylaterModal').addEventListener('shown.bs.modal', fetchCustomerData);
</script>